name: ğŸ¥ Health Monitoring

on:
  schedule:
    # ë§¤ 30ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ì—…ë¬´ì‹œê°„: 9-18ì‹œ KST)
    - cron: '0,30 0-9 * * *'  # UTC ê¸°ì¤€ (KST 9-18ì‹œ)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    paths:
      - 'monitoring/**'
      - '.github/workflows/health-monitoring.yml'

env:
  PYTHON_VERSION: '3.11'

jobs:
  health-check:
    runs-on: ubuntu-latest
    name: ğŸ” Website Health Check
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv
    
    - name: ğŸ” Run health check
      env:
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        TO_EMAIL: ${{ secrets.TO_EMAIL }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        python monitoring/health_checker.py
    
    - name: ğŸ“Š Upload monitoring report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: health-report-${{ github.run_number }}
        path: monitoring/reports/
        retention-days: 30
    
    - name: ğŸ’¬ Notify on failure
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{
          "text": "ğŸš¨ GitHub Actions: Health monitoring workflow failed!",
          "attachments": [{
            "color": "danger",
            "fields": [{
              "title": "Repository", 
              "value": "${{ github.repository }}", 
              "short": true
            }, {
              "title": "Workflow",
              "value": "${{ github.workflow }}",
              "short": true  
            }, {
              "title": "Run ID",
              "value": "${{ github.run_id }}",
              "short": true
            }]
          }]
        }' $SLACK_WEBHOOK_URL

  performance-audit:
    runs-on: ubuntu-latest
    name: âš¡ Performance Audit
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 1 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python  
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: ğŸ” Install Lighthouse
      run: npm install -g lighthouse
    
    - name: âš¡ Run performance audit
      run: |
        python performance_monitor.py
    
    - name: ğŸ“Š Upload performance reports
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports-${{ github.run_number }}
        path: performance_reports/
        retention-days: 90

  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Scan
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 2 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ”’ Run security headers check
      run: |
        curl -s -I https://tests.mahalohana-bruce.com | grep -E "(X-Frame-Options|X-Content-Type-Options|X-XSS-Protection|Strict-Transport-Security|Content-Security-Policy)" || echo "âš ï¸ Some security headers missing"
    
    - name: ğŸ•·ï¸ Check for broken links  
      uses: lycheeverse/lychee-action@v1
      with:
        args: --verbose --no-progress 'https://tests.mahalohana-bruce.com/**/*.html'
        fail: false
    
    - name: ğŸ“Š Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-${{ github.run_number }}
        path: lychee/
        retention-days: 30