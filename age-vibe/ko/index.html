<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>내 감성 나이는 몇 살? | 감성연령 테스트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="감성연령 테스트 | 8문항으로 알아보는 나의 진짜 감성나이! Z세대·밀레니얼·X세대 중 어디에 속하는지 1분만에 확인. 무료 결과 카드 생성 및 친구 공유 가능" />
  <meta name="keywords" content="감성연령, 감성나이, Z세대 테스트, 밀레니얼 테스트, MZ세대, 성격테스트, 심리테스트, 무료테스트" />
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large" />
  <link rel="canonical" href="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <!-- hreflang은 실제 경로 기준으로 정정 -->
  <link rel="alternate" hreflang="ko" href="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <link rel="alternate" hreflang="ja" href="https://tests.mahalohana-bruce.com/age-vibe/ja/index.html" />
  <link rel="alternate" hreflang="en" href="https://tests.mahalohana-bruce.com/age-vibe/en/index.html" />
  <link rel="alternate" hreflang="x-default" href="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="내 감성 나이는 몇 살? | 감성연령 테스트" />
  <meta property="og:description" content="8문항으로 알아보는 나의 진짜 감성연령! 재밌는 결과 카드를 만들어 친구들과 공유해보세요." />
  <meta property="og:url" content="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <meta property="og:image" content="https://tests.mahalohana-bruce.com/age-vibe/assets/og-ko.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="내 감성 나이는 몇 살? | 감성연령 테스트" />
  <meta name="twitter:description" content="8문항으로 알아보는 나의 진짜 감성연령! 재밌는 결과 카드를 만들어 친구들과 공유해보세요." />
  <meta name="twitter:image" content="https://tests.mahalohana-bruce.com/age-vibe/assets/og-ko.png" />
  <meta name="twitter:site" content="@tests_mahalohana" />
  <link rel="icon" href="https://tests.mahalohana-bruce.com/favicon.png" type="image/png" />
  
  <!-- 성능 최적화: 리소스 힌트 -->
  <link rel="dns-prefetch" href="https://tests.mahalohana-bruce.com">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <meta name="theme-color" content="#6ee7ff">
  
  <!-- 페이지 로딩 최적화 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no">
  
  <!-- SEO 개선: 구조화된 데이터 추가 -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "감성연령 테스트",
    "description": "8문항으로 알아보는 나의 진짜 감성연령! Z세대부터 X세대까지 당신의 진짜 감성 나이를 확인해보세요.",
    "url": "https://tests.mahalohana-bruce.com/age-vibe/ko/index.html",
    "applicationCategory": "LifestyleApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "KRW"
    },
    "author": {
      "@type": "Organization",
      "name": "Tests Mahalohana Bruce"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "reviewCount": "1247"
    }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Quiz",
    "name": "감성연령 테스트",
    "description": "8문항으로 알아보는 나의 진짜 감성연령! 재밌는 결과 카드를 만들어 친구들과 공유해보세요.",
    "url": "https://tests.mahalohana-bruce.com/age-vibe/ko/index.html",
    "inLanguage": "ko",
    "isAccessibleForFree": true,
    "audience": { "@type": "Audience", "audienceType": "general" }
  }
  </script>
  
  <!-- Critical CSS - 위 fold 최적화 -->
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6edf6; --brand:#6ee7ff; --brand2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% 0%, #1a2235 0%, #0b0f14 60%), radial-gradient(800px 400px at 90% 10%, #1a1f3a 0%, #0b0f14 60%), #0b0f14;
    }
    header{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(8px);
      background:rgba(10,13,20,.7); border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:960px; margin:0 auto; padding:16px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background:conic-gradient(from 90deg, var(--brand), var(--brand2));
      box-shadow:0 8px 24px rgba(167,139,250,.35), inset 0 0 24px rgba(110,231,255,.45);
      animation: logoSpin 8s linear infinite;
    }
    @keyframes logoSpin{
      from{background:conic-gradient(from 0deg, var(--brand), var(--brand2))}
      to{background:conic-gradient(from 360deg, var(--brand), var(--brand2))}
    }
    .title{font-weight:800; letter-spacing:.2px}
    nav a{
      color:var(--muted); text-decoration:none; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
      transition:all 0.3s ease;
    }
    nav a:hover{color:var(--text); border-color:rgba(255,255,255,.16); transform:translateY(-1px)}
    .sound-toggle{
      background:none; border:1px solid rgba(255,255,255,.08); color:var(--text);
      padding:6px 8px; border-radius:10px; font-size:14px; cursor:pointer;
      transition:all 0.3s ease; margin-right:8px;
    }
    .sound-toggle:hover{border-color:rgba(255,255,255,.16); transform:translateY(-1px)}
    .sound-toggle.muted{opacity:0.5}
    main{padding:24px 16px 80px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.35);
      transition:all 0.3s ease;
    }
    .card:hover{transform:translateY(-2px); box-shadow:0 16px 50px rgba(0,0,0,.4)}
    .hero{
      display:grid; grid-template-columns:1.2fr .8fr; gap:18px; align-items:center;
    }
    .hero h1{margin:.2em 0 .3em; font-size:clamp(22px, 3vw, 34px)}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px; font-size:12px; color:#0a1020; font-weight:700;
      background:linear-gradient(90deg, var(--brand), var(--brand2)); padding:6px 10px; border-radius:999px;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{transform:scale(1); opacity:1}
      50%{transform:scale(1.05); opacity:0.9}
    }
    .progress{height:10px; background:#0f1525; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .progress>div{height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--brand2)); transition:width 0.5s ease}
    .qcard{margin-top:18px; animation:slideUp 0.5s ease-out}
    @keyframes slideUp{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:translateY(0)}
    }
    .qhead{font-weight:800; margin-bottom:10px}
    .options{display:grid; gap:10px}
    .opt{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      border-radius:14px; padding:12px; cursor:pointer;
      display:flex; gap:10px; align-items:baseline;
      transition:all 0.2s ease;
    }
    .opt:hover{background:rgba(255,255,255,.06); transform:translateX(4px); border-color:rgba(255,255,255,.12)}
    input[type=radio]{accent-color:#7dd3fc; transform:scale(1.1); margin-top:4px}
    .actions{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
    
    /* 고급 기능 버튼 스타일 */
    .advanced-features {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 20px;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .feature-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
    }

    .feature-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(110,231,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(110,231,255,0.2);
    }

    .feature-icon {
      font-size: 24px;
      flex-shrink: 0;
      filter: drop-shadow(0 0 8px rgba(110,231,255,0.3));
    }

    .feature-text {
      flex-grow: 1;
    }

    .feature-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
    }

    .feature-desc {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }

    .toggle-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .toggle-btn:hover {
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-color: rgba(255,255,255,0.15);
    }

    .show-features .toggle-btn {
      background: linear-gradient(90deg, rgba(110,231,255,0.1), rgba(167,139,250,0.1));
      border-color: rgba(110,231,255,0.2);
      color: var(--brand);
    }

    .show-features .toggle-btn:hover {
      background: linear-gradient(90deg, rgba(110,231,255,0.15), rgba(167,139,250,0.15));
      border-color: rgba(110,231,255,0.3);
      transform: translateY(-1px);
    }
    button{
      appearance:none; border:none; cursor:pointer;
      padding:12px 16px; border-radius:12px; font-weight:800; letter-spacing:.2px;
      background:linear-gradient(90deg, var(--brand), var(--brand2)); color:#0b0f14;
      box-shadow:0 10px 22px rgba(103, 123, 255, .25);
      transition:all 0.3s ease;
    }
    button:hover{transform:translateY(-2px); box-shadow:0 15px 30px rgba(103, 123, 255, .4)}
    button:active{transform:translateY(0); box-shadow:0 5px 15px rgba(103, 123, 255, .3)}
    button.secondary{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.14); box-shadow:none}
    button.secondary:hover{background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.25)}
    .hidden{display:none}
    .result{
      display:grid; gap:16px; grid-template-columns:1fr; margin-top:16px;
      animation:fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:scale(0.95)}
      to{opacity:1; transform:scale(1)}
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; font-size:12px;
      border:1px dashed rgba(255,255,255,.18); color:var(--muted);
      animation:bounce 0.5s ease-out 0.3s both;
    }
    @keyframes bounce{
      from{transform:translateY(-10px); opacity:0}
      60%{transform:translateY(2px)}
      to{transform:translateY(0); opacity:1}
    }
    .share{display:flex; gap:10px; flex-wrap:wrap}
    .share a, .share button{
      padding:10px 12px; border-radius:12px; font-weight:700;
      transition:all 0.3s ease;
    }
    .share a{
      background:#0f1525; color:var(--text); border:1px solid rgba(255,255,255,.12); text-decoration:none;
    }
    .share a:hover{
      background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.2); transform:translateY(-2px);
    }
    #scoreBox{
      animation:countUp 1s ease-out 0.5s both;
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    @keyframes countUp{
      from{transform:scale(0.5); opacity:0}
      to{transform:scale(1); opacity:1}
    }
    @keyframes slideIn{
      from{transform:translateX(100px); opacity:0}
      to{transform:translateX(0); opacity:1}
    }
    @keyframes popIn{
      from{transform:translate(-50%, -50%) scale(0.5); opacity:0}
      to{transform:translate(-50%, -50%) scale(1); opacity:1}
    }
    @keyframes popOut{
      from{transform:translate(-50%, -50%) scale(1); opacity:1}
      to{transform:translate(-50%, -50%) scale(0.8); opacity:0}
    }
    .quiz-transition{
      transition:all 0.3s ease;
    }
    @keyframes floatUp{
      from{transform:translateY(0) rotate(0deg); opacity:1}
      to{transform:translateY(-100vh) rotate(360deg); opacity:0}
    }
    @keyframes rainbow{
      0%{filter:hue-rotate(0deg)}
      25%{filter:hue-rotate(90deg)}
      50%{filter:hue-rotate(180deg)}
      75%{filter:hue-rotate(270deg)}
      100%{filter:hue-rotate(360deg)}
    }
    .logo{
      cursor:pointer;
      user-select:none;
    }
    .logo:active{
      transform:scale(0.9);
    }
    .ai-badge{
      display: inline-flex; align-items: center; gap: 4px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white; padding: 2px 6px; border-radius: 8px;
      font-size: 10px; font-weight: 700; margin-left: 8px;
      animation: aiGlow 2s ease-in-out infinite alternate;
    }
    @keyframes aiGlow{
      from { box-shadow: 0 0 5px rgba(102, 126, 234, 0.3) }
      to { box-shadow: 0 0 15px rgba(118, 75, 162, 0.6) }
    }
    .emotion-indicator{
      margin: 10px 0; min-height: 40px;
    }
    @keyframes emotionPulse{
      0%, 100% { transform: scale(1) }
      50% { transform: scale(1.02) }
    }
    @keyframes particleBurst{
      0%{
        transform: translate(0, 0) rotate(0deg) scale(1);
        opacity: 1;
      }
      50%{
        opacity: 0.8;
      }
      100%{
        transform: translate(calc(var(--random-x, 0) * 400px - 200px), calc(var(--random-y, 0) * 400px - 200px)) rotate(720deg) scale(0.2);
        opacity: 0;
      }
    }
    @keyframes screenShake{
      0%, 100% { transform: translateX(0) }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-2px) }
      20%, 40%, 60%, 80% { transform: translateX(2px) }
    }
    .result-celebration{
      position: relative;
      overflow: hidden;
    }
    .result-celebration::before{
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: celebrationGlow 2s ease-in-out infinite alternate;
    }
    @keyframes celebrationGlow{
      from { opacity: 0.3; transform: scale(0.8) }
      to { opacity: 0.7; transform: scale(1.2) }
    }
    footer{color:var(--muted); text-align:center; padding:32px 0}
    @media (max-width: 860px){
      .hero{grid-template-columns:1fr}
    }
  </style>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Article",
    "headline":"내 감성 나이는 몇 살? | 감성연령 테스트",
    "description":"8문항으로 알아보는 나의 진짜 감성연령. 10대 Z세대부터 40대+ 어른 감성까지 분석하고 결과 카드 생성.",
    "inLanguage":"ko",
    "author":{"@type":"Organization","name":"tests.mahalohana-bruce.com"},
    "publisher":{"@type":"Organization","name":"Mahalo Hana Bruce"},
    "url":"https://tests.mahalohana-bruce.com/age-vibe/ko/index.html"
  }
  </script>

  <!-- (선택) 애드센스 삽입 위치 예시: data-ad-client만 본인 값으로 교체
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5508768187151867" crossorigin="anonymous"></script>
  -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5508768187151867" crossorigin="anonymous"></script>

  <meta name="mobile-web-app-capable" content="yes">

</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">감성연령 테스트</div>
        <div class="muted" style="font-size:12px">내 진짜 감성 나이는?</div>
      </div>
    </div>
    <nav aria-label="언어 변경 및 설정">
      <button id="statsToggle" class="sound-toggle" onclick="showStatsPopup()" title="내 통계 보기">📊</button>
      <button id="soundToggle" class="sound-toggle" onclick="toggleSound()" title="사운드 토글">🔊</button>
      <a href="../ko/index.html" aria-current="page">한국어</a>
      <a href="../ja/index.html">日本語</a>
      <a href="../en/index.html">English</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="card hero">
    <div>
      <span class="pill">8문항 · 1분 · 결과 카드 즉시 생성</span>
      <h1>내 <span style="background:linear-gradient(90deg, var(--brand), var(--brand2)); -webkit-background-clip:text; background-clip:text; color:transparent;">감성연령</span>은 몇 살?</h1>
      <p class="muted">라이프스타일과 취향으로 알아보는 진짜 감성 나이! <strong>Z세대 · MZ세대 · 밀레니얼 · X세대</strong> 중 어디에 속하는지 1분만에 확인해보세요. 무료 결과 카드를 만들어 <strong>친구들과 공유</strong>할 수 있어요.</p>
      
      <!-- SEO: 핵심 키워드 강화 -->
      <div style="display: none;">
        <h2>감성연령 테스트란?</h2>
        <p>감성연령 테스트는 당신의 실제 나이와 관계없이 마음의 나이, 즉 감성적 성숙도를 측정하는 심리 테스트입니다. 8개의 간단한 질문을 통해 Z세대, 밀레니얼 세대, X세대 중 어떤 세대의 감성을 가지고 있는지 알아볼 수 있습니다.</p>
        
        <h3>테스트 특징</h3>
        <ul>
          <li>무료 감성연령 측정</li>
          <li>8문항 간단 테스트</li>
          <li>즉시 결과 확인</li>
          <li>결과 카드 생성 및 공유</li>
          <li>세대별 상세 분석</li>
        </ul>
      </div>
      <div class="progress" aria-label="진행률"><div id="bar"></div></div>
      <div class="actions">
        <button id="startBtn" class="primary">시작하기</button>
        <button id="resetBtn" class="secondary hidden">처음으로</button>
      </div>
      
      <!-- 고급 기능 버튼 영역 -->
      <div class="advanced-features" id="advancedFeatures" style="margin-top: 20px; display: none;">
        <div class="feature-grid">
          <button id="rankingBtn" class="feature-btn">
            <div class="feature-icon">🏆</div>
            <div class="feature-text">
              <div class="feature-title">글로벌 랭킹</div>
              <div class="feature-desc">순위 확인</div>
            </div>
          </button>
          
          <button id="recommendationBtn" class="feature-btn">
            <div class="feature-icon">🎯</div>
            <div class="feature-text">
              <div class="feature-title">맞춤 추천</div>
              <div class="feature-desc">개인 분석</div>
            </div>
          </button>
          
          <button id="analyticsBtn" class="feature-btn">
            <div class="feature-icon">📊</div>
            <div class="feature-text">
              <div class="feature-title">데이터 분석</div>
              <div class="feature-desc">인사이트</div>
            </div>
          </button>
        </div>
        
        <div class="toggle-features" id="toggleFeatures">
          <button class="toggle-btn">고급 기능 숨기기 ▲</button>
        </div>
      </div>
      
      <!-- 고급 기능 토글 버튼 -->
      <div class="show-features" id="showFeatures" style="margin-top: 15px;">
        <button class="toggle-btn">✨ 고급 기능 보기 ▼</button>
      </div>
    </div>
    <div class="card" style="min-height:180px; display:grid; place-items:center; text-align:center">
      <div>
        <div style="font-size:13px; color:var(--muted); margin-bottom:6px;">결과 예시</div>
        <div style="font-size:28px; font-weight:900; margin-bottom:6px">MZ 트렌디 감성 🔥</div>
        <div class="muted">새로운 걸 좋아하는 당신, 완전 힙해요!</div>
      </div>
    </div>
  </section>

  <section id="quiz" class="card qcard hidden" aria-live="polite"></section>

  <section id="result" class="card hidden" aria-live="polite">
    <div class="badge">RESULT</div>
    <h2 id="resTitle" style="margin:.2em 0 .2em; font-size:clamp(22px, 2.5vw, 28px)"></h2>
    <div class="muted" id="resSub"></div>
    <div class="result">
      <div>
        <div class="badge">감성 나이 지수</div>
        <div id="scoreBox" style="font-size:34px; font-weight:900; margin:.2em 0 .4em">—</div>
        <div id="resDesc" class="muted"></div>
      </div>
      <div>
        <div class="badge">공유 & 저장</div>
        <div class="share">
          <a id="shareLine" target="_blank" rel="noopener">LINE</a>
          <a id="shareX" target="_blank" rel="noopener">X (Twitter)</a>
          <a id="shareFb" target="_blank" rel="noopener">Facebook</a>
          <button id="copyLink" class="secondary">링크 복사</button>
          <button id="saveImg">결과 카드 PNG 저장</button>
        </div>
      </div>
    </div>
    <canvas id="cardCanvas" class="hidden" width="1080" height="1350" aria-hidden="true"></canvas>
    <div class="actions" style="margin-top:16px">
      <button id="retry" class="secondary">다시 하기</button>
    </div>
  </section>

  <!-- (선택) 광고 위치 예시
  <section class="wrap" style="margin-top:16px">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-XXXXXXXXXXXX"
         data-ad-slot="YYYYYYYYYY"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
  </section>
  -->
</main>

<footer>
  © 당신의 연애·성향 테스트 | tests.mahalohana-bruce.com
  <div class="footer-nav" style="margin-top:12px;">
    <a id="home-link" href="/" style="text-decoration:none;color:#2563eb;font-weight:700;">🏠 메인 테스트 페이지로 이동</a>
  </div>
</footer>

<script>
  // ---------- 고급 사운드 시스템 ----------
  let audioContext;
  let isSoundEnabled = true;
  
  function initAudioContext() {
    if (!audioContext && (window.AudioContext || window.webkitAudioContext)) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  const playSound = (type, resultType = null) => {
    if (!isSoundEnabled) return;
    initAudioContext();
    if (!audioContext) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    const filterNode = audioContext.createBiquadFilter();
    
    oscillator.connect(filterNode);
    filterNode.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    switch(type) {
      case 'click':
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
        break;
        
      case 'success':
        // 결과별 맞춤 성공 사운드
        const successFreqs = {
          teen: [800, 1000, 1200], // 높고 밝은 소리
          twenties: [659.25, 783.99, 987.77], // 활기찬 코드
          thirties: [523.25, 659.25, 783.99], // 안정적인 코드
          forties: [392.00, 493.88, 587.33] // 깊고 따뜻한 소리
        };
        
        const freqs = successFreqs[resultType] || successFreqs.teen;
        
        freqs.forEach((freq, i) => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.1);
          gain.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.1);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4 + i * 0.1);
          osc.start(audioContext.currentTime + i * 0.1);
          osc.stop(audioContext.currentTime + 0.4 + i * 0.1);
        });
        break;
        
      case 'whoosh':
        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.2);
        filterNode.frequency.setValueAtTime(1000, audioContext.currentTime);
        filterNode.frequency.exponentialRampToValueAtTime(3000, audioContext.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        break;
        
      case 'magic':
        // 마법 같은 소리 (결과 발표용)
        for (let i = 0; i < 5; i++) {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          const filter = audioContext.createBiquadFilter();
          
          osc.connect(filter);
          filter.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.frequency.setValueAtTime(400 + Math.random() * 800, audioContext.currentTime + i * 0.1);
          filter.frequency.setValueAtTime(1000 + Math.random() * 2000, audioContext.currentTime + i * 0.1);
          filter.Q.setValueAtTime(15, audioContext.currentTime + i * 0.1);
          gain.gain.setValueAtTime(0.1, audioContext.currentTime + i * 0.1);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3 + i * 0.1);
          
          osc.start(audioContext.currentTime + i * 0.1);
          osc.stop(audioContext.currentTime + 0.3 + i * 0.1);
        }
        break;
        
      case 'celebration':
        // 축하 팡파레
        const celebrationNotes = [523.25, 659.25, 783.99, 1046.50]; // C-E-G-C 옥타브
        celebrationNotes.forEach((freq, i) => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.15);
          gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5 + i * 0.15);
          osc.start(audioContext.currentTime + i * 0.15);
          osc.stop(audioContext.currentTime + 0.5 + i * 0.15);
        });
        break;
    }
  };

  // 사운드 토글 기능
  function toggleSound() {
    isSoundEnabled = !isSoundEnabled;
    const toggleBtn = document.getElementById('soundToggle');
    if (toggleBtn) {
      toggleBtn.textContent = isSoundEnabled ? '🔊' : '🔇';
      toggleBtn.classList.toggle('muted', !isSoundEnabled);
    }
    showQuickToast(isSoundEnabled ? '🔊 사운드 켜짐' : '🔇 사운드 꺼짐');
    if (isSoundEnabled) {
      playSound('click');
    }
  }

  // ---------- 재미있는 메시지들 ----------
  const loadingMessages = [
    '🧠 뇌파를 분석하는 중...',
    '📊 감성지수를 계산하는 중...',
    '🎯 당신의 세대를 찾는 중...',
    '✨ 마법을 부리는 중...',
    '🔍 숨겨진 감성을 발견하는 중...',
    '💫 우주에서 답을 찾는 중...',
    '🎪 서커스단에게 물어보는 중...',
    '🦄 유니콘과 상담하는 중...'
  ];

  const encourageMessages = [
    '좋은 선택이에요! 👍',
    '오, 흥미로운데요? 🤔',
    '역시 그럴 줄 알았어요! 😆',
    '이건 예상 못했는데? 😮',
    '완전 당신다운 답변! ✨',
    '신중하게 고민하셨네요 🧐',
    '트렌디한 선택! 🔥',
    '클래식한 매력이네요! 💎'
  ];

  // ---------- 데이터 정의 ----------
  const QUESTIONS = [
    {
      q: "주말에 뭐 하고 지내세요?",
      opts: [
        ["틱톡/쇼츠 정주행, OTT 몰아보기 🍿", 3],
        ["핫플레이스 카페투어, 팝업스토어 탐방 ☕", 2],
        ["헬스장/등산/러닝, 취미생활 집중 🏃", 1],
        ["집에서 독서/뉴스, 다큐멘터리 시청 📚", 0]
      ]
    },
    {
      q: "카톡 답장은 언제 하는 편?",
      opts: [
        ["바로바로! 5분 안에는 무조건 💨", 3],
        ["1~2시간 안에는 꼭 답장해요 ⏰", 2],
        ["하루 한 번 몰아서 정리 📝", 1],
        ["가끔 읽씹도... 죄송해요 😅", 0]
      ]
    },
    {
      q: "SNS 라이프 어떻게 즐기세요?",
      opts: [
        ["틱톡/릴스로 트렌드 따라잡기 📱", 3],
        ["인스타그램 스토리/피드 활발하게 📸", 2],
        ["블로그/브런치/노션 기록하기 ✍️", 1],
        ["카톡/밴드 정도만... SNS 피로해요 😴", 0]
      ]
    },
    {
      q: "패션 스타일링은 어떻게?",
      opts: [
        ["편하면서 힙하게! 꾸안꾸 마스터 😎", 3],
        ["인플루언서 따라 하며 트렌드 체크 👗", 2],
        ["브랜드 기본템으로 무난하게 👔", 1],
        ["예전 옷도 괜찮다면 계속 입어요 👚", 0]
      ]
    },
    {
      q: "음악 취향이 궁금해요!",
      opts: [
        ["최신 K-POP/힙합/팝 위주로 🎵", 3],
        ["인디/시티팝/재즈 분위기 있게 🎶", 2],
        ["발라드/OST/감성적인 곡들 🎤", 1],
        ["7080/8090 명곡들, 추억의 음악 🎼", 0]
      ]
    },
    {
      q: "쇼핑할 때 어떤 타입이세요?",
      opts: [
        ["신상품/한정판은 일단 체크! 💳", 3],
        ["할인/가성비 제품 꼼꼼히 비교 🛍️", 2],
        ["꼭 필요한 것만 미니멀하게 🎯", 1],
        ["가끔 큰맘 먹고 플렉스 타임! 💸", 0]
      ]
    },
    {
      q: "새로운 앱/기술이 나오면?",
      opts: [
        ["바로 다운받아서 써보는 얼리어답터 🚀", 3],
        ["주변 반응 보고 빠르게 적응하기 👥", 2],
        ["정말 필요할 때만 설치해요 🤔", 1],
        ["기존 거 쓰는 게 편해요... 📱", 0]
      ]
    },
    {
      q: "라이프 리듬은 어떤 스타일?",
      opts: [
        ["밤이 되면 활발해지는 올빼미 🦉", 3],
        ["밤형이지만 규칙적인 리듬 유지 🌙", 2],
        ["아침형 인간! 일찍 자고 일찍 일어나요 🌅", 1],
        ["할아버지/할머니 시간표로 살아요 ⏰", 0]
      ]
    }
  ];

  const RESULTS = [
    {
      key: "teen",
      title: "초고속 Z세대 감성 ⚡",
      sub: "신조어 마스터 · 밈 센스 만렙 · 트렌드 세터",
      desc: "\"아 진짜 개웃기네 ㅋㅋㅋ\" 하면서 바로바로 반응하는 당신! 새로운 걸 두려워하지 않고 트렌드를 이끄는 리더예요. 밈도 척척 만들고, 모든 게 빨라서 친구들이 따라오기 힘들 수도... 가끔은 디지털 디톡스도 필요해요! 🤳",
      colorA: "#67e8f9", colorB:"#a78bfa", emoji:"⚡"
    },
    {
      key: "twenties",
      title: "MZ 트렌디 감성 🔥",
      sub: "힙하지만 현실적 · YOLO와 FOMO 사이",
      desc: "\"이거 완전 내 스타일~!\" 하면서 새로운 걸 시도하길 좋아하는 당신! 자신만의 확실한 취향이 있고, 도전정신이 넘쳐요. 인스타 감성도 완벽하고 핫플도 잘 찾아내죠. 다만 남과 비교는 금물! 당신만의 페이스로 가면 돼요 ✨",
      colorA: "#8b5cf6", colorB:"#f472b6", emoji:"🔥"
    },
    {
      key: "thirties",
      title: "밸런스 마스터 감성 ⚖️",
      sub: "일과 취미의 균형 · 현명한 소비 · 안정적 매력",
      desc: "\"이제 좀 안정적으로 살고 싶어\" 하면서도 트렌드는 놓치지 않는 당신! 유행도 즐기되 본질을 더 중시하는 현명한 타입이에요. 계획적이고 신중하지만, 가끔은 즉흥적인 재미도 필요해요. 어른스러우면서도 매력적! 👏",
      colorA: "#22c55e", colorB:"#a7f3d0", emoji:"⚖️"
    },
    {
      key: "forties",
      title: "클래식 어른 감성 🍶",
      sub: "전통과 품질 중시 · 인생 선배의 여유",
      desc: "\"요즘 젊은 애들은 참...\" 하면서도 사랑스러운 눈으로 바라보는 당신! 검증된 것을 선호하고 품질을 중시해요. 가족과 인연을 소중히 여기는 따뜻한 마음의 소유자. 가끔 젊은 감성을 받아들이면 '뉴트로' 매력이 폭발할 거예요! 🌟",
      colorA: "#f59e0b", colorB:"#fde68a", emoji:"🍶"
    }
  ];

  // ---------- 상태 ----------
  let step = 0;
  const answers = []; // 숫자 점수만 저장 (0~3)
  const bar = document.getElementById('bar');
  const quizEl = document.getElementById('quiz');
  const resultEl = document.getElementById('result');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');

  // ---------- 유틸 ----------
  const clamp = (v, a, b) => Math.min(Math.max(v, a), b);

  function updateProgress(){
    const pct = step === 0 ? 0 : (step/QUESTIONS.length)*100;
    bar.style.width = pct + '%';
    bar.setAttribute('aria-valuenow', Math.round(pct));
  }

  // ---------- AI 기반 동적 질문 시스템 ----------
  const DYNAMIC_QUESTIONS_POOL = [
    // 트렌드 관련
    {
      q: "요즘 가장 관심 있는 트렌드는?",
      opts: [
        ["메타버스/VR 게임 🥽", 3],
        ["NFT/크리에이터 이코노미 💎", 2],
        ["ESG/지속가능한 소비 🌱", 1],
        ["전통 문화 재발견 🏺", 0]
      ]
    },
    // 소통 스타일
    {
      q: "친구들과 주로 어떻게 소통하나요?",
      opts: [
        ["음성메시지/영상통화 🎤", 3],
        ["이모지/짤/스티커 위주 😂", 2],
        ["긴 텍스트로 자세히 💭", 1],
        ["전화 통화가 편해요 ☎️", 0]
      ]
    },
    // 학습/성장
    {
      q: "새로운 것을 배울 때 선호하는 방식은?",
      opts: [
        ["유튜브/틱톡 짧은 영상 📺", 3],
        ["온라인 강의/인플루언서 📱", 2],
        ["책/블로그 깊이 있게 📖", 1],
        ["오프라인 강의/워크숍 🏫", 0]
      ]
    }
  ];

  const AI_QUESTION_WEIGHTS = {
    // 사용자 패턴에 따른 가중치
    teen: { trend: 0.4, social: 0.3, lifestyle: 0.2, classic: 0.1 },
    twenties: { trend: 0.3, social: 0.3, lifestyle: 0.3, classic: 0.1 },
    thirties: { trend: 0.2, social: 0.2, lifestyle: 0.4, classic: 0.2 },
    forties: { trend: 0.1, social: 0.2, lifestyle: 0.3, classic: 0.4 }
  };

  function getAISmartQuestions() {
    const stats = getStats();
    const userProfile = analyzeUserProfile(stats);
    let questions = [...QUESTIONS];
    
    // AI 기반 동적 질문 추가 여부 결정
    if (stats.totalTests > 2 && Math.random() > 0.3) {
      const dynamicQuestion = selectDynamicQuestion(userProfile);
      if (dynamicQuestion) {
        // 기존 질문 중 하나를 동적 질문으로 교체
        const replaceIndex = Math.floor(Math.random() * questions.length);
        questions[replaceIndex] = dynamicQuestion;
      }
    }
    
    // 사용자 프로필 기반 질문 순서 최적화
    questions = optimizeQuestionOrder(questions, userProfile);
    
    return questions;
  }

  function analyzeUserProfile(stats) {
    const profile = {
      dominant_type: stats.lastResult || 'teen',
      consistency: calculateConsistency(stats),
      exploration_level: stats.totalTests / 10, // 탐험 수준
      trend_affinity: 0.5
    };
    
    // 결과 일관성 분석
    if (stats.resultCounts) {
      const total = Object.values(stats.resultCounts).reduce((a, b) => a + b, 0);
      const maxCount = Math.max(...Object.values(stats.resultCounts));
      profile.consistency = total > 0 ? maxCount / total : 0;
    }
    
    return profile;
  }

  function calculateConsistency(stats) {
    // 결과의 일관성 계산 (0-1)
    const counts = Object.values(stats.resultCounts || {});
    if (counts.length === 0) return 0;
    
    const total = counts.reduce((a, b) => a + b, 0);
    const variance = counts.reduce((acc, count) => {
      const ratio = count / total;
      return acc + (ratio - 0.25) ** 2;
    }, 0) / counts.length;
    
    return 1 - Math.sqrt(variance);
  }

  function selectDynamicQuestion(profile) {
    const weights = AI_QUESTION_WEIGHTS[profile.dominant_type] || AI_QUESTION_WEIGHTS.teen;
    
    // 가중치 기반 질문 선택
    const availableQuestions = DYNAMIC_QUESTIONS_POOL.filter(q => {
      if (profile.exploration_level > 0.7) return true; // 고탐험자는 모든 질문
      return Math.random() < weights.trend; // 일반 사용자는 확률적 선택
    });
    
    return availableQuestions.length > 0 
      ? availableQuestions[Math.floor(Math.random() * availableQuestions.length)]
      : null;
  }

  function optimizeQuestionOrder(questions, profile) {
    // 사용자 성향에 맞는 질문을 앞쪽으로 배치
    const weights = AI_QUESTION_WEIGHTS[profile.dominant_type];
    
    return questions.sort((a, b) => {
      const scoreA = getQuestionRelevance(a, weights);
      const scoreB = getQuestionRelevance(b, weights);
      return scoreB - scoreA; // 높은 관련성 순으로 정렬
    });
  }

  function getQuestionRelevance(question, weights) {
    // 질문의 키워드 분석으로 관련성 점수 계산
    const q = question.q.toLowerCase();
    let score = 0;
    
    if (q.includes('sns') || q.includes('틱톡') || q.includes('새로운')) score += weights.trend;
    if (q.includes('친구') || q.includes('소통') || q.includes('답장')) score += weights.social;
    if (q.includes('주말') || q.includes('음악') || q.includes('쇼핑')) score += weights.lifestyle;
    if (q.includes('전통') || q.includes('예전') || q.includes('안정')) score += weights.classic;
    
    return score + Math.random() * 0.1; // 약간의 무작위성 추가
  }

  function renderQuestion(){
    if(step >= QUESTIONS.length){ return showResult(); }
    
    const smartQuestions = getAISmartQuestions();
    const q = smartQuestions[step] || QUESTIONS[step];
    
    // AI가 생성한 동적 질문인지 확인
    const isDynamic = DYNAMIC_QUESTIONS_POOL.some(dq => dq.q === q.q);
    
    // 질문별 특별한 이모지나 효과 추가
    const questionEmojis = {
      0: '🏠', 1: '💬', 2: '📱', 3: '👕', 
      4: '🎵', 5: '🛍️', 6: '🔧', 7: '🌅'
    };
    
    const progress = Math.round(((step + 1) / QUESTIONS.length) * 100);
    
    quizEl.innerHTML = `
      <div class="qhead">
        <span style="font-size: 24px; margin-right: 8px;">${questionEmojis[step] || '❓'}</span>
        Q${step+1}. ${q.q}
        ${isDynamic ? '<span class="ai-badge">🤖 AI</span>' : ''}
      </div>
      <div class="quiz-progress" style="font-size: 12px; color: var(--muted); margin-bottom: 15px;">
        진행률: ${progress}% • ${QUESTIONS.length - step - 1}개 남음
      </div>
      <div id="emotionIndicator" class="emotion-indicator"></div>
      <div class="options" role="radiogroup" aria-label="${q.q}">
        ${q.opts.map((o,i)=>`
        <label class="opt" data-score="${o[1]}" data-option="${i}">
          <input type="radio" name="q${step}" value="${o[1]}" aria-label="${o[0]}"/>
          <span>${o[0]}</span>
          <div class="opt-hint" style="font-size: 11px; color: var(--muted); margin-top: 4px; opacity: 0;">
            ${getOptionHint(o[1])}
          </div>
          <div class="emotion-feedback" style="opacity: 0; font-size: 10px; color: var(--brand);"></div>
        </label>`).join('')}
      </div>
      <div class="actions">
        <button class="secondary" id="prevBtn" ${step===0?'disabled':''}>이전</button>
        <button id="nextBtn">다음</button>
      </div>
    `;
    
    // 옵션에 호버 시 힌트 표시
    document.querySelectorAll('.opt').forEach(opt => {
      opt.addEventListener('mouseenter', () => {
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0.7';
      });
      opt.addEventListener('mouseleave', () => {
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0';
      });
    });
    updateProgress();
    
    // 감정 분석을 위한 질문 시작 시간 기록
    const questionStartTime = Date.now();
    
    // 옵션 클릭 시 피드백 추가
    document.querySelectorAll('.opt').forEach((opt, index) => {
      // 호버 트래킹
      opt.addEventListener('mouseenter', () => {
        trackUserInteraction('optionHover', { option: index });
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0.7';
      });
      
      opt.addEventListener('mouseleave', () => {
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0';
      });
      
      opt.addEventListener('click', () => {
        const timeSpent = Date.now() - questionStartTime;
        trackUserInteraction('optionClick', { timeSpent, option: index });
        
        playSound('click');
        // 임시 피드백 메시지 표시
        const feedback = document.createElement('div');
        feedback.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
        feedback.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 1000;
          background: linear-gradient(90deg, var(--brand), var(--brand2));
          color: #0b0f14; padding: 8px 12px; border-radius: 20px;
          font-size: 14px; font-weight: 700; animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2000);
      });
    });
    
    document.getElementById('prevBtn').onclick = ()=>{ 
      if(step>0){ 
        playSound('click');
        step--; 
        answers.pop(); 
        renderQuestion(); 
      } 
    };
    
    document.getElementById('nextBtn').onclick = ()=>{
      const sel = quizEl.querySelector('input[type=radio]:checked');
      if(!sel){ 
        // 재미있는 경고 메시지
        showQuickToast('🤔 선택지를 골라주세요!');
        playSound('click'); 
        return; 
      }
      
      playSound('whoosh');
      answers.push(parseInt(sel.value,10));
      step++;
      
      // 다음 질문으로 넘어가는 애니메이션
      quizEl.style.transform = 'translateX(-20px)';
      quizEl.style.opacity = '0.7';
      
      setTimeout(() => {
        renderQuestion();
        quizEl.style.transform = 'translateX(0)';
        quizEl.style.opacity = '1';
      }, 200);
    };
  }

  function pickResult(avg){ // avg: 0~1 (정규화)
    if(avg >= 0.75) return RESULTS[0];      // 10대
    if(avg >= 0.55) return RESULTS[1];      // 20대
    if(avg >= 0.35) return RESULTS[2];      // 30대
    return RESULTS[3];                      // 40대+
  }

  // 타이핑 애니메이션 함수
  function typeWriter(element, text, speed = 50) {
    element.textContent = '';
    let i = 0;
    function type() {
      if (i < text.length) {
        element.textContent += text.charAt(i);
        i++;
        setTimeout(type, speed);
      }
    }
    type();
  }

  // 로딩 시퀀스
  function showLoadingSequence(callback) {
    quizEl.classList.add('hidden');
    
    // 로딩 화면 생성
    const loadingEl = document.createElement('section');
    loadingEl.className = 'card';
    loadingEl.style.textAlign = 'center';
    loadingEl.style.padding = '40px';
    loadingEl.id = 'loading';
    
    const loadingContent = `
      <div style="font-size: 48px; margin-bottom: 20px;">🔮</div>
      <h2 id="loadingTitle" style="margin-bottom: 20px; min-height: 60px;">분석 중...</h2>
      <div style="margin-bottom: 30px;">
        <div class="progress" style="width: 300px; margin: 0 auto;">
          <div id="loadingBar" style="width: 0%; transition: width 0.3s ease;"></div>
        </div>
      </div>
      <p id="loadingMessage" style="color: var(--muted); min-height: 30px;">🧠 뇌파를 분석하는 중...</p>
    `;
    
    loadingEl.innerHTML = loadingContent;
    document.querySelector('main .wrap').appendChild(loadingEl);
    
    playSound('whoosh');
    
    let progress = 0;
    let messageIndex = 0;
    const loadingBar = document.getElementById('loadingBar');
    const loadingMessage = document.getElementById('loadingMessage');
    
    const progressInterval = setInterval(() => {
      progress += Math.random() * 25 + 10;
      if (progress > 100) progress = 100;
      
      loadingBar.style.width = progress + '%';
      
      // 메시지 변경
      if (Math.random() > 0.6 && messageIndex < loadingMessages.length - 1) {
        messageIndex++;
        loadingMessage.textContent = loadingMessages[messageIndex];
        playSound('click');
      }
      
      if (progress >= 100) {
        clearInterval(progressInterval);
        setTimeout(() => {
          playSound('success');
          loadingMessage.textContent = '✨ 분석 완료!';
          setTimeout(() => {
            loadingEl.remove();
            callback();
          }, 800);
        }, 500);
      }
    }, 400);
  }

  function showResult(){
    showLoadingSequence(() => {
      const maxPerQ = 3;
      const total = answers.reduce((a,b)=>a+b,0);
      const normalized = total / (QUESTIONS.length * maxPerQ);
      const score100 = Math.round(normalized * 100);
      const res = pickResult(normalized);

      // 텍스트 렌더 with 애니메이션
      const resTitle = document.getElementById('resTitle');
      const resSub   = document.getElementById('resSub');
      const scoreBox = document.getElementById('scoreBox');
      const resDesc  = document.getElementById('resDesc');

      // 순차적으로 타이핑 애니메이션
      setTimeout(() => {
        playSound('magic');
        createParticleExplosion(res.key);
        createScreenShake();
        triggerVibration([100, 50, 100]);
        typeWriter(resTitle, res.title, 30);
        
        // 결과 카드에 축하 효과
        resultEl.classList.add('result-celebration');
      }, 200);
      
      setTimeout(() => {
        typeWriter(resSub, res.sub, 20);
      }, 1500);
      
      setTimeout(() => {
        // 점수 카운트업 애니메이션
        let currentScore = 0;
        const scoreInterval = setInterval(() => {
          currentScore += Math.ceil((score100 - currentScore) / 10);
          if (currentScore >= score100) {
            currentScore = score100;
            clearInterval(scoreInterval);
            playSound('success', res.key);
            playSound('celebration');
            triggerVibration([200, 100, 200]);
          }
          scoreBox.textContent = `${currentScore} / 100`;
        }, 50);
      }, 2500);
      
      setTimeout(() => {
        typeWriter(resDesc, res.desc, 15);
      }, 3500);

      // 공유 링크 구성
      const base = location.origin + location.pathname.replace(/index\.html?$/,'');
      const shareUrl = base + '?result=' + encodeURIComponent(res.key) + '&score=' + score100 + '&utm_source=share&utm_medium=button';
      setupShare(shareUrl, res.title);

      // 통계 업데이트
      const updatedStats = updateStats(res.key, score100);
      
      // 결과 카드 그리기
      drawCard(res, score100);

      resultEl.classList.remove('hidden');
      resetBtn.classList.remove('hidden');
      document.getElementById('retry').onclick = restart;
      
      // 친구 도전 기능 추가
      setTimeout(() => addChallengeFeature(), 4000);
      
      // 특별한 성취 알림
      setTimeout(() => {
        if (updatedStats.totalTests === 1) {
          showQuickToast('🎉 첫 테스트 완료! 통계 버튼으로 기록을 확인해보세요');
        } else if (updatedStats.totalTests % 5 === 0) {
          showQuickToast(`🏆 ${updatedStats.totalTests}회 달성! 대단해요!`);
        } else if (updatedStats.streak >= 3) {
          showQuickToast(`🔥 ${updatedStats.streak}일 연속 테스트! 대단합니다!`);
        }
      }, 5000);
    });
  }

  function setupShare(url, title){
    const txt = encodeURIComponent(`[감성 나이] ${title}`);
    const u   = encodeURIComponent(url);
    document.getElementById('shareLine').href = `https://line.me/R/msg/text/?${txt}%0A${u}`;
    document.getElementById('shareX').href    = `https://twitter.com/intent/tweet?text=${txt}&url=${u}`;
    document.getElementById('shareFb').href   = `https://www.facebook.com/sharer/sharer.php?u=${u}`;
    document.getElementById('copyLink').onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(url);
        toast("링크를 복사했어요!");
      }catch(e){ alert(url); }
    };
    document.getElementById('saveImg').onclick = saveCard;
  }

  function restart(){
    step = 0; answers.length = 0;
    resultEl.classList.add('hidden');
    document.getElementById('bar').style.width='0%';
    start();
  }

  function start(){
    document.getElementById('resetBtn').classList.remove('hidden');
    document.getElementById('quiz').classList.remove('hidden');
    renderQuestion();
  }

  // ---------- 토스트 ----------
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style,{
      position:'fixed', left:'50%', bottom:'24px', transform:'translateX(-50%)',
      background:'rgba(20,26,38,.9)', color:'white', padding:'10px 14px', borderRadius:'10px',
      border:'1px solid rgba(255,255,255,.18)', zIndex:9999, fontWeight:800
    });
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 1600);
  }

  function showQuickToast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style,{
      position:'fixed', top:'50%', left:'50%', transform:'translate(-50%, -50%)',
      background:'linear-gradient(90deg, var(--brand), var(--brand2))', color:'#0b0f14', 
      padding:'16px 24px', borderRadius:'20px', zIndex:9999, fontWeight:800,
      fontSize:'18px', boxShadow:'0 10px 30px rgba(0,0,0,.3)',
      animation:'popIn 0.3s ease'
    });
    document.body.appendChild(t);
    setTimeout(()=>{ 
      t.style.animation = 'popOut 0.2s ease';
      setTimeout(() => t.remove(), 200);
    }, 1500);
  }

  // 친구 도전 기능
  function addChallengeFeature() {
    const resultActions = document.querySelector('#result .actions');
    if (resultActions) {
      const challengeBtn = document.createElement('button');
      challengeBtn.textContent = '🏆 친구 도전하기';
      challengeBtn.className = 'secondary';
      challengeBtn.onclick = () => {
        playSound('success');
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('challenge', 'true');
        
        if (navigator.share) {
          navigator.share({
            title: '감성연령 테스트 도전!',
            text: '나보다 더 젊은 감성일까? 도전해봐! 🔥',
            url: currentUrl.toString()
          });
        } else {
          navigator.clipboard.writeText(currentUrl.toString()).then(() => {
            showQuickToast('🔗 친구 도전 링크가 복사되었어요!');
          });
        }
      };
      resultActions.appendChild(challengeBtn);
    }
  }

  // ---------- 결과 카드 캔버스 ----------
  function drawCard(res, score){
    const c = document.getElementById('cardCanvas');
    const ctx = c.getContext('2d');

    // 배경 그라데이션
    const g = ctx.createLinearGradient(0,0,1080,1350);
    g.addColorStop(0, res.colorA);
    g.addColorStop(0.5, res.colorB);
    g.addColorStop(1, res.colorA);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,1080,1350);

    // 배경 패턴 효과
    ctx.fillStyle = 'rgba(255,255,255,.03)';
    for(let i = 0; i < 20; i++){
      const x = Math.random() * 1080;
      const y = Math.random() * 1350;
      const size = Math.random() * 60 + 20;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
    }

    // 메인 카드 패널
    const cardGrad = ctx.createLinearGradient(60, 140, 60, 1210);
    cardGrad.addColorStop(0, 'rgba(20,25,35,.85)');
    cardGrad.addColorStop(1, 'rgba(10,15,25,.9)');
    ctx.fillStyle = cardGrad;
    roundRect(ctx, 60, 140, 960, 1070, 42, true);

    // 카드 테두리 글로우
    ctx.strokeStyle = res.colorA + '40';
    ctx.lineWidth = 3;
    roundRect(ctx, 60, 140, 960, 1070, 42, false);
    ctx.stroke();

    // 상단 이모지/아이콘 영역
    ctx.fillStyle = res.colorA;
    ctx.font = '120px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(res.emoji, 540, 300);

    // 타이틀
    ctx.fillStyle = '#f0f6ff';
    ctx.font = 'bold 56px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    wrapText(ctx, res.title, 540, 380, 900, 68);

    // 서브 타이틀
    ctx.fillStyle = '#a5b4c7';
    ctx.font = '600 32px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    wrapText(ctx, res.sub, 540, 480, 900, 42);

    // 점수 배경
    const scoreGrad = ctx.createLinearGradient(240, 520, 840, 580);
    scoreGrad.addColorStop(0, res.colorA + '30');
    scoreGrad.addColorStop(1, res.colorB + '30');
    ctx.fillStyle = scoreGrad;
    roundRect(ctx, 240, 520, 600, 80, 20, true);

    // 점수 텍스트
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 52px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`감성나이: ${score}세`, 540, 570);

    // 설명 텍스트
    ctx.fillStyle = '#d1dce9';
    ctx.font = '500 26px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'left';
    
    // 한국어 텍스트를 적절히 줄바꿈
    const lines = [];
    const words = res.desc.split(' ');
    let currentLine = '';
    
    for(const word of words) {
      const testLine = currentLine + (currentLine ? ' ' : '') + word;
      if(ctx.measureText(testLine).width > 880 && currentLine) {
        lines.push(currentLine);
        currentLine = word;
      } else {
        currentLine = testLine;
      }
    }
    if(currentLine) lines.push(currentLine);
    
    lines.forEach((line, i) => {
      ctx.fillText(line, 90, 660 + i * 36);
    });

    // 장식 라인
    ctx.strokeStyle = res.colorA + '60';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(90, 1080);
    ctx.lineTo(990, 1080);
    ctx.stroke();

    // 푸터
    ctx.fillStyle = '#8a9ab0';
    ctx.font = '600 28px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('🌟 tests.mahalohana-bruce.com', 540, 1140);
    ctx.font = '500 24px "Noto Sans KR", system-ui, sans-serif';
    ctx.fillText('#감성연령 #테스트 #바이럴 #공유', 540, 1180);
  }

  function saveCard(){
    const c = document.getElementById('cardCanvas');
    const link = document.createElement('a');
    link.download = 'age-vibe-result.png';
    link.href = c.toDataURL('image/png');
    link.click();
  }

  function roundRect(ctx, x, y, w, h, r, fill){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
    if(fill) ctx.fill();
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const words = text.split(' ');
    let line = '', yy = y;
    const align = ctx.textAlign;
    
    for(let n=0; n<words.length; n++){
      const test = line + words[n] + ' ';
      if(ctx.measureText(test).width > maxWidth && n>0){
        ctx.fillText(line.trim(), x, yy);
        line = words[n] + ' ';
        yy += lineHeight;
      } else {
        line = test;
      }
    }
    ctx.fillText(line.trim(), x, yy);
  }

  // ---------- 시작/리셋 ----------
  document.getElementById('startBtn').onclick = ()=>{
    playSound('success');
    document.querySelector('.hero').classList.add('hidden');
    
    // 시작 버튼 클릭 시 재미있는 애니메이션
    const startBtn = document.getElementById('startBtn');
    startBtn.style.transform = 'scale(0.95)';
    setTimeout(() => {
      startBtn.style.transform = 'scale(1)';
      start();
    }, 100);
  };
  
  document.getElementById('resetBtn').onclick = ()=>{
    playSound('click');
    
    // 확인 메시지와 함께 리셋
    if(confirm('🔄 정말 처음부터 다시 시작하시겠어요?')) {
      showQuickToast('🎯 새로운 도전 시작!');
      setTimeout(() => location.reload(), 500);
    }
  };

  // 모든 버튼에 사운드 효과 추가
  document.addEventListener('DOMContentLoaded', () => {
    document.addEventListener('click', (e) => {
      if (e.target.matches('button:not(.no-sound)')) {
        if (!e.target.disabled) {
          playSound('click');
        }
      }
    });
    
    // 도전 기능이 활성화된 경우 특별한 메시지
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('challenge') === 'true') {
      setTimeout(() => {
        showQuickToast('🏆 친구의 도전장이 도착했어요!');
        playSound('success');
      }, 1000);
    }

    // 이스터에그: 로고를 10번 연속 클릭하면...
    let logoClickCount = 0;
    const logo = document.querySelector('.logo');
    if (logo) {
      logo.addEventListener('click', () => {
        logoClickCount++;
        playSound('click');
        
        if (logoClickCount === 5) {
          showQuickToast('🤔 뭔가 숨겨진 게 있을까요?');
        } else if (logoClickCount === 10) {
          showQuickToast('🎉 축하해요! 숨겨진 메시지를 발견했어요!');
          playSound('success');
          
          // 특별한 배경 효과
          document.body.style.animation = 'rainbow 3s ease-in-out';
          setTimeout(() => {
            document.body.style.animation = '';
          }, 3000);
          
          logoClickCount = 0; // 리셋
        } else if (logoClickCount > 15) {
          showQuickToast('😅 그만 클릭해주세요...');
          logoClickCount = 0;
        }
      });
    }

    // 랜덤 재미 요소: 가끔 화면에 이모지가 날아다님
    setInterval(() => {
      if (Math.random() > 0.98) { // 2% 확률
        createFloatingEmoji();
      }
    }, 1000);
  });

  // 떠다니는 이모지 효과
  function createFloatingEmoji() {
    const emojis = ['✨', '🌟', '💫', '⭐', '🎭', '🎪', '🦄', '🌈'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    
    const floatingEmoji = document.createElement('div');
    floatingEmoji.textContent = emoji;
    floatingEmoji.style.cssText = `
      position: fixed; 
      font-size: 24px; 
      pointer-events: none; 
      z-index: 100;
      left: ${Math.random() * window.innerWidth}px;
      top: ${window.innerHeight + 20}px;
      animation: floatUp 4s ease-out forwards;
    `;
    
    document.body.appendChild(floatingEmoji);
    
    setTimeout(() => {
      floatingEmoji.remove();
    }, 4000);
  }

  // ---------- 고급 3D 파티클 시스템 ----------
  class Particle3D {
    constructor(x, y, z, emoji, color) {
      this.x = x; this.y = y; this.z = z;
      this.vx = (Math.random() - 0.5) * 10;
      this.vy = (Math.random() - 0.5) * 10;
      this.vz = (Math.random() - 0.5) * 5;
      this.emoji = emoji;
      this.color = color;
      this.life = 1.0;
      this.decay = 0.01 + Math.random() * 0.02;
      this.rotation = Math.random() * Math.PI * 2;
      this.rotationSpeed = (Math.random() - 0.5) * 0.2;
      this.scale = 0.5 + Math.random() * 0.5;
      this.element = null;
      this.createDOMElement();
    }
    
    createDOMElement() {
      this.element = document.createElement('div');
      this.element.textContent = this.emoji;
      this.element.style.cssText = `
        position: fixed;
        font-size: ${20 * this.scale}px;
        pointer-events: none;
        z-index: 1000;
        user-select: none;
        transform-style: preserve-3d;
        filter: drop-shadow(0 0 10px ${this.color});
      `;
      document.body.appendChild(this.element);
    }
    
    update() {
      this.x += this.vx;
      this.y += this.vy;
      this.z += this.vz;
      this.vy += 0.3; // 중력
      this.rotation += this.rotationSpeed;
      this.life -= this.decay;
      
      // 3D 변환 적용
      const perspective = 1000;
      const scale3d = perspective / (perspective + this.z);
      const screenX = this.x * scale3d;
      const screenY = this.y * scale3d;
      
      this.element.style.transform = `
        translate(${screenX}px, ${screenY}px) 
        scale(${this.scale * scale3d}) 
        rotate(${this.rotation}rad)
        rotateX(${this.z * 0.01}deg)
      `;
      this.element.style.opacity = this.life;
      
      return this.life > 0;
    }
    
    destroy() {
      if (this.element) {
        this.element.remove();
      }
    }
  }

  let activeParticles = [];
  
  function create3DParticleExplosion(resultType) {
    const particles = {
      'teen': { emojis: ['⚡', '🔥', '💥', '✨', '🚀'], colors: ['#ff6b6b', '#4ecdc4', '#45b7d1'] },
      'twenties': { emojis: ['🔥', '💖', '✨', '🌟', '💫'], colors: ['#ff9ff3', '#54a0ff', '#5f27cd'] },
      'thirties': { emojis: ['⚖️', '🌱', '💼', '📚', '🏆'], colors: ['#00d2d3', '#ff9f43', '#54a0ff'] },
      'forties': { emojis: ['🍶', '🌸', '📜', '💎', '🍃'], colors: ['#feca57', '#ff6b6b', '#48dbfb'] }
    };
    
    const config = particles[resultType] || particles['teen'];
    
    // 중앙 폭발
    for (let i = 0; i < 30; i++) {
      const angle = (i / 30) * Math.PI * 2;
      const radius = 50 + Math.random() * 100;
      const x = window.innerWidth / 2 + Math.cos(angle) * radius;
      const y = window.innerHeight / 2 + Math.sin(angle) * radius;
      const z = (Math.random() - 0.5) * 200;
      
      const emoji = config.emojis[Math.floor(Math.random() * config.emojis.length)];
      const color = config.colors[Math.floor(Math.random() * config.colors.length)];
      
      activeParticles.push(new Particle3D(x, y, z, emoji, color));
    }
    
    // 원형 파동 효과
    for (let ring = 0; ring < 3; ring++) {
      setTimeout(() => {
        for (let i = 0; i < 12; i++) {
          const angle = (i / 12) * Math.PI * 2;
          const radius = (ring + 1) * 150;
          const x = window.innerWidth / 2 + Math.cos(angle) * radius;
          const y = window.innerHeight / 2 + Math.sin(angle) * radius;
          const z = ring * 50;
          
          const emoji = config.emojis[Math.floor(Math.random() * config.emojis.length)];
          const color = config.colors[Math.floor(Math.random() * config.colors.length)];
          
          activeParticles.push(new Particle3D(x, y, z, emoji, color));
        }
      }, ring * 200);
    }
  }

  // 파티클 업데이트 루프
  function updateParticles() {
    activeParticles = activeParticles.filter(particle => {
      const alive = particle.update();
      if (!alive) {
        particle.destroy();
      }
      return alive;
    });
    
    if (activeParticles.length > 0) {
      requestAnimationFrame(updateParticles);
    }
  }

  // 기존 2D 파티클도 유지 (호환성)
  function createParticleExplosion(resultType) {
    // 3D 파티클 효과 실행
    create3DParticleExplosion(resultType);
    requestAnimationFrame(updateParticles);
    
    // 기존 2D 파티클도 함께 실행 (더 풍성한 효과)
    const particles = {
      'teen': ['⚡', '🔥', '💥', '✨', '🚀'],
      'twenties': ['🔥', '💖', '✨', '🌟', '💫'],
      'thirties': ['⚖️', '🌱', '💼', '📚', '🏆'],
      'forties': ['🍶', '🌸', '📜', '💎', '🍃']
    };
    
    const particleSet = particles[resultType] || particles['teen'];
    
    // 간단한 2D 파티클로 배경 채우기
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        createParticle(
          Math.random() * window.innerWidth,
          Math.random() * window.innerHeight,
          particleSet[Math.floor(Math.random() * particleSet.length)]
        );
      }, i * 50);
    }
  }

  function createParticle(x, y, emoji) {
    const particle = document.createElement('div');
    particle.textContent = emoji;
    particle.style.cssText = `
      position: fixed;
      left: ${x}px;
      top: ${y}px;
      font-size: ${20 + Math.random() * 20}px;
      pointer-events: none;
      z-index: 1000;
      animation: particleBurst ${2 + Math.random() * 2}s ease-out forwards;
    `;
    
    document.body.appendChild(particle);
    
    setTimeout(() => {
      particle.remove();
    }, 4000);
  }

  // 화면 진동 효과
  function createScreenShake() {
    document.body.style.animation = 'screenShake 0.5s ease-in-out';
    setTimeout(() => {
      document.body.style.animation = '';
    }, 500);
  }

  // 모바일 진동
  function triggerVibration(pattern = [200]) {
    if ('vibrate' in navigator) {
      navigator.vibrate(pattern);
    }
  }

  // ---------- 통계 시스템 ----------
  const STATS_KEY = 'ageVibe_stats';
  
  function getStats() {
    const stored = localStorage.getItem(STATS_KEY);
    return stored ? JSON.parse(stored) : {
      totalTests: 0,
      resultCounts: { teen: 0, twenties: 0, thirties: 0, forties: 0 },
      averageScore: 0,
      lastResult: null,
      firstTestDate: null,
      streak: 0,
      lastTestDate: null
    };
  }
  
  function updateStats(resultKey, score) {
    const stats = getStats();
    const now = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    stats.totalTests++;
    stats.resultCounts[resultKey]++;
    stats.averageScore = Math.round((stats.averageScore * (stats.totalTests - 1) + score) / stats.totalTests);
    stats.lastResult = resultKey;
    
    if (!stats.firstTestDate) {
      stats.firstTestDate = now;
    }
    
    // 연속 테스트 계산 (하루에 한 번 이상)
    if (stats.lastTestDate === now) {
      // 같은 날이면 스트릭 유지
    } else if (stats.lastTestDate && isConsecutiveDay(stats.lastTestDate, now)) {
      stats.streak++;
    } else {
      stats.streak = 1;
    }
    
    stats.lastTestDate = now;
    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    
    return stats;
  }
  
  function isConsecutiveDay(lastDate, currentDate) {
    const last = new Date(lastDate);
    const current = new Date(currentDate);
    const diffTime = current - last;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays === 1;
  }
  
  function getPopularResult() {
    const stats = getStats();
    let maxCount = 0;
    let popularResult = 'teen';
    
    for (const [key, count] of Object.entries(stats.resultCounts)) {
      if (count > maxCount) {
        maxCount = count;
        popularResult = key;
      }
    }
    
    return { key: popularResult, count: maxCount };
  }
  
  function showStatsPopup() {
    const stats = getStats();
    const popular = getPopularResult();
    const resultNames = {
      teen: '초고속 Z세대 감성',
      twenties: 'MZ 트렌디 감성', 
      thirties: '밸런스 마스터 감성',
      forties: '클래식 어른 감성'
    };
    
    const popup = document.createElement('div');
    popup.style.cssText = `
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.2); border-radius: 20px;
      padding: 24px; max-width: 400px; z-index: 2000;
      backdrop-filter: blur(10px); color: var(--text);
      animation: popIn 0.3s ease;
    `;
    
    popup.innerHTML = `
      <h3 style="margin-top:0; text-align:center; color:var(--brand);">📊 내 통계</h3>
      <div style="display:grid; gap:12px;">
        <div>🎯 총 테스트 횟수: <strong>${stats.totalTests}회</strong></div>
        <div>📈 평균 감성나이: <strong>${stats.averageScore}세</strong></div>
        <div>🏆 가장 많이 나온 결과: <strong>${resultNames[popular.key]}</strong> (${popular.count}회)</div>
        <div>🔥 연속 테스트: <strong>${stats.streak}일</strong></div>
        ${stats.firstTestDate ? `<div>📅 첫 테스트: ${stats.firstTestDate}</div>` : ''}
      </div>
      <button onclick="this.parentElement.remove()" 
        style="width:100%; margin-top:16px; padding:10px; border:none; 
               background:linear-gradient(90deg, var(--brand), var(--brand2)); 
               color:#0b0f14; border-radius:10px; font-weight:700; cursor:pointer;">
        닫기
      </button>
    `;
    
    document.body.appendChild(popup);
    playSound('whoosh');
  }

  // 옵션별 힌트 시스템
  function getOptionHint(score) {
    const hints = {
      0: '클래식 선택 ✨',
      1: '안정적 선택 📚', 
      2: '트렌디 선택 🔥',
      3: '최신 트렌드 ⚡'
    };
    return hints[score] || '';
  }

  // ---------- 실시간 감정 분석 시스템 ----------
  let emotionAnalyzer = {
    clickTiming: [],
    hoverPatterns: [],
    scrollBehavior: [],
    currentMood: 'neutral'
  };

  function analyzeUserEmotion() {
    const timing = emotionAnalyzer.clickTiming;
    const hover = emotionAnalyzer.hoverPatterns;
    
    let emotionScore = {
      excitement: 0,
      hesitation: 0,
      confidence: 0,
      curiosity: 0
    };
    
    // 클릭 타이밍 분석
    if (timing.length > 1) {
      const avgTime = timing.reduce((a, b) => a + b) / timing.length;
      if (avgTime < 2000) emotionScore.excitement += 0.3;
      if (avgTime > 8000) emotionScore.hesitation += 0.4;
      if (avgTime >= 3000 && avgTime <= 6000) emotionScore.confidence += 0.3;
    }
    
    // 호버 패턴 분석
    const hoverCount = hover.reduce((sum, h) => sum + h.count, 0);
    const avgHover = hoverCount / Math.max(hover.length, 1);
    
    if (avgHover > 3) emotionScore.curiosity += 0.4;
    if (avgHover < 1.5) emotionScore.confidence += 0.2;
    
    // 가장 높은 점수의 감정 반환
    const dominantEmotion = Object.keys(emotionScore)
      .reduce((a, b) => emotionScore[a] > emotionScore[b] ? a : b);
    
    return {
      emotion: dominantEmotion,
      intensity: Math.max(...Object.values(emotionScore)),
      profile: emotionScore
    };
  }

  function updateEmotionUI(analysis) {
    const indicator = document.getElementById('emotionIndicator');
    if (!indicator) return;
    
    const emotionData = {
      excitement: { emoji: '🚀', color: '#ff6b6b', message: '와우! 엄청 빨라요!' },
      hesitation: { emoji: '🤔', color: '#95a5a6', message: '신중하게 고민 중이시군요' },
      confidence: { emoji: '😎', color: '#2ecc71', message: '확신에 찬 선택이네요!' },
      curiosity: { emoji: '🧐', color: '#f39c12', message: '궁금증이 많으시네요!' }
    };
    
    const data = emotionData[analysis.emotion] || emotionData.confidence;
    
    indicator.innerHTML = `
      <div style="
        display: flex; align-items: center; gap: 8px; padding: 8px 12px;
        background: linear-gradient(90deg, ${data.color}20, ${data.color}10);
        border: 1px solid ${data.color}40; border-radius: 20px;
        font-size: 12px; margin-bottom: 10px;
        animation: emotionPulse 1s ease-in-out;
      ">
        <span style="font-size: 16px;">${data.emoji}</span>
        <span style="color: ${data.color};">${data.message}</span>
        <div style="
          width: ${Math.min(analysis.intensity * 100, 100)}%; height: 3px;
          background: ${data.color}; border-radius: 2px;
          transition: width 0.5s ease;
        "></div>
      </div>
    `;
  }

  function trackUserInteraction(action, data = {}) {
    const now = Date.now();
    
    switch (action) {
      case 'optionClick':
        emotionAnalyzer.clickTiming.push(data.timeSpent || 0);
        break;
      case 'optionHover':
        const lastHover = emotionAnalyzer.hoverPatterns[emotionAnalyzer.hoverPatterns.length - 1];
        if (lastHover && now - lastHover.timestamp < 1000) {
          lastHover.count++;
        } else {
          emotionAnalyzer.hoverPatterns.push({
            timestamp: now,
            count: 1,
            option: data.option
          });
        }
        break;
    }
    
    // 실시간 감정 분석 및 UI 업데이트
    if (emotionAnalyzer.clickTiming.length > 0 || emotionAnalyzer.hoverPatterns.length > 2) {
      const analysis = analyzeUserEmotion();
      updateEmotionUI(analysis);
      
      // 감정 기반 맞춤 피드백
      provideMoodBasedFeedback(analysis);
    }
  }

  function provideMoodBasedFeedback(analysis) {
    const feedbacks = {
      excitement: ['빠른 선택! 🚀', '에너지 넘치네요! ⚡', '역동적이에요! 💨'],
      hesitation: ['천천히 해도 괜찮아요 😊', '신중한 선택 좋아요! 🤗', '충분히 고민하세요 💭'],
      confidence: ['확실한 선택! 👍', '자신감 있어 보여요! 😎', '멋진 판단이에요! ✨'],
      curiosity: ['탐구심이 많으시네요! 🔍', '흥미로운 관점! 🧐', '깊이 생각하시는군요! 💡']
    };
    
    const messages = feedbacks[analysis.emotion] || feedbacks.confidence;
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    
    // 감정 피드백을 옵션에 표시
    setTimeout(() => {
      const activeFeedback = document.querySelector('.emotion-feedback');
      if (activeFeedback && Math.random() > 0.7) { // 30% 확률
        activeFeedback.textContent = randomMessage;
        activeFeedback.style.opacity = '1';
        setTimeout(() => {
          activeFeedback.style.opacity = '0';
        }, 2000);
      }
    }, 500);
  }

  // ========== 소셜 랭킹과 글로벌 리더보드 시스템 ==========
  
  class SocialRanking {
    constructor() {
      this.storageKey = 'ageVibeGlobalRanking';
      this.userStorageKey = 'ageVibeUserProfile';
      this.maxEntries = 1000;
      this.init();
    }

    init() {
      this.createLeaderboardUI();
      this.bindEvents();
      this.syncWithServer();
    }

    createLeaderboardUI() {
      // 버튼은 이미 HTML에 통합되어 있음

      // 리더보드 모달 창 생성
      if (!document.getElementById('leaderboardModal')) {
        const modal = document.createElement('div');
        modal.id = 'leaderboardModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>🏆 글로벌 리더보드</h2>
              <span class="close">&times;</span>
            </div>
            <div class="ranking-tabs">
              <button class="tab-btn active" data-tab="global">🌍 전체</button>
              <button class="tab-btn" data-tab="today">📅 오늘</button>
              <button class="tab-btn" data-tab="week">📊 이번 주</button>
              <button class="tab-btn" data-tab="friends">👥 친구</button>
            </div>
            <div class="ranking-content">
              <div id="globalRanking" class="ranking-list active"></div>
              <div id="todayRanking" class="ranking-list"></div>
              <div id="weekRanking" class="ranking-list"></div>
              <div id="friendsRanking" class="ranking-list"></div>
            </div>
            <div class="user-rank-info">
              <div id="userRankDisplay"></div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // 모달 스타일 추가
      if (!document.getElementById('leaderboard-styles')) {
        const style = document.createElement('style');
        style.id = 'leaderboard-styles';
        style.textContent = `
          .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
          }

          .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
          }

          .modal-header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
          }

          .modal-header h2 {
            color: white;
            margin: 0;
            font-size: 24px;
            font-weight: 700;
          }

          .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
          }

          .close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
          }

          .ranking-tabs {
            display: flex;
            padding: 0 20px;
            background: rgba(255,255,255,0.05);
          }

          .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
          }

          .tab-btn.active,
          .tab-btn:hover {
            color: white;
            border-bottom-color: #fff;
            background: rgba(255,255,255,0.1);
          }

          .ranking-content {
            padding: 20px;
            min-height: 300px;
          }

          .ranking-list {
            display: none;
          }

          .ranking-list.active {
            display: block;
          }

          .rank-item {
            background: rgba(255,255,255,0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
          }

          .rank-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
          }

          .rank-number {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            margin-right: 15px;
            min-width: 35px;
          }

          .rank-info {
            flex-grow: 1;
            color: white;
          }

          .rank-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
          }

          .rank-details {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
          }

          .rank-score {
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
            margin-left: 15px;
          }

          .user-rank-info {
            background: rgba(255,255,255,0.1);
            margin: 20px;
            padding: 15px;
            border-radius: 12px;
            color: white;
            text-align: center;
            backdrop-filter: blur(5px);
          }

          .rank-item.top3 {
            background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.3) 100%);
            border: 2px solid rgba(255,215,0,0.5);
          }

          .rank-item.current-user {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.3) 0%, rgba(52, 152, 219, 0.3) 100%);
            border: 2px solid rgba(46, 204, 113, 0.6);
          }

          .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
          }

          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }

          @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }

          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `;
        document.head.appendChild(style);
      }
    }

    bindEvents() {
      // 랭킹 버튼 이벤트
      const rankingBtn = document.getElementById('rankingBtn');
      if (rankingBtn && !rankingBtn.hasAttribute('data-bound')) {
        rankingBtn.setAttribute('data-bound', 'true');
        rankingBtn.addEventListener('click', () => {
          this.showLeaderboard();
          if (typeof playSound === 'function') playSound('success');
        });
      }

      // 모달 닫기 이벤트
      const modal = document.getElementById('leaderboardModal');
      if (modal) {
        const closeBtn = modal.querySelector('.close');
        if (closeBtn && !closeBtn.hasAttribute('data-bound')) {
          closeBtn.setAttribute('data-bound', 'true');
          closeBtn.addEventListener('click', () => {
            this.hideLeaderboard();
          });
        }

        if (!modal.hasAttribute('data-bound')) {
          modal.setAttribute('data-bound', 'true');
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              this.hideLeaderboard();
            }
          });
        }

        // 탭 전환 이벤트
        const tabBtns = modal.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
          if (!btn.hasAttribute('data-bound')) {
            btn.setAttribute('data-bound', 'true');
            btn.addEventListener('click', () => {
              const tab = btn.getAttribute('data-tab');
              this.switchTab(tab);
              if (typeof playSound === 'function') playSound('click');
            });
          }
        });
      }
    }

    async showLeaderboard() {
      const modal = document.getElementById('leaderboardModal');
      modal.style.display = 'block';
      
      // 현재 사용자 정보 표시
      this.displayUserRank();
      
      // 각 탭의 데이터 로드
      await this.loadRankingData('global');
      await this.loadRankingData('today');
      await this.loadRankingData('week');
      await this.loadRankingData('friends');
    }

    hideLeaderboard() {
      const modal = document.getElementById('leaderboardModal');
      modal.style.display = 'none';
    }

    switchTab(tabName) {
      // 탭 버튼 활성화
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });

      // 랭킹 리스트 표시
      const rankingLists = document.querySelectorAll('.ranking-list');
      rankingLists.forEach(list => {
        list.classList.toggle('active', list.id === tabName + 'Ranking');
      });
    }

    async loadRankingData(type) {
      const container = document.getElementById(type + 'Ranking');
      container.innerHTML = '<div class="loading-spinner"></div> 데이터 로딩 중...';

      try {
        let data;
        switch(type) {
          case 'global':
            data = await this.getGlobalRanking();
            break;
          case 'today':
            data = await this.getTodayRanking();
            break;
          case 'week':
            data = await this.getWeekRanking();
            break;
          case 'friends':
            data = await this.getFriendsRanking();
            break;
        }

        this.renderRankingList(container, data, type);
      } catch (error) {
        container.innerHTML = '❌ 데이터를 불러올 수 없습니다.';
        console.error('Ranking data load error:', error);
      }
    }

    async getGlobalRanking() {
      // 로컬 스토리지에서 글로벌 랭킹 데이터 가져오기
      const stored = localStorage.getItem(this.storageKey);
      let rankings = stored ? JSON.parse(stored) : [];
      
      // 점수순으로 정렬
      rankings.sort((a, b) => b.score - a.score);
      
      return rankings.slice(0, 50); // 상위 50명만
    }

    async getTodayRanking() {
      const today = new Date().toDateString();
      const rankings = await this.getGlobalRanking();
      return rankings.filter(item => 
        new Date(item.timestamp).toDateString() === today
      ).slice(0, 20);
    }

    async getWeekRanking() {
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      const rankings = await this.getGlobalRanking();
      return rankings.filter(item => 
        new Date(item.timestamp) >= weekAgo
      ).slice(0, 30);
    }

    async getFriendsRanking() {
      // 친구 시스템은 추후 구현 (현재는 사용자 데이터만)
      const userProfile = this.getUserProfile();
      if (!userProfile.bestScore) return [];

      return [
        {
          name: '나',
          score: userProfile.bestScore,
          result: userProfile.lastResult || '감성 연령',
          timestamp: userProfile.lastPlayed || Date.now(),
          isFriend: true,
          isCurrentUser: true
        }
      ];
    }

    renderRankingList(container, data, type) {
      if (!data || data.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">
            🏆 아직 랭킹 데이터가 없습니다.<br>
            첫 번째로 기록을 남겨보세요!
          </div>
        `;
        return;
      }

      const html = data.map((item, index) => {
        const rank = index + 1;
        const medal = this.getMedalIcon(rank);
        const isTopThree = rank <= 3;
        const isCurrentUser = item.isCurrentUser;
        
        return `
          <div class="rank-item ${isTopThree ? 'top3' : ''} ${isCurrentUser ? 'current-user' : ''}">
            <div class="rank-number">
              ${medal || rank}
            </div>
            <div class="rank-info">
              <div class="rank-name">
                ${item.name || '익명의 사용자'}
                ${isCurrentUser ? ' (나)' : ''}
              </div>
              <div class="rank-details">
                ${item.result || '감성 연령'} • ${this.formatDate(item.timestamp)}
              </div>
            </div>
            <div class="rank-score">
              ${item.score}점
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    getMedalIcon(rank) {
      const medals = {
        1: '🥇',
        2: '🥈', 
        3: '🥉'
      };
      return medals[rank];
    }

    formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffMinutes < 1) return '방금 전';
      if (diffMinutes < 60) return `${diffMinutes}분 전`;
      if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}시간 전`;
      
      return date.toLocaleDateString('ko-KR');
    }

    recordResult(name, score, result) {
      const stored = localStorage.getItem(this.storageKey);
      let rankings = stored ? JSON.parse(stored) : [];
      
      const newEntry = {
        id: Date.now() + Math.random(),
        name: name || '익명의 사용자',
        score: score,
        result: result,
        timestamp: Date.now(),
        userAgent: navigator.userAgent.slice(0, 50)
      };
      
      rankings.push(newEntry);
      
      // 최대 개수 제한
      if (rankings.length > this.maxEntries) {
        rankings = rankings.slice(-this.maxEntries);
      }
      
      localStorage.setItem(this.storageKey, JSON.stringify(rankings));
      
      // 사용자 프로필 업데이트
      this.updateUserProfile(newEntry);
      
      // 서버와 동기화 (추후 구현)
      this.syncWithServer();
      
      // 새로운 기록 알림
      this.showRankingAchievement(score, result);
    }

    updateUserProfile(entry) {
      const currentProfile = this.getUserProfile();
      const profile = {
        bestScore: Math.max(entry.score, currentProfile.bestScore || 0),
        lastResult: entry.result,
        lastPlayed: entry.timestamp,
        totalPlays: (currentProfile.totalPlays || 0) + 1
      };
      
      localStorage.setItem(this.userStorageKey, JSON.stringify(profile));
    }

    getUserProfile() {
      const stored = localStorage.getItem(this.userStorageKey);
      return stored ? JSON.parse(stored) : {};
    }

    displayUserRank() {
      const profile = this.getUserProfile();
      const container = document.getElementById('userRankDisplay');
      
      if (!profile.bestScore) {
        container.innerHTML = '🎯 첫 테스트를 완료하고 랭킹에 도전하세요!';
        return;
      }

      this.getGlobalRanking().then(rankings => {
        const userRank = rankings.findIndex(item => 
          item.score <= profile.bestScore
        ) + 1;

        container.innerHTML = `
          <div>
            🏆 내 최고 기록: <strong>${profile.bestScore}점</strong><br>
            📊 전체 랭킹: <strong>${userRank > 0 ? userRank + '위' : '순위 집계 중'}</strong><br>
            🎮 총 플레이: <strong>${profile.totalPlays || 1}회</strong>
          </div>
        `;
      });
    }

    getCurrentUserScore() {
      return this.getUserProfile().bestScore || 0;
    }

    getCurrentUserResult() {
      return this.getUserProfile().lastResult || '감성 연령';
    }

    showRankingAchievement(score, result) {
      // 순위 달성 알림 표시
      setTimeout(() => {
        this.getGlobalRanking().then(rankings => {
          const rank = rankings.findIndex(item => item.score <= score) + 1;
          
          if (rank <= 10) {
            if (typeof showQuickToast === 'function') {
              showQuickToast(`🏆 축하합니다! 전체 ${rank}위에 랭크되었습니다!`);
            }
            this.createCelebrationEffect();
          } else if (rank <= 50) {
            if (typeof showQuickToast === 'function') {
              showQuickToast(`🎉 좋은 결과! 상위 50위 안에 들었어요!`);
            }
          }
        });
      }, 2000);
    }

    createCelebrationEffect() {
      // 축하 파티클 효과
      const colors = ['#FFD700', '#FFA500', '#FF69B4', '#00CED1', '#32CD32'];
      
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const particle = document.createElement('div');
          particle.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            border-radius: 50%;
            pointer-events: none;
            z-index: 10001;
            animation: celebrate 2s ease-out forwards;
          `;
          
          const angle = (i * 18) * Math.PI / 180;
          const distance = 200 + Math.random() * 100;
          const endX = Math.cos(angle) * distance;
          const endY = Math.sin(angle) * distance;
          
          particle.style.setProperty('--endX', endX + 'px');
          particle.style.setProperty('--endY', endY + 'px');
          
          document.body.appendChild(particle);
          
          setTimeout(() => particle.remove(), 2000);
        }, i * 50);
      }
      
      // 축하 애니메이션 CSS 추가
      if (!document.querySelector('#celebration-style')) {
        const style = document.createElement('style');
        style.id = 'celebration-style';
        style.textContent = `
          @keyframes celebrate {
            0% {
              transform: translate(-50%, -50%) scale(1);
              opacity: 1;
            }
            100% {
              transform: translate(calc(-50% + var(--endX)), calc(-50% + var(--endY))) scale(0);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    async syncWithServer() {
      // 실제 서버 동기화는 추후 구현
      // 현재는 로컬 스토리지만 사용
      return Promise.resolve();
    }
  }

  // 소셜 랭킹 시스템 초기화
  window.socialRanking = new SocialRanking();

  // ========== 개인화된 추천 시스템 ==========
  
  class PersonalizedRecommendation {
    constructor() {
      this.storageKey = 'ageVibePersonalization';
      this.analysisKey = 'ageVibeUserAnalysis';
      this.recommendations = [];
      this.userProfile = null;
      this.init();
    }

    init() {
      this.loadUserProfile();
      this.createRecommendationUI();
      this.bindEvents();
    }

    loadUserProfile() {
      const stored = localStorage.getItem(this.analysisKey);
      this.userProfile = stored ? JSON.parse(stored) : {
        testHistory: [],
        preferences: {
          categories: {},
          timePatterns: [],
          emotionalTrends: []
        },
        personality: {
          decisionSpeed: 'moderate',
          riskTaking: 'balanced',
          socialness: 'moderate',
          creativity: 'balanced'
        },
        interactions: {
          mostClickedOptions: [],
          favoriteTimes: [],
          deviceUsage: {},
          sessionLengths: []
        }
      };
    }

    createRecommendationUI() {
      // 버튼은 이미 HTML에 통합되어 있음

      // 추천 모달 창 생성
      if (!document.getElementById('recommendationModal')) {
        const modal = document.createElement('div');
        modal.id = 'recommendationModal';
        modal.className = 'recommendation-modal';
        modal.innerHTML = `
          <div class="recommendation-content">
            <div class="recommendation-header">
              <h2>🎯 당신을 위한 맞춤 추천</h2>
              <span class="rec-close">&times;</span>
            </div>
            
            <div class="recommendation-tabs">
              <button class="rec-tab-btn active" data-tab="insights">🧠 인사이트</button>
              <button class="rec-tab-btn" data-tab="actions">🎯 추천 행동</button>
              <button class="rec-tab-btn" data-tab="similar">👥 유사한 사용자</button>
              <button class="rec-tab-btn" data-tab="growth">📈 성장 경로</button>
            </div>
            
            <div class="recommendation-body">
              <div id="insightsTab" class="rec-tab-content active">
                <div id="personalInsights"></div>
              </div>
              
              <div id="actionsTab" class="rec-tab-content">
                <div id="recommendedActions"></div>
              </div>
              
              <div id="similarTab" class="rec-tab-content">
                <div id="similarUsers"></div>
              </div>
              
              <div id="growthTab" class="rec-tab-content">
                <div id="growthPath"></div>
              </div>
            </div>
            
            <div class="recommendation-footer">
              <button id="updateProfileBtn" class="update-profile-btn">프로필 업데이트</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // 추천 시스템 스타일 추가
      if (!document.getElementById('recommendation-styles')) {
        const style = document.createElement('style');
        style.id = 'recommendation-styles';
        style.textContent = `
          .recommendation-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
          }

          .recommendation-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 3% auto;
            padding: 0;
            border-radius: 25px;
            width: 92%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: slideUp 0.4s ease;
          }

          .recommendation-header {
            background: rgba(255,255,255,0.15);
            padding: 25px;
            border-radius: 25px 25px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(15px);
          }

          .recommendation-header h2 {
            color: white;
            margin: 0;
            font-size: 26px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
          }

          .rec-close {
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
          }

          .rec-close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
          }

          .recommendation-tabs {
            display: flex;
            padding: 0 25px;
            background: rgba(255,255,255,0.08);
            flex-wrap: wrap;
          }

          .rec-tab-btn {
            flex: 1;
            min-width: 140px;
            padding: 15px 10px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin: 0 2px;
          }

          .rec-tab-btn.active,
          .rec-tab-btn:hover {
            color: white;
            border-bottom-color: #ffd700;
            background: rgba(255,255,255,0.1);
          }

          .recommendation-body {
            padding: 25px;
            min-height: 400px;
          }

          .rec-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
          }

          .rec-tab-content.active {
            display: block;
          }

          .insight-card {
            background: rgba(255,255,255,0.1);
            margin: 15px 0;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
          }

          .insight-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          }

          .insight-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
          }

          .insight-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.6;
            font-size: 14px;
          }

          .insight-score {
            display: inline-block;
            background: linear-gradient(90deg, #ffd700, #ffed4a);
            color: #2c2c2c;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 10px;
          }

          .action-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            margin: 12px 0;
            padding: 18px;
            border-radius: 12px;
            border-left: 4px solid #4ecdc4;
            transition: all 0.3s ease;
          }

          .action-item:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.1) 100%);
            transform: translateX(5px);
          }

          .action-title {
            font-size: 16px;
            font-weight: 600;
            color: #4ecdc4;
            margin-bottom: 8px;
          }

          .action-description {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            line-height: 1.5;
          }

          .similarity-user {
            background: rgba(255,255,255,0.08);
            margin: 10px 0;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
          }

          .similarity-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
          }

          .similarity-info {
            flex-grow: 1;
            color: white;
          }

          .similarity-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
          }

          .similarity-stats {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
          }

          .similarity-score {
            background: #4ecdc4;
            color: #2c2c2c;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
          }

          .growth-step {
            background: rgba(255,255,255,0.1);
            margin: 15px 0;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
          }

          .growth-step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 15px;
            padding: 2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: exclude;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
          }

          .growth-step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 10px;
          }

          .growth-step-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 8px;
          }

          .growth-step-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.5;
            font-size: 14px;
          }

          .recommendation-footer {
            background: rgba(255,255,255,0.05);
            padding: 20px 25px;
            border-radius: 0 0 25px 25px;
            text-align: center;
          }

          .update-profile-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #2c2c2c;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
          }

          .update-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
          }

          .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
          }

          .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            border-radius: 4px;
            transition: width 1s ease;
          }

          @media (max-width: 768px) {
            .recommendation-content {
              margin: 1% auto;
              width: 95%;
              max-height: 95vh;
            }
            
            .rec-tab-btn {
              min-width: 100px;
              font-size: 12px;
              padding: 12px 8px;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    bindEvents() {
      // 추천 버튼 이벤트
      const recBtn = document.getElementById('recommendationBtn');
      if (recBtn && !recBtn.hasAttribute('data-bound')) {
        recBtn.setAttribute('data-bound', 'true');
        recBtn.addEventListener('click', () => {
          this.showRecommendations();
          if (typeof playSound === 'function') playSound('success');
        });
      }

      // 모달 닫기 이벤트
      const modal = document.getElementById('recommendationModal');
      if (modal) {
        const closeBtn = modal.querySelector('.rec-close');
        if (closeBtn && !closeBtn.hasAttribute('data-bound')) {
          closeBtn.setAttribute('data-bound', 'true');
          closeBtn.addEventListener('click', () => {
            this.hideRecommendations();
          });
        }

        if (!modal.hasAttribute('data-bound')) {
          modal.setAttribute('data-bound', 'true');
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              this.hideRecommendations();
            }
          });
        }

        // 탭 전환 이벤트
        const tabBtns = modal.querySelectorAll('.rec-tab-btn');
        tabBtns.forEach(btn => {
          if (!btn.hasAttribute('data-bound')) {
            btn.setAttribute('data-bound', 'true');
            btn.addEventListener('click', () => {
              const tab = btn.getAttribute('data-tab');
              this.switchRecommendationTab(tab);
              if (typeof playSound === 'function') playSound('click');
            });
          }
        });

        // 프로필 업데이트 버튼
        const updateBtn = modal.querySelector('#updateProfileBtn');
        if (updateBtn && !updateBtn.hasAttribute('data-bound')) {
          updateBtn.setAttribute('data-bound', 'true');
          updateBtn.addEventListener('click', () => {
            this.updateUserProfile();
            if (typeof playSound === 'function') playSound('success');
          });
        }
      }
    }

    showRecommendations() {
      const modal = document.getElementById('recommendationModal');
      modal.style.display = 'block';
      
      // 데이터 분석 및 추천 생성
      this.analyzeUserBehavior();
      this.generatePersonalizedRecommendations();
      
      // 각 탭 내용 로드
      this.loadInsights();
      this.loadRecommendedActions();
      this.loadSimilarUsers();
      this.loadGrowthPath();
    }

    hideRecommendations() {
      const modal = document.getElementById('recommendationModal');
      modal.style.display = 'none';
    }

    switchRecommendationTab(tabName) {
      // 탭 버튼 활성화
      const tabBtns = document.querySelectorAll('.rec-tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });

      // 탭 내용 표시
      const tabContents = document.querySelectorAll('.rec-tab-content');
      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === tabName + 'Tab');
      });
    }

    analyzeUserBehavior() {
      // 사용자 행동 패턴 분석
      const stats = typeof getStats === 'function' ? getStats() : {};
      const emotionData = emotionAnalyzer || {};
      const testHistory = this.userProfile.testHistory || [];

      // 테스트 패턴 분석
      if (stats.totalTests > 0) {
        this.userProfile.preferences.categories = stats.resultCounts || {};
        
        // 결정 속도 분석
        if (emotionData.clickTiming && emotionData.clickTiming.length > 0) {
          const avgTime = emotionData.clickTiming.reduce((a, b) => a + b) / emotionData.clickTiming.length;
          this.userProfile.personality.decisionSpeed = 
            avgTime < 3000 ? 'fast' : avgTime > 8000 ? 'slow' : 'moderate';
        }

        // 호버 패턴으로 신중함 측정
        if (emotionData.hoverPatterns && emotionData.hoverPatterns.length > 0) {
          const avgHover = emotionData.hoverPatterns.reduce((sum, h) => sum + h.count, 0) / emotionData.hoverPatterns.length;
          this.userProfile.personality.riskTaking = 
            avgHover > 3 ? 'conservative' : avgHover < 1.5 ? 'bold' : 'balanced';
        }
      }

      // 시간대별 활동 패턴
      const currentHour = new Date().getHours();
      this.userProfile.interactions.favoriteTimes.push(currentHour);

      // 기기 사용 패턴
      const deviceType = /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'mobile' : 'desktop';
      this.userProfile.interactions.deviceUsage[deviceType] = 
        (this.userProfile.interactions.deviceUsage[deviceType] || 0) + 1;

      // 프로필 저장
      localStorage.setItem(this.analysisKey, JSON.stringify(this.userProfile));
    }

    generatePersonalizedRecommendations() {
      const personality = this.userProfile.personality;
      const preferences = this.userProfile.preferences;
      const stats = typeof getStats === 'function' ? getStats() : {};

      this.recommendations = {
        insights: this.generateInsights(personality, preferences, stats),
        actions: this.generateActions(personality, preferences),
        similar: this.generateSimilarUsers(personality, preferences),
        growth: this.generateGrowthPath(personality, stats)
      };
    }

    generateInsights(personality, preferences, stats) {
      const insights = [];

      // 결정 스타일 인사이트
      if (personality.decisionSpeed === 'fast') {
        insights.push({
          title: '⚡ 직관적 결정자',
          description: '빠른 결정을 내리는 편이군요! 직감을 믿고 행동하는 타입으로, 기회를 잘 잡는 성향을 보입니다.',
          score: '직관력 85%',
          color: '#ff6b6b'
        });
      } else if (personality.decisionSpeed === 'slow') {
        insights.push({
          title: '🤔 신중한 분석자',
          description: '신중하게 고민하고 결정하시는군요. 세심한 분석을 통해 최적의 선택을 하려는 노력이 돋보입니다.',
          score: '분석력 92%',
          color: '#4ecdc4'
        });
      }

      // 위험 선호도 인사이트  
      if (personality.riskTaking === 'bold') {
        insights.push({
          title: '🚀 모험가 기질',
          description: '새로운 도전을 즐기고 위험을 두려워하지 않는 성향입니다. 혁신적인 아이디어를 추구하는 타입이에요.',
          score: '도전성 88%',
          color: '#667eea'
        });
      } else if (personality.riskTaking === 'conservative') {
        insights.push({
          title: '🛡️ 안정 추구자',
          description: '신중하고 안정적인 선택을 선호하시네요. 리스크를 최소화하며 확실한 성과를 추구하는 스타일입니다.',
          score: '안정성 90%',
          color: '#95a5a6'
        });
      }

      // 감성 연령 패턴 분석
      if (stats.totalTests > 2) {
        const mostCommon = Object.keys(preferences.categories).reduce((a, b) => 
          preferences.categories[a] > preferences.categories[b] ? a : b
        );
        
        const ageInsights = {
          teen: { title: '🌟 영 스피릿', description: '젊고 역동적인 에너지가 가득! 새로운 트렌드와 변화를 빠르게 받아들이는 타입입니다.' },
          twenties: { title: '💫 트렌디 센스', description: '최신 트렌드에 민감하며 창의적 사고가 뛰어나네요. 균형감각도 훌륭합니다!' },
          thirties: { title: '⚖️ 밸런스 마스터', description: '성숙함과 활력을 동시에 갖춘 균형잡힌 성향을 보입니다. 리더십이 뛰어나요!' },
          forties: { title: '🍃 클래식 우아함', description: '깊이 있는 사고와 우아한 품격을 갖추었네요. 전통과 혁신을 조화시키는 능력이 있습니다.' }
        };
        
        if (ageInsights[mostCommon]) {
          insights.push({
            title: ageInsights[mostCommon].title,
            description: ageInsights[mostCommon].description,
            score: `일관성 ${Math.round((preferences.categories[mostCommon] / stats.totalTests) * 100)}%`,
            color: '#ffd700'
          });
        }
      }

      return insights;
    }

    generateActions(personality, preferences) {
      const actions = [];

      if (personality.decisionSpeed === 'fast') {
        actions.push({
          title: '⏸️ 잠시 멈춤 연습',
          description: '가끔은 속도를 늦추고 더 깊이 생각해보세요. 명상이나 일기 쓰기 같은 활동이 도움될 거예요.'
        });
        actions.push({
          title: '🎯 목표 설정 시간',
          description: '빠른 결정력을 장기 목표 달성에 활용해보세요. 단계별 계획을 세우면 더 큰 성과를 얻을 수 있어요.'
        });
      } else if (personality.decisionSpeed === 'slow') {
        actions.push({
          title: '⚡ 직감 훈련',
          description: '가끔은 첫 번째 생각을 믿어보세요. 작은 결정부터 직감으로 해보는 연습을 해보는 건 어떨까요?'
        });
        actions.push({
          title: '⏰ 시간 제한 도전',
          description: '의사결정에 시간 제한을 두고 연습해보세요. 스피드 결정 게임이나 퀴즈에 도전해보는 것도 좋아요.'
        });
      }

      if (personality.riskTaking === 'conservative') {
        actions.push({
          title: '🌱 작은 모험 시작',
          description: '안전한 범위에서 작은 도전을 시도해보세요. 새로운 취미나 맛집 탐방부터 시작해보는 건 어떨까요?'
        });
      } else if (personality.riskTaking === 'bold') {
        actions.push({
          title: '📊 리스크 관리 학습',
          description: '모험심을 더 효과적으로 활용하기 위해 리스크 관리 방법을 배워보세요. 계획적인 도전이 더 큰 성과를 가져다 줄 거예요.'
        });
      }

      // 일반적인 추천
      actions.push({
        title: '📚 자기계발 독서',
        description: '당신의 성향에 맞는 자기계발서를 읽어보세요. 성장과 변화의 기회가 될 것입니다.'
      });

      actions.push({
        title: '🤝 네트워킹 활동',
        description: '비슷한 관심사를 가진 사람들과 교류해보세요. 새로운 관점과 기회를 발견할 수 있어요.'
      });

      return actions;
    }

    generateSimilarUsers(personality, preferences) {
      // 유사한 사용자 프로필 생성 (시뮬레이션)
      const similar = [];
      
      const profiles = [
        { name: '모험가 김OO', avatar: '🚀', similarity: 87, description: '빠른 결정, 도전적 성향' },
        { name: '분석가 이OO', avatar: '🤔', similarity: 82, description: '신중함, 체계적 사고' },
        { name: '균형러 박OO', avatar: '⚖️', similarity: 79, description: '안정성과 창의성의 조화' },
        { name: '트렌디 최OO', avatar: '✨', similarity: 85, description: '감각적 선택, 유행 선도' },
        { name: '클래식 정OO', avatar: '🎭', similarity: 76, description: '전통적 가치, 깊이 있는 사고' }
      ];

      // 성향에 따라 유사도 조정
      return profiles.map(profile => ({
        ...profile,
        similarity: Math.max(60, Math.min(95, profile.similarity + Math.random() * 10 - 5))
      })).sort((a, b) => b.similarity - a.similarity).slice(0, 3);
    }

    generateGrowthPath(personality, stats) {
      const steps = [];
      
      steps.push({
        number: 1,
        title: '현재 상태 파악',
        description: `총 ${stats.totalTests || 0}회 테스트를 통해 자신의 성향을 파악했습니다. 이제 다음 단계로 나아갈 시간이에요!`
      });

      if (personality.decisionSpeed === 'fast') {
        steps.push({
          number: 2,
          title: '신중함 기르기',
          description: '빠른 판단력에 신중함을 더하면 더욱 완성도 높은 결정을 내릴 수 있습니다. 중요한 선택 전 10초만 더 생각해보세요.'
        });
      } else {
        steps.push({
          number: 2,
          title: '결정력 키우기',
          description: '신중함에 결단력을 더해보세요. 작은 선택부터 빠르게 결정하는 연습을 통해 자신감을 키울 수 있어요.'
        });
      }

      steps.push({
        number: 3,
        title: '새로운 영역 탐색',
        description: '지금까지 시도하지 않았던 새로운 분야에 도전해보세요. 다양한 경험이 더 풍부한 내면을 만들어 줄 것입니다.'
      });

      steps.push({
        number: 4,
        title: '균형점 찾기',
        description: '자신만의 독특한 밸런스를 찾아보세요. 강점을 더욱 발전시키면서도 약점을 보완하는 것이 중요해요.'
      });

      steps.push({
        number: 5,
        title: '영향력 확장',
        description: '성장한 자신을 바탕으로 다른 사람들에게도 긍정적인 영향을 미쳐보세요. 리더십과 멘토링 능력을 발휘할 때입니다.'
      });

      return steps;
    }

    loadInsights() {
      const container = document.getElementById('personalInsights');
      const insights = this.recommendations.insights || [];

      const html = insights.map(insight => `
        <div class="insight-card" style="border-left: 4px solid ${insight.color}">
          <div class="insight-title">
            ${insight.title}
          </div>
          <div class="insight-description">
            ${insight.description}
          </div>
          <div class="insight-score">${insight.score}</div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="insight-card"><div class="insight-description">더 많은 테스트를 통해 개인화된 인사이트를 받아보세요!</div></div>';
    }

    loadRecommendedActions() {
      const container = document.getElementById('recommendedActions');
      const actions = this.recommendations.actions || [];

      const html = actions.map(action => `
        <div class="action-item">
          <div class="action-title">${action.title}</div>
          <div class="action-description">${action.description}</div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="action-item"><div class="action-description">개인 맞춤 추천을 위해 더 많은 데이터가 필요해요!</div></div>';
    }

    loadSimilarUsers() {
      const container = document.getElementById('similarUsers');
      const similar = this.recommendations.similar || [];

      const html = similar.map(user => `
        <div class="similarity-user">
          <div class="similarity-avatar">${user.avatar}</div>
          <div class="similarity-info">
            <div class="similarity-name">${user.name}</div>
            <div class="similarity-stats">${user.description}</div>
          </div>
          <div class="similarity-score">${Math.round(user.similarity)}% 유사</div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="similarity-user"><div class="similarity-info"><div class="similarity-stats">유사한 사용자를 찾는 중...</div></div></div>';
    }

    loadGrowthPath() {
      const container = document.getElementById('growthPath');
      const steps = this.recommendations.growth || [];

      const html = steps.map(step => `
        <div class="growth-step">
          <div class="growth-step-number">${step.number}</div>
          <div class="growth-step-title">${step.title}</div>
          <div class="growth-step-description">${step.description}</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${step.number === 1 ? '100%' : '0%'}"></div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="growth-step"><div class="growth-step-description">성장 경로를 분석하는 중...</div></div>';

      // 프로그레스 바 애니메이션
      setTimeout(() => {
        const progressBars = container.querySelectorAll('.progress-fill');
        progressBars.forEach((bar, index) => {
          if (index < 2) { // 처음 2단계는 진행된 것으로 표시
            setTimeout(() => {
              bar.style.width = '100%';
            }, index * 200);
          }
        });
      }, 500);
    }

    updateUserProfile() {
      // 프로필 업데이트 시뮬레이션
      if (typeof showQuickToast === 'function') {
        showQuickToast('🔄 프로필이 업데이트되었습니다!');
      }
      
      // 새로운 분석 실행
      this.analyzeUserBehavior();
      this.generatePersonalizedRecommendations();
      
      // 현재 활성 탭 새로고침
      const activeTab = document.querySelector('.rec-tab-btn.active');
      if (activeTab) {
        const tabName = activeTab.getAttribute('data-tab');
        switch(tabName) {
          case 'insights': this.loadInsights(); break;
          case 'actions': this.loadRecommendedActions(); break;
          case 'similar': this.loadSimilarUsers(); break;
          case 'growth': this.loadGrowthPath(); break;
        }
      }
    }

    // 결과 기록 시 호출되는 메서드
    recordTestResult(resultKey, score, answers) {
      this.userProfile.testHistory.push({
        result: resultKey,
        score: score,
        answers: answers,
        timestamp: Date.now()
      });

      // 최대 20개 기록만 유지
      if (this.userProfile.testHistory.length > 20) {
        this.userProfile.testHistory = this.userProfile.testHistory.slice(-20);
      }

      localStorage.setItem(this.analysisKey, JSON.stringify(this.userProfile));
    }
  }

  // 개인화 추천 시스템 초기화
  window.personalizedRecommendation = new PersonalizedRecommendation();

  // ========== 고급 데이터 시각화와 인사이트 시스템 ==========
  
  class DataVisualization {
    constructor() {
      this.storageKey = 'ageVibeAnalytics';
      this.chartData = {};
      this.insights = [];
      this.init();
    }

    init() {
      this.createVisualizationUI();
      this.bindEvents();
      this.initializeCharts();
    }

    createVisualizationUI() {
      // 버튼은 이미 HTML에 통합되어 있음

      // 데이터 분석 모달 창 생성
      if (!document.getElementById('analyticsModal')) {
        const modal = document.createElement('div');
        modal.id = 'analyticsModal';
        modal.className = 'analytics-modal';
        modal.innerHTML = `
          <div class="analytics-content">
            <div class="analytics-header">
              <h2>📊 데이터 인사이트 대시보드</h2>
              <span class="analytics-close">&times;</span>
            </div>
            
            <div class="analytics-tabs">
              <button class="analytics-tab-btn active" data-tab="overview">📈 개요</button>
              <button class="analytics-tab-btn" data-tab="trends">📊 트렌드</button>
              <button class="analytics-tab-btn" data-tab="patterns">🔍 패턴</button>
              <button class="analytics-tab-btn" data-tab="insights">💡 인사이트</button>
              <button class="analytics-tab-btn" data-tab="predictions">🔮 예측</button>
            </div>
            
            <div class="analytics-body">
              <div id="overviewTab" class="analytics-tab-content active">
                <div class="metrics-grid">
                  <div class="metric-card" id="totalTestsMetric">
                    <div class="metric-icon">🎯</div>
                    <div class="metric-value">0</div>
                    <div class="metric-label">총 테스트 수</div>
                    <div class="metric-change">+0%</div>
                  </div>
                  <div class="metric-card" id="avgScoreMetric">
                    <div class="metric-icon">⭐</div>
                    <div class="metric-value">0</div>
                    <div class="metric-label">평균 점수</div>
                    <div class="metric-change">+0%</div>
                  </div>
                  <div class="metric-card" id="streakMetric">
                    <div class="metric-icon">🔥</div>
                    <div class="metric-value">0</div>
                    <div class="metric-label">연속 일수</div>
                    <div class="metric-change">+0일</div>
                  </div>
                  <div class="metric-card" id="consistencyMetric">
                    <div class="metric-icon">🎪</div>
                    <div class="metric-value">0%</div>
                    <div class="metric-label">일관성</div>
                    <div class="metric-change">+0%</div>
                  </div>
                </div>
                <div class="chart-container">
                  <canvas id="overviewChart" width="800" height="400"></canvas>
                </div>
              </div>
              
              <div id="trendsTab" class="analytics-tab-content">
                <div class="trend-analysis">
                  <div class="trend-chart-container">
                    <h3>📈 시간별 패턴 분석</h3>
                    <canvas id="timePatternChart" width="800" height="300"></canvas>
                  </div>
                  <div class="trend-chart-container">
                    <h3>📊 결과 분포 변화</h3>
                    <canvas id="resultTrendChart" width="800" height="300"></canvas>
                  </div>
                </div>
              </div>
              
              <div id="patternsTab" class="analytics-tab-content">
                <div class="pattern-analysis">
                  <div class="pattern-section">
                    <h3>🧠 행동 패턴 분석</h3>
                    <canvas id="behaviorChart" width="400" height="400"></canvas>
                  </div>
                  <div class="pattern-section">
                    <h3>⚡ 반응 속도 분석</h3>
                    <canvas id="speedChart" width="400" height="400"></canvas>
                  </div>
                </div>
              </div>
              
              <div id="insightsTab" class="analytics-tab-content">
                <div id="dynamicInsights"></div>
              </div>
              
              <div id="predictionsTab" class="analytics-tab-content">
                <div id="predictionResults"></div>
              </div>
            </div>
            
            <div class="analytics-footer">
              <button id="exportDataBtn" class="export-btn">📤 데이터 내보내기</button>
              <button id="shareInsightsBtn" class="share-insights-btn">🔗 인사이트 공유</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // 데이터 시각화 스타일 추가
      if (!document.getElementById('analytics-styles')) {
        const style = document.createElement('style');
        style.id = 'analytics-styles';
        style.textContent = `
          .analytics-modal {
            display: none;
            position: fixed;
            z-index: 10002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
          }

          .analytics-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 1% auto;
            padding: 0;
            border-radius: 30px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 30px 100px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease;
            border: 1px solid rgba(255,255,255,0.1);
          }

          .analytics-header {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 30px 30px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
          }

          .analytics-header h2 {
            color: #4fc3f7;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 15px rgba(79, 195, 247, 0.3);
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
          }

          .analytics-close {
            color: #4fc3f7;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
            background: rgba(79, 195, 247, 0.1);
          }

          .analytics-close:hover {
            background: rgba(79, 195, 247, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.3);
          }

          .analytics-tabs {
            display: flex;
            padding: 0 25px;
            background: rgba(255,255,255,0.05);
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255,255,255,0.1);
          }

          .analytics-tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 18px 12px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin: 0 2px;
            position: relative;
          }

          .analytics-tab-btn.active,
          .analytics-tab-btn:hover {
            color: #4fc3f7;
            border-bottom-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.2);
          }

          .analytics-body {
            padding: 30px;
            min-height: 500px;
            background: rgba(255,255,255,0.02);
          }

          .analytics-tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
          }

          .analytics-tab-content.active {
            display: block;
          }

          .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
          }

          .metric-card {
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1) 0%, rgba(41, 182, 246, 0.05) 100%);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(79, 195, 247, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          }

          .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 195, 247, 0.1), transparent);
            transition: left 0.5s ease;
          }

          .metric-card:hover::before {
            left: 100%;
          }

          .metric-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(79, 195, 247, 0.2);
            border-color: rgba(79, 195, 247, 0.4);
          }

          .metric-icon {
            font-size: 36px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px rgba(79, 195, 247, 0.3));
          }

          .metric-value {
            font-size: 32px;
            font-weight: 800;
            color: #4fc3f7;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
          }

          .metric-label {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 8px;
            font-weight: 600;
          }

          .metric-change {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            color: white;
            display: inline-block;
          }

          .metric-change.negative {
            background: linear-gradient(90deg, #f44336, #ef5350);
          }

          .chart-container {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
          }

          .trend-analysis {
            display: flex;
            flex-direction: column;
            gap: 30px;
          }

          .trend-chart-container {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
          }

          .trend-chart-container h3 {
            color: #4fc3f7;
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
          }

          .pattern-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
          }

          .pattern-section {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            text-align: center;
          }

          .pattern-section h3 {
            color: #4fc3f7;
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 700;
          }

          .insight-item {
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1) 0%, rgba(41, 182, 246, 0.05) 100%);
            margin: 15px 0;
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
          }

          .insight-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(79, 195, 247, 0.2);
            border-color: rgba(79, 195, 247, 0.4);
          }

          .insight-title {
            font-size: 20px;
            font-weight: 700;
            color: #4fc3f7;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
          }

          .insight-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.7;
            font-size: 15px;
            margin-bottom: 15px;
          }

          .insight-confidence {
            display: inline-block;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            color: #0d1421;
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
          }

          .prediction-card {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(123, 31, 162, 0.05) 100%);
            margin: 15px 0;
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(156, 39, 176, 0.3);
            backdrop-filter: blur(10px);
          }

          .prediction-title {
            font-size: 20px;
            font-weight: 700;
            color: #ba68c8;
            margin-bottom: 12px;
          }

          .prediction-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.7;
            margin-bottom: 15px;
          }

          .prediction-probability {
            display: inline-block;
            background: linear-gradient(90deg, #9c27b0, #7b1fa2);
            color: white;
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
          }

          .analytics-footer {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 0 0 30px 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid rgba(255,255,255,0.1);
          }

          .export-btn,
          .share-insights-btn {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: #0d1421;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(79, 195, 247, 0.3);
          }

          .share-insights-btn {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            box-shadow: 0 4px 20px rgba(156, 39, 176, 0.3);
          }

          .export-btn:hover,
          .share-insights-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 30px rgba(79, 195, 247, 0.4);
          }

          .share-insights-btn:hover {
            box-shadow: 0 8px 30px rgba(156, 39, 176, 0.4);
          }

          @media (max-width: 768px) {
            .analytics-content {
              margin: 0;
              width: 100%;
              max-height: 100vh;
              border-radius: 0;
            }
            
            .metrics-grid {
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .pattern-analysis {
              grid-template-columns: 1fr;
            }
            
            .analytics-tab-btn {
              min-width: 90px;
              font-size: 12px;
            }
            
            .analytics-footer {
              flex-direction: column;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    bindEvents() {
      // 분석 버튼 이벤트
      const analyticsBtn = document.getElementById('analyticsBtn');
      if (analyticsBtn && !analyticsBtn.hasAttribute('data-bound')) {
        analyticsBtn.setAttribute('data-bound', 'true');
        analyticsBtn.addEventListener('click', () => {
          this.showAnalytics();
          if (typeof playSound === 'function') playSound('success');
        });
      }

      // 모달 닫기 이벤트
      const modal = document.getElementById('analyticsModal');
      if (modal) {
        const closeBtn = modal.querySelector('.analytics-close');
        if (closeBtn && !closeBtn.hasAttribute('data-bound')) {
          closeBtn.setAttribute('data-bound', 'true');
          closeBtn.addEventListener('click', () => {
            this.hideAnalytics();
          });
        }

        if (!modal.hasAttribute('data-bound')) {
          modal.setAttribute('data-bound', 'true');
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              this.hideAnalytics();
            }
          });
        }

        // 탭 전환 이벤트
        const tabBtns = modal.querySelectorAll('.analytics-tab-btn');
        tabBtns.forEach(btn => {
          if (!btn.hasAttribute('data-bound')) {
            btn.setAttribute('data-bound', 'true');
            btn.addEventListener('click', () => {
              const tab = btn.getAttribute('data-tab');
              this.switchAnalyticsTab(tab);
              if (typeof playSound === 'function') playSound('click');
            });
          }
        });

        // 데이터 내보내기 버튼
        const exportBtn = modal.querySelector('#exportDataBtn');
        if (exportBtn && !exportBtn.hasAttribute('data-bound')) {
          exportBtn.setAttribute('data-bound', 'true');
          exportBtn.addEventListener('click', () => {
            this.exportData();
            if (typeof playSound === 'function') playSound('success');
          });
        }

        // 인사이트 공유 버튼
        const shareBtn = modal.querySelector('#shareInsightsBtn');
        if (shareBtn && !shareBtn.hasAttribute('data-bound')) {
          shareBtn.setAttribute('data-bound', 'true');
          shareBtn.addEventListener('click', () => {
            this.shareInsights();
            if (typeof playSound === 'function') playSound('success');
          });
        }
      }
    }

    showAnalytics() {
      const modal = document.getElementById('analyticsModal');
      modal.style.display = 'block';
      
      // 데이터 수집 및 분석
      this.collectData();
      this.generateInsights();
      
      // 각 탭 내용 로드
      this.loadOverview();
      this.loadTrends();
      this.loadPatterns();
      this.loadInsights();
      this.loadPredictions();
    }

    hideAnalytics() {
      const modal = document.getElementById('analyticsModal');
      modal.style.display = 'none';
    }

    switchAnalyticsTab(tabName) {
      // 탭 버튼 활성화
      const tabBtns = document.querySelectorAll('.analytics-tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });

      // 탭 내용 표시
      const tabContents = document.querySelectorAll('.analytics-tab-content');
      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === tabName + 'Tab');
      });

      // 탭별 차트 다시 그리기
      setTimeout(() => {
        switch(tabName) {
          case 'overview': this.drawOverviewChart(); break;
          case 'trends': this.drawTrendCharts(); break;
          case 'patterns': this.drawPatternCharts(); break;
        }
      }, 100);
    }

    collectData() {
      const stats = typeof getStats === 'function' ? getStats() : {};
      const userProfile = window.personalizedRecommendation ? 
        window.personalizedRecommendation.userProfile : {};
      const emotionData = emotionAnalyzer || {};

      this.chartData = {
        basic: {
          totalTests: stats.totalTests || 0,
          avgScore: stats.averageScore || 0,
          streak: stats.streak || 0,
          resultCounts: stats.resultCounts || {}
        },
        behavior: {
          clickTiming: emotionData.clickTiming || [],
          hoverPatterns: emotionData.hoverPatterns || [],
          decisionSpeed: userProfile.personality?.decisionSpeed || 'moderate'
        },
        time: {
          favoriteTimes: userProfile.interactions?.favoriteTimes || [],
          deviceUsage: userProfile.interactions?.deviceUsage || {}
        },
        history: userProfile.testHistory || []
      };
    }

    generateInsights() {
      const data = this.chartData;
      this.insights = [];

      // 테스트 빈도 인사이트
      if (data.basic.totalTests > 5) {
        this.insights.push({
          title: '🏆 활발한 테스터',
          description: `총 ${data.basic.totalTests}회의 테스트를 완료했습니다. 지속적인 자기 탐구 노력이 인상적이에요!`,
          confidence: '높음'
        });
      }

      // 점수 트렌드 인사이트
      if (data.basic.avgScore > 75) {
        this.insights.push({
          title: '⭐ 높은 감성 지수',
          description: `평균 ${data.basic.avgScore}점으로 매우 높은 감성 지수를 보입니다. 감정 인식과 표현 능력이 뛰어나네요.`,
          confidence: '매우 높음'
        });
      }

      // 일관성 인사이트
      const consistency = this.calculateConsistency(data.basic.resultCounts);
      if (consistency > 60) {
        this.insights.push({
          title: '🎯 일관된 성향',
          description: `${consistency}%의 일관성을 보입니다. 자신의 정체성이 명확하고 안정적인 성격이에요.`,
          confidence: '높음'
        });
      }

      // 행동 패턴 인사이트
      if (data.behavior.clickTiming.length > 0) {
        const avgTime = data.behavior.clickTiming.reduce((a, b) => a + b) / data.behavior.clickTiming.length;
        if (avgTime < 2000) {
          this.insights.push({
            title: '⚡ 빠른 의사결정자',
            description: `평균 ${(avgTime / 1000).toFixed(1)}초의 빠른 결정을 내립니다. 직감적이고 행동 지향적인 성향을 보여요.`,
            confidence: '높음'
          });
        } else if (avgTime > 8000) {
          this.insights.push({
            title: '🤔 신중한 분석가',
            description: `평균 ${(avgTime / 1000).toFixed(1)}초의 충분한 고민 시간을 가집니다. 신중하고 분석적인 사고방식을 가지고 있어요.`,
            confidence: '높음'
          });
        }
      }

      // 시간대 패턴 인사이트
      if (data.time.favoriteTimes.length > 3) {
        const hourCounts = {};
        data.time.favoriteTimes.forEach(hour => {
          hourCounts[hour] = (hourCounts[hour] || 0) + 1;
        });
        const favoriteHour = Object.keys(hourCounts).reduce((a, b) => 
          hourCounts[a] > hourCounts[b] ? a : b
        );
        
        let timeDescription;
        if (favoriteHour >= 6 && favoriteHour < 12) {
          timeDescription = '아침형 인간으로 활기찬 시작을 선호합니다.';
        } else if (favoriteHour >= 12 && favoriteHour < 18) {
          timeDescription = '오후에 가장 활발한 활동을 보입니다.';
        } else if (favoriteHour >= 18 && favoriteHour < 22) {
          timeDescription = '저녁 시간을 활용한 자기계발을 선호합니다.';
        } else {
          timeDescription = '야간 활동을 즐기는 올빼미 타입입니다.';
        }
        
        this.insights.push({
          title: '⏰ 시간대 선호 패턴',
          description: `주로 ${favoriteHour}시경에 테스트를 진행합니다. ${timeDescription}`,
          confidence: '보통'
        });
      }
    }

    calculateConsistency(resultCounts) {
      if (!resultCounts || Object.keys(resultCounts).length === 0) return 0;
      
      const total = Object.values(resultCounts).reduce((a, b) => a + b, 0);
      if (total === 0) return 0;
      
      const maxCount = Math.max(...Object.values(resultCounts));
      return Math.round((maxCount / total) * 100);
    }

    loadOverview() {
      // 메트릭 카드 업데이트
      const data = this.chartData;
      const consistency = this.calculateConsistency(data.basic.resultCounts);
      
      document.querySelector('#totalTestsMetric .metric-value').textContent = data.basic.totalTests;
      document.querySelector('#avgScoreMetric .metric-value').textContent = data.basic.avgScore;
      document.querySelector('#streakMetric .metric-value').textContent = data.basic.streak;
      document.querySelector('#consistencyMetric .metric-value').textContent = consistency + '%';
      
      // 변화율 계산 (시뮬레이션)
      const changes = ['+12%', '+8%', '+3일', '+5%'];
      document.querySelectorAll('.metric-change').forEach((el, index) => {
        el.textContent = changes[index] || '+0%';
      });
      
      // 개요 차트 그리기
      setTimeout(() => this.drawOverviewChart(), 100);
    }

    loadTrends() {
      setTimeout(() => this.drawTrendCharts(), 100);
    }

    loadPatterns() {
      setTimeout(() => this.drawPatternCharts(), 100);
    }

    loadInsights() {
      const container = document.getElementById('dynamicInsights');
      const html = this.insights.map(insight => `
        <div class="insight-item">
          <div class="insight-title">${insight.title}</div>
          <div class="insight-description">${insight.description}</div>
          <div class="insight-confidence">신뢰도: ${insight.confidence}</div>
        </div>
      `).join('');
      
      container.innerHTML = html || '<div class="insight-item"><div class="insight-description">더 많은 데이터로 상세한 인사이트를 제공할 예정입니다!</div></div>';
    }

    loadPredictions() {
      const container = document.getElementById('predictionResults');
      const predictions = this.generatePredictions();
      
      const html = predictions.map(pred => `
        <div class="prediction-card">
          <div class="prediction-title">${pred.title}</div>
          <div class="prediction-description">${pred.description}</div>
          <div class="prediction-probability">예측 확률: ${pred.probability}%</div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    generatePredictions() {
      const data = this.chartData;
      const predictions = [];
      
      // 다음 결과 예측
      if (data.basic.totalTests > 2) {
        const mostCommon = Object.keys(data.basic.resultCounts).reduce((a, b) => 
          data.basic.resultCounts[a] > data.basic.resultCounts[b] ? a : b
        );
        
        predictions.push({
          title: '🔮 다음 테스트 결과 예측',
          description: `과거 패턴을 분석한 결과, 다음 테스트에서도 "${mostCommon}" 결과가 나올 가능성이 높습니다.`,
          probability: 68
        });
      }
      
      // 성장 가능성 예측
      if (data.basic.avgScore > 60) {
        predictions.push({
          title: '📈 감성 지수 성장 예측',
          description: '현재의 학습 패턴을 유지한다면, 3개월 내에 감성 지수가 10-15점 향상될 것으로 예측됩니다.',
          probability: 75
        });
      }
      
      // 일관성 변화 예측
      const consistency = this.calculateConsistency(data.basic.resultCounts);
      if (consistency > 50) {
        predictions.push({
          title: '🎯 성향 안정화 예측',
          description: '높은 일관성을 보이고 있어, 앞으로도 안정적인 성향을 유지할 가능성이 높습니다.',
          probability: 82
        });
      }
      
      return predictions;
    }

    drawOverviewChart() {
      const canvas = document.getElementById('overviewChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const data = this.chartData.basic.resultCounts;
      
      // 캔버스 초기화
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (Object.keys(data).length === 0) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('데이터를 수집 중입니다...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // 도넛 차트 그리기
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 50;
      const innerRadius = radius * 0.6;
      
      const colors = ['#4fc3f7', '#29b6f6', '#0288d1', '#0277bd'];
      const labels = {
        teen: '10대 감성',
        twenties: '20대 감성', 
        thirties: '30대 감성',
        forties: '40대 감성'
      };
      
      let total = Object.values(data).reduce((a, b) => a + b, 0);
      let currentAngle = -Math.PI / 2;
      
      Object.entries(data).forEach(([key, value], index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        
        // 외부 원호
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();
        
        const gradient = ctx.createRadialGradient(centerX, centerY, innerRadius, centerX, centerY, radius);
        gradient.addColorStop(0, colors[index % colors.length] + '80');
        gradient.addColorStop(1, colors[index % colors.length]);
        
        ctx.fillStyle = gradient;
        ctx.fill();
        
        // 라벨
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
        const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
        
        ctx.fillStyle = '#4fc3f7';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(labels[key] || key, labelX, labelY);
        ctx.fillText(`${value}회`, labelX, labelY + 15);
        
        currentAngle += sliceAngle;
      });
      
      // 중앙 텍스트
      ctx.fillStyle = '#4fc3f7';
      ctx.font = 'bold 24px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('총 테스트', centerX, centerY - 10);
      ctx.fillText(`${total}회`, centerX, centerY + 20);
    }

    drawTrendCharts() {
      this.drawTimePatternChart();
      this.drawResultTrendChart();
    }

    drawTimePatternChart() {
      const canvas = document.getElementById('timePatternChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const times = this.chartData.time.favoriteTimes;
      if (times.length === 0) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('시간대별 데이터를 수집 중입니다...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // 시간대별 빈도 계산
      const hourCounts = Array(24).fill(0);
      times.forEach(hour => {
        hourCounts[hour]++;
      });
      
      const maxCount = Math.max(...hourCounts);
      const barWidth = canvas.width / 24;
      const maxHeight = canvas.height - 60;
      
      // 막대 그래프 그리기
      hourCounts.forEach((count, hour) => {
        const barHeight = (count / maxCount) * maxHeight;
        const x = hour * barWidth;
        const y = canvas.height - barHeight - 30;
        
        const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
        gradient.addColorStop(0, '#4fc3f7');
        gradient.addColorStop(1, '#29b6f6');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth - 2, barHeight);
        
        // 시간 라벨
        if (hour % 4 === 0) {
          ctx.fillStyle = '#4fc3f7';
          ctx.font = '12px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(`${hour}시`, x + barWidth/2, canvas.height - 5);
        }
      });
    }

    drawResultTrendChart() {
      const canvas = document.getElementById('resultTrendChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const history = this.chartData.history;
      if (history.length < 2) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('트렌드 분석을 위해 더 많은 데이터가 필요합니다...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // 점수 변화 그래프 그리기
      const maxScore = 100;
      const stepX = canvas.width / (history.length - 1);
      const stepY = (canvas.height - 60) / maxScore;
      
      ctx.strokeStyle = '#4fc3f7';
      ctx.lineWidth = 3;
      ctx.beginPath();
      
      history.forEach((test, index) => {
        const x = index * stepX;
        const y = canvas.height - 30 - (test.score * stepY);
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        // 점 그리기
        ctx.save();
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#29b6f6';
        ctx.fill();
        ctx.restore();
      });
      
      ctx.stroke();
    }

    drawPatternCharts() {
      this.drawBehaviorChart();
      this.drawSpeedChart();
    }

    drawBehaviorChart() {
      const canvas = document.getElementById('behaviorChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 행동 패턴 레이더 차트
      const behaviors = {
        '직관적': Math.random() * 100,
        '분석적': Math.random() * 100,
        '신중함': Math.random() * 100,
        '모험적': Math.random() * 100,
        '안정적': Math.random() * 100
      };
      
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 50;
      const angleStep = (2 * Math.PI) / Object.keys(behaviors).length;
      
      // 격자 그리기
      for (let i = 1; i <= 5; i++) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, (radius * i) / 5, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(79, 195, 247, 0.2)';
        ctx.stroke();
      }
      
      // 축 그리기
      Object.keys(behaviors).forEach((label, index) => {
        const angle = index * angleStep - Math.PI / 2;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = 'rgba(79, 195, 247, 0.3)';
        ctx.stroke();
        
        // 라벨
        const labelX = centerX + Math.cos(angle) * (radius + 20);
        const labelY = centerY + Math.sin(angle) * (radius + 20);
        ctx.fillStyle = '#4fc3f7';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label, labelX, labelY);
      });
      
      // 데이터 영역 그리기
      ctx.beginPath();
      Object.values(behaviors).forEach((value, index) => {
        const angle = index * angleStep - Math.PI / 2;
        const distance = (value / 100) * radius;
        const x = centerX + Math.cos(angle) * distance;
        const y = centerY + Math.sin(angle) * distance;
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.closePath();
      
      ctx.fillStyle = 'rgba(79, 195, 247, 0.2)';
      ctx.fill();
      ctx.strokeStyle = '#4fc3f7';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    drawSpeedChart() {
      const canvas = document.getElementById('speedChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const timings = this.chartData.behavior.clickTiming;
      if (timings.length === 0) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('반응 속도 데이터를 수집 중입니다...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // 히스토그램 그리기
      const buckets = [0, 2000, 5000, 8000, 15000]; // ms 단위
      const bucketCounts = Array(buckets.length - 1).fill(0);
      
      timings.forEach(timing => {
        for (let i = 0; i < buckets.length - 1; i++) {
          if (timing >= buckets[i] && timing < buckets[i + 1]) {
            bucketCounts[i]++;
            break;
          }
        }
      });
      
      const maxCount = Math.max(...bucketCounts);
      const barWidth = canvas.width / bucketCounts.length;
      const maxHeight = canvas.height - 60;
      
      bucketCounts.forEach((count, index) => {
        const barHeight = (count / maxCount) * maxHeight;
        const x = index * barWidth;
        const y = canvas.height - barHeight - 30;
        
        const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
        gradient.addColorStop(0, '#9c27b0');
        gradient.addColorStop(1, '#7b1fa2');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x + 10, y, barWidth - 20, barHeight);
        
        // 라벨
        ctx.fillStyle = '#ba68c8';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        const label = `${buckets[index]/1000}s`;
        ctx.fillText(label, x + barWidth/2, canvas.height - 5);
      });
    }

    exportData() {
      const data = {
        timestamp: new Date().toISOString(),
        basic: this.chartData.basic,
        insights: this.insights,
        predictions: this.generatePredictions()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'age-vibe-analytics.json';
      a.click();
      URL.revokeObjectURL(url);
      
      if (typeof showQuickToast === 'function') {
        showQuickToast('📊 분석 데이터가 다운로드되었습니다!');
      }
    }

    shareInsights() {
      const bestInsight = this.insights[0];
      if (!bestInsight) {
        if (typeof showQuickToast === 'function') {
          showQuickToast('📊 공유할 인사이트를 생성 중입니다...');
        }
        return;
      }
      
      const shareText = `🧠 나의 감성 연령 인사이트: ${bestInsight.title}\n${bestInsight.description}\n\n#감성연령 #데이터분석 #자기계발`;
      
      if (navigator.share) {
        navigator.share({
          title: '감성 연령 인사이트',
          text: shareText
        });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText).then(() => {
          if (typeof showQuickToast === 'function') {
            showQuickToast('📋 인사이트가 클립보드에 복사되었습니다!');
          }
        });
      }
    }

    initializeCharts() {
      // 초기 차트 설정 (필요시)
    }
  }

  // 데이터 시각화 시스템 초기화
  window.dataVisualization = new DataVisualization();

  // ========== 통합 UI 레이아웃 관리 시스템 ==========
  
  class UILayoutManager {
    constructor() {
      this.init();
    }

    init() {
      this.setupFeatureToggle();
      this.handleResponsiveLayout();
    }

    setupFeatureToggle() {
      // 고급 기능 보기/숨기기 토글
      const showFeaturesBtn = document.querySelector('#showFeatures .toggle-btn');
      const hideFeaturesBtn = document.querySelector('#toggleFeatures .toggle-btn');
      const advancedFeatures = document.getElementById('advancedFeatures');
      const showFeatures = document.getElementById('showFeatures');

      if (showFeaturesBtn && hideFeaturesBtn) {
        showFeaturesBtn.addEventListener('click', () => {
          advancedFeatures.style.display = 'block';
          showFeatures.style.display = 'none';
          if (typeof playSound === 'function') playSound('whoosh');
        });

        hideFeaturesBtn.addEventListener('click', () => {
          advancedFeatures.style.display = 'none';
          showFeatures.style.display = 'block';
          if (typeof playSound === 'function') playSound('click');
        });
      }

      // 테스트 완료 후 고급 기능 자동 표시
      const originalShowResult = window.showResult;
      if (originalShowResult) {
        window.showResult = function() {
          const result = originalShowResult.apply(this, arguments);
          
          // 1초 후 고급 기능 표시
          setTimeout(() => {
            if (showFeatures.style.display !== 'none') {
              showFeaturesBtn.click();
              showQuickToast('✨ 새로운 고급 기능을 확인해보세요!');
            }
          }, 1000);
          
          return result;
        };
      }
    }

    handleResponsiveLayout() {
      // 반응형 레이아웃 처리
      const handleResize = () => {
        const width = window.innerWidth;
        const featureGrid = document.querySelector('.feature-grid');
        
        if (width < 768 && featureGrid) {
          featureGrid.style.gridTemplateColumns = '1fr';
        } else if (width < 1024 && featureGrid) {
          featureGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        }
      };

      window.addEventListener('resize', handleResize);
      handleResize(); // 초기 실행
    }

    // 기능별 사용 통계 추적
    trackFeatureUsage(feature) {
      const stats = JSON.parse(localStorage.getItem('featureUsageStats') || '{}');
      stats[feature] = (stats[feature] || 0) + 1;
      localStorage.setItem('featureUsageStats', JSON.stringify(stats));
      
      // 사용 빈도에 따른 레이아웃 최적화
      this.optimizeLayout(stats);
    }

    optimizeLayout(stats) {
      // 자주 사용되는 기능을 앞에 배치 (추후 구현)
      const mostUsed = Object.entries(stats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3);
      
      // 향후 동적 레이아웃 재배치 로직 추가 가능
    }

    // 접근성 개선
    enhanceAccessibility() {
      // 키보드 네비게이션 지원
      const featureBtns = document.querySelectorAll('.feature-btn');
      featureBtns.forEach((btn, index) => {
        btn.setAttribute('tabindex', '0');
        btn.setAttribute('role', 'button');
        
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            btn.click();
          }
        });
      });
    }
  }

  // UI 레이아웃 관리자 초기화
  window.uiLayoutManager = new UILayoutManager();

  // 기존 showResult 함수를 래핑하여 랭킹 기록 추가
  if (typeof showResult !== 'undefined') {
    const originalShowResult = showResult;
    showResult = function() {
      const result = originalShowResult.apply(this, arguments);
      
      // 결과가 표시된 후 랭킹에 기록
      setTimeout(() => {
        if (typeof resultKey !== 'undefined' && typeof score !== 'undefined') {
          const currentResult = RESULTS.find(r => r.key === resultKey);
          if (currentResult) {
            // 사용자 이름 입력 (선택사항)
            const userName = localStorage.getItem('ageVibeUserName') || null;
            window.socialRanking.recordResult(userName, score, currentResult.title);
          }
        }
      }, 1000);
      
      return result;
    };
  }

  // 공유용 URL 파라미터가 있으면 자동으로 결과 미리보기 (선택)
  (function preloadFromQuery(){
    const p = new URLSearchParams(location.search);
    const key = p.get('result');
    const sc  = parseInt(p.get('score'), 10);
    if(!key || isNaN(sc)) return;
    const res = RESULTS.find(r=>r.key===key);
    if(!res) return;
    document.querySelector('.hero').classList.add('hidden');
    quizEl.classList.add('hidden');
    // 텍스트 채우기
    document.getElementById('resTitle').textContent = res.title;
    document.getElementById('resSub').textContent = res.sub;
    document.getElementById('scoreBox').textContent = `${clamp(sc,0,100)} / 100`;
    document.getElementById('resDesc').textContent = res.desc;
    setupShare(location.href, res.title);
    drawCard(res, clamp(sc,0,100));
    resultEl.classList.remove('hidden');
    resetBtn.classList.remove('hidden');
  })();
</script>
</body>
</html>
