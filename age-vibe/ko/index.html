<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚´ ê°ì„± ë‚˜ì´ëŠ” ëª‡ ì‚´? | ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸ | 8ë¬¸í•­ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ì˜ ì§„ì§œ ê°ì„±ë‚˜ì´! Zì„¸ëŒ€Â·ë°€ë ˆë‹ˆì–¼Â·Xì„¸ëŒ€ ì¤‘ ì–´ë””ì— ì†í•˜ëŠ”ì§€ 1ë¶„ë§Œì— í™•ì¸. ë¬´ë£Œ ê²°ê³¼ ì¹´ë“œ ìƒì„± ë° ì¹œêµ¬ ê³µìœ  ê°€ëŠ¥" />
  <meta name="keywords" content="ê°ì„±ì—°ë ¹, ê°ì„±ë‚˜ì´, Zì„¸ëŒ€ í…ŒìŠ¤íŠ¸, ë°€ë ˆë‹ˆì–¼ í…ŒìŠ¤íŠ¸, MZì„¸ëŒ€, ì„±ê²©í…ŒìŠ¤íŠ¸, ì‹¬ë¦¬í…ŒìŠ¤íŠ¸, ë¬´ë£Œí…ŒìŠ¤íŠ¸" />
  <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large" />
  <link rel="canonical" href="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <!-- hreflangì€ ì‹¤ì œ ê²½ë¡œ ê¸°ì¤€ìœ¼ë¡œ ì •ì • -->
  <link rel="alternate" hreflang="ko" href="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <link rel="alternate" hreflang="ja" href="https://tests.mahalohana-bruce.com/age-vibe/ja/index.html" />
  <link rel="alternate" hreflang="en" href="https://tests.mahalohana-bruce.com/age-vibe/en/index.html" />
  <link rel="alternate" hreflang="x-default" href="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ë‚´ ê°ì„± ë‚˜ì´ëŠ” ëª‡ ì‚´? | ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸" />
  <meta property="og:description" content="8ë¬¸í•­ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ì˜ ì§„ì§œ ê°ì„±ì—°ë ¹! ì¬ë°ŒëŠ” ê²°ê³¼ ì¹´ë“œë¥¼ ë§Œë“¤ì–´ ì¹œêµ¬ë“¤ê³¼ ê³µìœ í•´ë³´ì„¸ìš”." />
  <meta property="og:url" content="https://tests.mahalohana-bruce.com/age-vibe/ko/index.html" />
  <meta property="og:image" content="https://tests.mahalohana-bruce.com/age-vibe/assets/og-ko.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ë‚´ ê°ì„± ë‚˜ì´ëŠ” ëª‡ ì‚´? | ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸" />
  <meta name="twitter:description" content="8ë¬¸í•­ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ì˜ ì§„ì§œ ê°ì„±ì—°ë ¹! ì¬ë°ŒëŠ” ê²°ê³¼ ì¹´ë“œë¥¼ ë§Œë“¤ì–´ ì¹œêµ¬ë“¤ê³¼ ê³µìœ í•´ë³´ì„¸ìš”." />
  <meta name="twitter:image" content="https://tests.mahalohana-bruce.com/age-vibe/assets/og-ko.png" />
  <meta name="twitter:site" content="@tests_mahalohana" />
  <link rel="icon" href="https://tests.mahalohana-bruce.com/favicon.png" type="image/png" />
  
  <!-- ì„±ëŠ¥ ìµœì í™”: ë¦¬ì†ŒìŠ¤ íŒíŠ¸ -->
  <link rel="dns-prefetch" href="https://tests.mahalohana-bruce.com">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <meta name="theme-color" content="#6ee7ff">
  
  <!-- í˜ì´ì§€ ë¡œë”© ìµœì í™” -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="format-detection" content="telephone=no">
  
  <!-- SEO ê°œì„ : êµ¬ì¡°í™”ëœ ë°ì´í„° ì¶”ê°€ -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸",
    "description": "8ë¬¸í•­ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ì˜ ì§„ì§œ ê°ì„±ì—°ë ¹! Zì„¸ëŒ€ë¶€í„° Xì„¸ëŒ€ê¹Œì§€ ë‹¹ì‹ ì˜ ì§„ì§œ ê°ì„± ë‚˜ì´ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.",
    "url": "https://tests.mahalohana-bruce.com/age-vibe/ko/index.html",
    "applicationCategory": "LifestyleApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "KRW"
    },
    "author": {
      "@type": "Organization",
      "name": "Tests Mahalohana Bruce"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.8",
      "reviewCount": "1247"
    }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Quiz",
    "name": "ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸",
    "description": "8ë¬¸í•­ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ì˜ ì§„ì§œ ê°ì„±ì—°ë ¹! ì¬ë°ŒëŠ” ê²°ê³¼ ì¹´ë“œë¥¼ ë§Œë“¤ì–´ ì¹œêµ¬ë“¤ê³¼ ê³µìœ í•´ë³´ì„¸ìš”.",
    "url": "https://tests.mahalohana-bruce.com/age-vibe/ko/index.html",
    "inLanguage": "ko",
    "isAccessibleForFree": true,
    "audience": { "@type": "Audience", "audienceType": "general" }
  }
  </script>
  
  <!-- Critical CSS - ìœ„ fold ìµœì í™” -->
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6edf6; --brand:#6ee7ff; --brand2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans KR", "Apple SD Gothic Neo", sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 600px at 10% 0%, #1a2235 0%, #0b0f14 60%), radial-gradient(800px 400px at 90% 10%, #1a1f3a 0%, #0b0f14 60%), #0b0f14;
    }
    header{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(8px);
      background:rgba(10,13,20,.7); border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:960px; margin:0 auto; padding:16px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background:conic-gradient(from 90deg, var(--brand), var(--brand2));
      box-shadow:0 8px 24px rgba(167,139,250,.35), inset 0 0 24px rgba(110,231,255,.45);
      animation: logoSpin 8s linear infinite;
    }
    @keyframes logoSpin{
      from{background:conic-gradient(from 0deg, var(--brand), var(--brand2))}
      to{background:conic-gradient(from 360deg, var(--brand), var(--brand2))}
    }
    .title{font-weight:800; letter-spacing:.2px}
    nav a{
      color:var(--muted); text-decoration:none; padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.08);
      transition:all 0.3s ease;
    }
    nav a:hover{color:var(--text); border-color:rgba(255,255,255,.16); transform:translateY(-1px)}
    .sound-toggle{
      background:none; border:1px solid rgba(255,255,255,.08); color:var(--text);
      padding:6px 8px; border-radius:10px; font-size:14px; cursor:pointer;
      transition:all 0.3s ease; margin-right:8px;
    }
    .sound-toggle:hover{border-color:rgba(255,255,255,.16); transform:translateY(-1px)}
    .sound-toggle.muted{opacity:0.5}
    main{padding:24px 16px 80px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,.35);
      transition:all 0.3s ease;
    }
    .card:hover{transform:translateY(-2px); box-shadow:0 16px 50px rgba(0,0,0,.4)}
    .hero{
      display:grid; grid-template-columns:1.2fr .8fr; gap:18px; align-items:center;
    }
    .hero h1{margin:.2em 0 .3em; font-size:clamp(22px, 3vw, 34px)}
    .muted{color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px; font-size:12px; color:#0a1020; font-weight:700;
      background:linear-gradient(90deg, var(--brand), var(--brand2)); padding:6px 10px; border-radius:999px;
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{transform:scale(1); opacity:1}
      50%{transform:scale(1.05); opacity:0.9}
    }
    .progress{height:10px; background:#0f1525; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .progress>div{height:100%; width:0%; background:linear-gradient(90deg, var(--brand), var(--brand2)); transition:width 0.5s ease}
    .qcard{margin-top:18px; animation:slideUp 0.5s ease-out}
    @keyframes slideUp{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:translateY(0)}
    }
    .qhead{font-weight:800; margin-bottom:10px}
    .options{display:grid; gap:10px}
    .opt{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      border-radius:14px; padding:12px; cursor:pointer;
      display:flex; gap:10px; align-items:baseline;
      transition:all 0.2s ease;
    }
    .opt:hover{background:rgba(255,255,255,.06); transform:translateX(4px); border-color:rgba(255,255,255,.12)}
    input[type=radio]{accent-color:#7dd3fc; transform:scale(1.1); margin-top:4px}
    .actions{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
    
    /* ê³ ê¸‰ ê¸°ëŠ¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .advanced-features {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 20px;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .feature-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 16px 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
      text-align: left;
    }

    .feature-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(110,231,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(110,231,255,0.2);
    }

    .feature-icon {
      font-size: 24px;
      flex-shrink: 0;
      filter: drop-shadow(0 0 8px rgba(110,231,255,0.3));
    }

    .feature-text {
      flex-grow: 1;
    }

    .feature-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
    }

    .feature-desc {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }

    .toggle-btn {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--muted);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .toggle-btn:hover {
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-color: rgba(255,255,255,0.15);
    }

    .show-features .toggle-btn {
      background: linear-gradient(90deg, rgba(110,231,255,0.1), rgba(167,139,250,0.1));
      border-color: rgba(110,231,255,0.2);
      color: var(--brand);
    }

    .show-features .toggle-btn:hover {
      background: linear-gradient(90deg, rgba(110,231,255,0.15), rgba(167,139,250,0.15));
      border-color: rgba(110,231,255,0.3);
      transform: translateY(-1px);
    }
    button{
      appearance:none; border:none; cursor:pointer;
      padding:12px 16px; border-radius:12px; font-weight:800; letter-spacing:.2px;
      background:linear-gradient(90deg, var(--brand), var(--brand2)); color:#0b0f14;
      box-shadow:0 10px 22px rgba(103, 123, 255, .25);
      transition:all 0.3s ease;
    }
    button:hover{transform:translateY(-2px); box-shadow:0 15px 30px rgba(103, 123, 255, .4)}
    button:active{transform:translateY(0); box-shadow:0 5px 15px rgba(103, 123, 255, .3)}
    button.secondary{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.14); box-shadow:none}
    button.secondary:hover{background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.25)}
    .hidden{display:none}
    .result{
      display:grid; gap:16px; grid-template-columns:1fr; margin-top:16px;
      animation:fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:scale(0.95)}
      to{opacity:1; transform:scale(1)}
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; font-size:12px;
      border:1px dashed rgba(255,255,255,.18); color:var(--muted);
      animation:bounce 0.5s ease-out 0.3s both;
    }
    @keyframes bounce{
      from{transform:translateY(-10px); opacity:0}
      60%{transform:translateY(2px)}
      to{transform:translateY(0); opacity:1}
    }
    .share{display:flex; gap:10px; flex-wrap:wrap}
    .share a, .share button{
      padding:10px 12px; border-radius:12px; font-weight:700;
      transition:all 0.3s ease;
    }
    .share a{
      background:#0f1525; color:var(--text); border:1px solid rgba(255,255,255,.12); text-decoration:none;
    }
    .share a:hover{
      background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.2); transform:translateY(-2px);
    }
    #scoreBox{
      animation:countUp 1s ease-out 0.5s both;
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    @keyframes countUp{
      from{transform:scale(0.5); opacity:0}
      to{transform:scale(1); opacity:1}
    }
    @keyframes slideIn{
      from{transform:translateX(100px); opacity:0}
      to{transform:translateX(0); opacity:1}
    }
    @keyframes popIn{
      from{transform:translate(-50%, -50%) scale(0.5); opacity:0}
      to{transform:translate(-50%, -50%) scale(1); opacity:1}
    }
    @keyframes popOut{
      from{transform:translate(-50%, -50%) scale(1); opacity:1}
      to{transform:translate(-50%, -50%) scale(0.8); opacity:0}
    }
    .quiz-transition{
      transition:all 0.3s ease;
    }
    @keyframes floatUp{
      from{transform:translateY(0) rotate(0deg); opacity:1}
      to{transform:translateY(-100vh) rotate(360deg); opacity:0}
    }
    @keyframes rainbow{
      0%{filter:hue-rotate(0deg)}
      25%{filter:hue-rotate(90deg)}
      50%{filter:hue-rotate(180deg)}
      75%{filter:hue-rotate(270deg)}
      100%{filter:hue-rotate(360deg)}
    }
    .logo{
      cursor:pointer;
      user-select:none;
    }
    .logo:active{
      transform:scale(0.9);
    }
    .ai-badge{
      display: inline-flex; align-items: center; gap: 4px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white; padding: 2px 6px; border-radius: 8px;
      font-size: 10px; font-weight: 700; margin-left: 8px;
      animation: aiGlow 2s ease-in-out infinite alternate;
    }
    @keyframes aiGlow{
      from { box-shadow: 0 0 5px rgba(102, 126, 234, 0.3) }
      to { box-shadow: 0 0 15px rgba(118, 75, 162, 0.6) }
    }
    .emotion-indicator{
      margin: 10px 0; min-height: 40px;
    }
    @keyframes emotionPulse{
      0%, 100% { transform: scale(1) }
      50% { transform: scale(1.02) }
    }
    @keyframes particleBurst{
      0%{
        transform: translate(0, 0) rotate(0deg) scale(1);
        opacity: 1;
      }
      50%{
        opacity: 0.8;
      }
      100%{
        transform: translate(calc(var(--random-x, 0) * 400px - 200px), calc(var(--random-y, 0) * 400px - 200px)) rotate(720deg) scale(0.2);
        opacity: 0;
      }
    }
    @keyframes screenShake{
      0%, 100% { transform: translateX(0) }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-2px) }
      20%, 40%, 60%, 80% { transform: translateX(2px) }
    }
    .result-celebration{
      position: relative;
      overflow: hidden;
    }
    .result-celebration::before{
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: celebrationGlow 2s ease-in-out infinite alternate;
    }
    @keyframes celebrationGlow{
      from { opacity: 0.3; transform: scale(0.8) }
      to { opacity: 0.7; transform: scale(1.2) }
    }
    footer{color:var(--muted); text-align:center; padding:32px 0}
    @media (max-width: 860px){
      .hero{grid-template-columns:1fr}
    }
  </style>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Article",
    "headline":"ë‚´ ê°ì„± ë‚˜ì´ëŠ” ëª‡ ì‚´? | ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸",
    "description":"8ë¬¸í•­ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ì˜ ì§„ì§œ ê°ì„±ì—°ë ¹. 10ëŒ€ Zì„¸ëŒ€ë¶€í„° 40ëŒ€+ ì–´ë¥¸ ê°ì„±ê¹Œì§€ ë¶„ì„í•˜ê³  ê²°ê³¼ ì¹´ë“œ ìƒì„±.",
    "inLanguage":"ko",
    "author":{"@type":"Organization","name":"tests.mahalohana-bruce.com"},
    "publisher":{"@type":"Organization","name":"Mahalo Hana Bruce"},
    "url":"https://tests.mahalohana-bruce.com/age-vibe/ko/index.html"
  }
  </script>

  <!-- (ì„ íƒ) ì• ë“œì„¼ìŠ¤ ì‚½ì… ìœ„ì¹˜ ì˜ˆì‹œ: data-ad-clientë§Œ ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5508768187151867" crossorigin="anonymous"></script>
  -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5508768187151867" crossorigin="anonymous"></script>

  <meta name="mobile-web-app-capable" content="yes">

</head>
<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸</div>
        <div class="muted" style="font-size:12px">ë‚´ ì§„ì§œ ê°ì„± ë‚˜ì´ëŠ”?</div>
      </div>
    </div>
    <nav aria-label="ì–¸ì–´ ë³€ê²½ ë° ì„¤ì •">
      <button id="statsToggle" class="sound-toggle" onclick="showStatsPopup()" title="ë‚´ í†µê³„ ë³´ê¸°">ğŸ“Š</button>
      <button id="soundToggle" class="sound-toggle" onclick="toggleSound()" title="ì‚¬ìš´ë“œ í† ê¸€">ğŸ”Š</button>
      <a href="../ko/index.html" aria-current="page">í•œêµ­ì–´</a>
      <a href="../ja/index.html">æ—¥æœ¬èª</a>
      <a href="../en/index.html">English</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="card hero">
    <div>
      <span class="pill">8ë¬¸í•­ Â· 1ë¶„ Â· ê²°ê³¼ ì¹´ë“œ ì¦‰ì‹œ ìƒì„±</span>
      <h1>ë‚´ <span style="background:linear-gradient(90deg, var(--brand), var(--brand2)); -webkit-background-clip:text; background-clip:text; color:transparent;">ê°ì„±ì—°ë ¹</span>ì€ ëª‡ ì‚´?</h1>
      <p class="muted">ë¼ì´í”„ìŠ¤íƒ€ì¼ê³¼ ì·¨í–¥ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ì§„ì§œ ê°ì„± ë‚˜ì´! <strong>Zì„¸ëŒ€ Â· MZì„¸ëŒ€ Â· ë°€ë ˆë‹ˆì–¼ Â· Xì„¸ëŒ€</strong> ì¤‘ ì–´ë””ì— ì†í•˜ëŠ”ì§€ 1ë¶„ë§Œì— í™•ì¸í•´ë³´ì„¸ìš”. ë¬´ë£Œ ê²°ê³¼ ì¹´ë“œë¥¼ ë§Œë“¤ì–´ <strong>ì¹œêµ¬ë“¤ê³¼ ê³µìœ </strong>í•  ìˆ˜ ìˆì–´ìš”.</p>
      
      <!-- SEO: í•µì‹¬ í‚¤ì›Œë“œ ê°•í™” -->
      <div style="display: none;">
        <h2>ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸ë€?</h2>
        <p>ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸ëŠ” ë‹¹ì‹ ì˜ ì‹¤ì œ ë‚˜ì´ì™€ ê´€ê³„ì—†ì´ ë§ˆìŒì˜ ë‚˜ì´, ì¦‰ ê°ì„±ì  ì„±ìˆ™ë„ë¥¼ ì¸¡ì •í•˜ëŠ” ì‹¬ë¦¬ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. 8ê°œì˜ ê°„ë‹¨í•œ ì§ˆë¬¸ì„ í†µí•´ Zì„¸ëŒ€, ë°€ë ˆë‹ˆì–¼ ì„¸ëŒ€, Xì„¸ëŒ€ ì¤‘ ì–´ë–¤ ì„¸ëŒ€ì˜ ê°ì„±ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ ì•Œì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <h3>í…ŒìŠ¤íŠ¸ íŠ¹ì§•</h3>
        <ul>
          <li>ë¬´ë£Œ ê°ì„±ì—°ë ¹ ì¸¡ì •</li>
          <li>8ë¬¸í•­ ê°„ë‹¨ í…ŒìŠ¤íŠ¸</li>
          <li>ì¦‰ì‹œ ê²°ê³¼ í™•ì¸</li>
          <li>ê²°ê³¼ ì¹´ë“œ ìƒì„± ë° ê³µìœ </li>
          <li>ì„¸ëŒ€ë³„ ìƒì„¸ ë¶„ì„</li>
        </ul>
      </div>
      <div class="progress" aria-label="ì§„í–‰ë¥ "><div id="bar"></div></div>
      <div class="actions">
        <button id="startBtn" class="primary">ì‹œì‘í•˜ê¸°</button>
        <button id="resetBtn" class="secondary hidden">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
      
      <!-- ê³ ê¸‰ ê¸°ëŠ¥ ë²„íŠ¼ ì˜ì—­ -->
      <div class="advanced-features" id="advancedFeatures" style="margin-top: 20px; display: none;">
        <div class="feature-grid">
          <button id="rankingBtn" class="feature-btn">
            <div class="feature-icon">ğŸ†</div>
            <div class="feature-text">
              <div class="feature-title">ê¸€ë¡œë²Œ ë­í‚¹</div>
              <div class="feature-desc">ìˆœìœ„ í™•ì¸</div>
            </div>
          </button>
          
          <button id="recommendationBtn" class="feature-btn">
            <div class="feature-icon">ğŸ¯</div>
            <div class="feature-text">
              <div class="feature-title">ë§ì¶¤ ì¶”ì²œ</div>
              <div class="feature-desc">ê°œì¸ ë¶„ì„</div>
            </div>
          </button>
          
          <button id="analyticsBtn" class="feature-btn">
            <div class="feature-icon">ğŸ“Š</div>
            <div class="feature-text">
              <div class="feature-title">ë°ì´í„° ë¶„ì„</div>
              <div class="feature-desc">ì¸ì‚¬ì´íŠ¸</div>
            </div>
          </button>
        </div>
        
        <div class="toggle-features" id="toggleFeatures">
          <button class="toggle-btn">ê³ ê¸‰ ê¸°ëŠ¥ ìˆ¨ê¸°ê¸° â–²</button>
        </div>
      </div>
      
      <!-- ê³ ê¸‰ ê¸°ëŠ¥ í† ê¸€ ë²„íŠ¼ -->
      <div class="show-features" id="showFeatures" style="margin-top: 15px;">
        <button class="toggle-btn">âœ¨ ê³ ê¸‰ ê¸°ëŠ¥ ë³´ê¸° â–¼</button>
      </div>
    </div>
    <div class="card" style="min-height:180px; display:grid; place-items:center; text-align:center">
      <div>
        <div style="font-size:13px; color:var(--muted); margin-bottom:6px;">ê²°ê³¼ ì˜ˆì‹œ</div>
        <div style="font-size:28px; font-weight:900; margin-bottom:6px">MZ íŠ¸ë Œë”” ê°ì„± ğŸ”¥</div>
        <div class="muted">ìƒˆë¡œìš´ ê±¸ ì¢‹ì•„í•˜ëŠ” ë‹¹ì‹ , ì™„ì „ í™í•´ìš”!</div>
      </div>
    </div>
  </section>

  <section id="quiz" class="card qcard hidden" aria-live="polite"></section>

  <section id="result" class="card hidden" aria-live="polite">
    <div class="badge">RESULT</div>
    <h2 id="resTitle" style="margin:.2em 0 .2em; font-size:clamp(22px, 2.5vw, 28px)"></h2>
    <div class="muted" id="resSub"></div>
    <div class="result">
      <div>
        <div class="badge">ê°ì„± ë‚˜ì´ ì§€ìˆ˜</div>
        <div id="scoreBox" style="font-size:34px; font-weight:900; margin:.2em 0 .4em">â€”</div>
        <div id="resDesc" class="muted"></div>
      </div>
      <div>
        <div class="badge">ê³µìœ  & ì €ì¥</div>
        <div class="share">
          <a id="shareLine" target="_blank" rel="noopener">LINE</a>
          <a id="shareX" target="_blank" rel="noopener">X (Twitter)</a>
          <a id="shareFb" target="_blank" rel="noopener">Facebook</a>
          <button id="copyLink" class="secondary">ë§í¬ ë³µì‚¬</button>
          <button id="saveImg">ê²°ê³¼ ì¹´ë“œ PNG ì €ì¥</button>
        </div>
      </div>
    </div>
    <canvas id="cardCanvas" class="hidden" width="1080" height="1350" aria-hidden="true"></canvas>
    <div class="actions" style="margin-top:16px">
      <button id="retry" class="secondary">ë‹¤ì‹œ í•˜ê¸°</button>
    </div>
  </section>

  <!-- (ì„ íƒ) ê´‘ê³  ìœ„ì¹˜ ì˜ˆì‹œ
  <section class="wrap" style="margin-top:16px">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-XXXXXXXXXXXX"
         data-ad-slot="YYYYYYYYYY"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
  </section>
  -->
</main>

<footer>
  Â© ë‹¹ì‹ ì˜ ì—°ì• Â·ì„±í–¥ í…ŒìŠ¤íŠ¸ | tests.mahalohana-bruce.com
  <div class="footer-nav" style="margin-top:12px;">
    <a id="home-link" href="/" style="text-decoration:none;color:#2563eb;font-weight:700;">ğŸ  ë©”ì¸ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™</a>
  </div>
</footer>

<script>
  // ---------- ê³ ê¸‰ ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ----------
  let audioContext;
  let isSoundEnabled = true;
  
  function initAudioContext() {
    if (!audioContext && (window.AudioContext || window.webkitAudioContext)) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  const playSound = (type, resultType = null) => {
    if (!isSoundEnabled) return;
    initAudioContext();
    if (!audioContext) return;
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    const filterNode = audioContext.createBiquadFilter();
    
    oscillator.connect(filterNode);
    filterNode.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    switch(type) {
      case 'click':
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
        break;
        
      case 'success':
        // ê²°ê³¼ë³„ ë§ì¶¤ ì„±ê³µ ì‚¬ìš´ë“œ
        const successFreqs = {
          teen: [800, 1000, 1200], // ë†’ê³  ë°ì€ ì†Œë¦¬
          twenties: [659.25, 783.99, 987.77], // í™œê¸°ì°¬ ì½”ë“œ
          thirties: [523.25, 659.25, 783.99], // ì•ˆì •ì ì¸ ì½”ë“œ
          forties: [392.00, 493.88, 587.33] // ê¹Šê³  ë”°ëœ»í•œ ì†Œë¦¬
        };
        
        const freqs = successFreqs[resultType] || successFreqs.teen;
        
        freqs.forEach((freq, i) => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.1);
          gain.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.1);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4 + i * 0.1);
          osc.start(audioContext.currentTime + i * 0.1);
          osc.stop(audioContext.currentTime + 0.4 + i * 0.1);
        });
        break;
        
      case 'whoosh':
        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.2);
        filterNode.frequency.setValueAtTime(1000, audioContext.currentTime);
        filterNode.frequency.exponentialRampToValueAtTime(3000, audioContext.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.2);
        break;
        
      case 'magic':
        // ë§ˆë²• ê°™ì€ ì†Œë¦¬ (ê²°ê³¼ ë°œí‘œìš©)
        for (let i = 0; i < 5; i++) {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          const filter = audioContext.createBiquadFilter();
          
          osc.connect(filter);
          filter.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.frequency.setValueAtTime(400 + Math.random() * 800, audioContext.currentTime + i * 0.1);
          filter.frequency.setValueAtTime(1000 + Math.random() * 2000, audioContext.currentTime + i * 0.1);
          filter.Q.setValueAtTime(15, audioContext.currentTime + i * 0.1);
          gain.gain.setValueAtTime(0.1, audioContext.currentTime + i * 0.1);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3 + i * 0.1);
          
          osc.start(audioContext.currentTime + i * 0.1);
          osc.stop(audioContext.currentTime + 0.3 + i * 0.1);
        }
        break;
        
      case 'celebration':
        // ì¶•í•˜ íŒ¡íŒŒë ˆ
        const celebrationNotes = [523.25, 659.25, 783.99, 1046.50]; // C-E-G-C ì˜¥íƒ€ë¸Œ
        celebrationNotes.forEach((freq, i) => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          
          osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.15);
          gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5 + i * 0.15);
          osc.start(audioContext.currentTime + i * 0.15);
          osc.stop(audioContext.currentTime + 0.5 + i * 0.15);
        });
        break;
    }
  };

  // ì‚¬ìš´ë“œ í† ê¸€ ê¸°ëŠ¥
  function toggleSound() {
    isSoundEnabled = !isSoundEnabled;
    const toggleBtn = document.getElementById('soundToggle');
    if (toggleBtn) {
      toggleBtn.textContent = isSoundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
      toggleBtn.classList.toggle('muted', !isSoundEnabled);
    }
    showQuickToast(isSoundEnabled ? 'ğŸ”Š ì‚¬ìš´ë“œ ì¼œì§' : 'ğŸ”‡ ì‚¬ìš´ë“œ êº¼ì§');
    if (isSoundEnabled) {
      playSound('click');
    }
  }

  // ---------- ì¬ë¯¸ìˆëŠ” ë©”ì‹œì§€ë“¤ ----------
  const loadingMessages = [
    'ğŸ§  ë‡ŒíŒŒë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...',
    'ğŸ“Š ê°ì„±ì§€ìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...',
    'ğŸ¯ ë‹¹ì‹ ì˜ ì„¸ëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...',
    'âœ¨ ë§ˆë²•ì„ ë¶€ë¦¬ëŠ” ì¤‘...',
    'ğŸ” ìˆ¨ê²¨ì§„ ê°ì„±ì„ ë°œê²¬í•˜ëŠ” ì¤‘...',
    'ğŸ’« ìš°ì£¼ì—ì„œ ë‹µì„ ì°¾ëŠ” ì¤‘...',
    'ğŸª ì„œì»¤ìŠ¤ë‹¨ì—ê²Œ ë¬¼ì–´ë³´ëŠ” ì¤‘...',
    'ğŸ¦„ ìœ ë‹ˆì½˜ê³¼ ìƒë‹´í•˜ëŠ” ì¤‘...'
  ];

  const encourageMessages = [
    'ì¢‹ì€ ì„ íƒì´ì—ìš”! ğŸ‘',
    'ì˜¤, í¥ë¯¸ë¡œìš´ë°ìš”? ğŸ¤”',
    'ì—­ì‹œ ê·¸ëŸ´ ì¤„ ì•Œì•˜ì–´ìš”! ğŸ˜†',
    'ì´ê±´ ì˜ˆìƒ ëª»í–ˆëŠ”ë°? ğŸ˜®',
    'ì™„ì „ ë‹¹ì‹ ë‹¤ìš´ ë‹µë³€! âœ¨',
    'ì‹ ì¤‘í•˜ê²Œ ê³ ë¯¼í•˜ì…¨ë„¤ìš” ğŸ§',
    'íŠ¸ë Œë””í•œ ì„ íƒ! ğŸ”¥',
    'í´ë˜ì‹í•œ ë§¤ë ¥ì´ë„¤ìš”! ğŸ’'
  ];

  // ---------- ë°ì´í„° ì •ì˜ ----------
  const QUESTIONS = [
    {
      q: "ì£¼ë§ì— ë­ í•˜ê³  ì§€ë‚´ì„¸ìš”?",
      opts: [
        ["í‹±í†¡/ì‡¼ì¸  ì •ì£¼í–‰, OTT ëª°ì•„ë³´ê¸° ğŸ¿", 3],
        ["í•«í”Œë ˆì´ìŠ¤ ì¹´í˜íˆ¬ì–´, íŒì—…ìŠ¤í† ì–´ íƒë°© â˜•", 2],
        ["í—¬ìŠ¤ì¥/ë“±ì‚°/ëŸ¬ë‹, ì·¨ë¯¸ìƒí™œ ì§‘ì¤‘ ğŸƒ", 1],
        ["ì§‘ì—ì„œ ë…ì„œ/ë‰´ìŠ¤, ë‹¤íë©˜í„°ë¦¬ ì‹œì²­ ğŸ“š", 0]
      ]
    },
    {
      q: "ì¹´í†¡ ë‹µì¥ì€ ì–¸ì œ í•˜ëŠ” í¸?",
      opts: [
        ["ë°”ë¡œë°”ë¡œ! 5ë¶„ ì•ˆì—ëŠ” ë¬´ì¡°ê±´ ğŸ’¨", 3],
        ["1~2ì‹œê°„ ì•ˆì—ëŠ” ê¼­ ë‹µì¥í•´ìš” â°", 2],
        ["í•˜ë£¨ í•œ ë²ˆ ëª°ì•„ì„œ ì •ë¦¬ ğŸ“", 1],
        ["ê°€ë” ì½ì”¹ë„... ì£„ì†¡í•´ìš” ğŸ˜…", 0]
      ]
    },
    {
      q: "SNS ë¼ì´í”„ ì–´ë–»ê²Œ ì¦ê¸°ì„¸ìš”?",
      opts: [
        ["í‹±í†¡/ë¦´ìŠ¤ë¡œ íŠ¸ë Œë“œ ë”°ë¼ì¡ê¸° ğŸ“±", 3],
        ["ì¸ìŠ¤íƒ€ê·¸ë¨ ìŠ¤í† ë¦¬/í”¼ë“œ í™œë°œí•˜ê²Œ ğŸ“¸", 2],
        ["ë¸”ë¡œê·¸/ë¸ŒëŸ°ì¹˜/ë…¸ì…˜ ê¸°ë¡í•˜ê¸° âœï¸", 1],
        ["ì¹´í†¡/ë°´ë“œ ì •ë„ë§Œ... SNS í”¼ë¡œí•´ìš” ğŸ˜´", 0]
      ]
    },
    {
      q: "íŒ¨ì…˜ ìŠ¤íƒ€ì¼ë§ì€ ì–´ë–»ê²Œ?",
      opts: [
        ["í¸í•˜ë©´ì„œ í™í•˜ê²Œ! ê¾¸ì•ˆê¾¸ ë§ˆìŠ¤í„° ğŸ˜", 3],
        ["ì¸í”Œë£¨ì–¸ì„œ ë”°ë¼ í•˜ë©° íŠ¸ë Œë“œ ì²´í¬ ğŸ‘—", 2],
        ["ë¸Œëœë“œ ê¸°ë³¸í…œìœ¼ë¡œ ë¬´ë‚œí•˜ê²Œ ğŸ‘”", 1],
        ["ì˜ˆì „ ì˜·ë„ ê´œì°®ë‹¤ë©´ ê³„ì† ì…ì–´ìš” ğŸ‘š", 0]
      ]
    },
    {
      q: "ìŒì•… ì·¨í–¥ì´ ê¶ê¸ˆí•´ìš”!",
      opts: [
        ["ìµœì‹  K-POP/í™í•©/íŒ ìœ„ì£¼ë¡œ ğŸµ", 3],
        ["ì¸ë””/ì‹œí‹°íŒ/ì¬ì¦ˆ ë¶„ìœ„ê¸° ìˆê²Œ ğŸ¶", 2],
        ["ë°œë¼ë“œ/OST/ê°ì„±ì ì¸ ê³¡ë“¤ ğŸ¤", 1],
        ["7080/8090 ëª…ê³¡ë“¤, ì¶”ì–µì˜ ìŒì•… ğŸ¼", 0]
      ]
    },
    {
      q: "ì‡¼í•‘í•  ë•Œ ì–´ë–¤ íƒ€ì…ì´ì„¸ìš”?",
      opts: [
        ["ì‹ ìƒí’ˆ/í•œì •íŒì€ ì¼ë‹¨ ì²´í¬! ğŸ’³", 3],
        ["í• ì¸/ê°€ì„±ë¹„ ì œí’ˆ ê¼¼ê¼¼íˆ ë¹„êµ ğŸ›ï¸", 2],
        ["ê¼­ í•„ìš”í•œ ê²ƒë§Œ ë¯¸ë‹ˆë©€í•˜ê²Œ ğŸ¯", 1],
        ["ê°€ë” í°ë§˜ ë¨¹ê³  í”Œë ‰ìŠ¤ íƒ€ì„! ğŸ’¸", 0]
      ]
    },
    {
      q: "ìƒˆë¡œìš´ ì•±/ê¸°ìˆ ì´ ë‚˜ì˜¤ë©´?",
      opts: [
        ["ë°”ë¡œ ë‹¤ìš´ë°›ì•„ì„œ ì¨ë³´ëŠ” ì–¼ë¦¬ì–´ë‹µí„° ğŸš€", 3],
        ["ì£¼ë³€ ë°˜ì‘ ë³´ê³  ë¹ ë¥´ê²Œ ì ì‘í•˜ê¸° ğŸ‘¥", 2],
        ["ì •ë§ í•„ìš”í•  ë•Œë§Œ ì„¤ì¹˜í•´ìš” ğŸ¤”", 1],
        ["ê¸°ì¡´ ê±° ì“°ëŠ” ê²Œ í¸í•´ìš”... ğŸ“±", 0]
      ]
    },
    {
      q: "ë¼ì´í”„ ë¦¬ë“¬ì€ ì–´ë–¤ ìŠ¤íƒ€ì¼?",
      opts: [
        ["ë°¤ì´ ë˜ë©´ í™œë°œí•´ì§€ëŠ” ì˜¬ë¹¼ë¯¸ ğŸ¦‰", 3],
        ["ë°¤í˜•ì´ì§€ë§Œ ê·œì¹™ì ì¸ ë¦¬ë“¬ ìœ ì§€ ğŸŒ™", 2],
        ["ì•„ì¹¨í˜• ì¸ê°„! ì¼ì° ìê³  ì¼ì° ì¼ì–´ë‚˜ìš” ğŸŒ…", 1],
        ["í• ì•„ë²„ì§€/í• ë¨¸ë‹ˆ ì‹œê°„í‘œë¡œ ì‚´ì•„ìš” â°", 0]
      ]
    }
  ];

  const RESULTS = [
    {
      key: "teen",
      title: "ì´ˆê³ ì† Zì„¸ëŒ€ ê°ì„± âš¡",
      sub: "ì‹ ì¡°ì–´ ë§ˆìŠ¤í„° Â· ë°ˆ ì„¼ìŠ¤ ë§Œë ™ Â· íŠ¸ë Œë“œ ì„¸í„°",
      desc: "\"ì•„ ì§„ì§œ ê°œì›ƒê¸°ë„¤ ã…‹ã…‹ã…‹\" í•˜ë©´ì„œ ë°”ë¡œë°”ë¡œ ë°˜ì‘í•˜ëŠ” ë‹¹ì‹ ! ìƒˆë¡œìš´ ê±¸ ë‘ë ¤ì›Œí•˜ì§€ ì•Šê³  íŠ¸ë Œë“œë¥¼ ì´ë„ëŠ” ë¦¬ë”ì˜ˆìš”. ë°ˆë„ ì²™ì²™ ë§Œë“¤ê³ , ëª¨ë“  ê²Œ ë¹¨ë¼ì„œ ì¹œêµ¬ë“¤ì´ ë”°ë¼ì˜¤ê¸° í˜ë“¤ ìˆ˜ë„... ê°€ë”ì€ ë””ì§€í„¸ ë””í†¡ìŠ¤ë„ í•„ìš”í•´ìš”! ğŸ¤³",
      colorA: "#67e8f9", colorB:"#a78bfa", emoji:"âš¡"
    },
    {
      key: "twenties",
      title: "MZ íŠ¸ë Œë”” ê°ì„± ğŸ”¥",
      sub: "í™í•˜ì§€ë§Œ í˜„ì‹¤ì  Â· YOLOì™€ FOMO ì‚¬ì´",
      desc: "\"ì´ê±° ì™„ì „ ë‚´ ìŠ¤íƒ€ì¼~!\" í•˜ë©´ì„œ ìƒˆë¡œìš´ ê±¸ ì‹œë„í•˜ê¸¸ ì¢‹ì•„í•˜ëŠ” ë‹¹ì‹ ! ìì‹ ë§Œì˜ í™•ì‹¤í•œ ì·¨í–¥ì´ ìˆê³ , ë„ì „ì •ì‹ ì´ ë„˜ì³ìš”. ì¸ìŠ¤íƒ€ ê°ì„±ë„ ì™„ë²½í•˜ê³  í•«í”Œë„ ì˜ ì°¾ì•„ë‚´ì£ . ë‹¤ë§Œ ë‚¨ê³¼ ë¹„êµëŠ” ê¸ˆë¬¼! ë‹¹ì‹ ë§Œì˜ í˜ì´ìŠ¤ë¡œ ê°€ë©´ ë¼ìš” âœ¨",
      colorA: "#8b5cf6", colorB:"#f472b6", emoji:"ğŸ”¥"
    },
    {
      key: "thirties",
      title: "ë°¸ëŸ°ìŠ¤ ë§ˆìŠ¤í„° ê°ì„± âš–ï¸",
      sub: "ì¼ê³¼ ì·¨ë¯¸ì˜ ê· í˜• Â· í˜„ëª…í•œ ì†Œë¹„ Â· ì•ˆì •ì  ë§¤ë ¥",
      desc: "\"ì´ì œ ì¢€ ì•ˆì •ì ìœ¼ë¡œ ì‚´ê³  ì‹¶ì–´\" í•˜ë©´ì„œë„ íŠ¸ë Œë“œëŠ” ë†“ì¹˜ì§€ ì•ŠëŠ” ë‹¹ì‹ ! ìœ í–‰ë„ ì¦ê¸°ë˜ ë³¸ì§ˆì„ ë” ì¤‘ì‹œí•˜ëŠ” í˜„ëª…í•œ íƒ€ì…ì´ì—ìš”. ê³„íšì ì´ê³  ì‹ ì¤‘í•˜ì§€ë§Œ, ê°€ë”ì€ ì¦‰í¥ì ì¸ ì¬ë¯¸ë„ í•„ìš”í•´ìš”. ì–´ë¥¸ìŠ¤ëŸ¬ìš°ë©´ì„œë„ ë§¤ë ¥ì ! ğŸ‘",
      colorA: "#22c55e", colorB:"#a7f3d0", emoji:"âš–ï¸"
    },
    {
      key: "forties",
      title: "í´ë˜ì‹ ì–´ë¥¸ ê°ì„± ğŸ¶",
      sub: "ì „í†µê³¼ í’ˆì§ˆ ì¤‘ì‹œ Â· ì¸ìƒ ì„ ë°°ì˜ ì—¬ìœ ",
      desc: "\"ìš”ì¦˜ ì Šì€ ì• ë“¤ì€ ì°¸...\" í•˜ë©´ì„œë„ ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ëˆˆìœ¼ë¡œ ë°”ë¼ë³´ëŠ” ë‹¹ì‹ ! ê²€ì¦ëœ ê²ƒì„ ì„ í˜¸í•˜ê³  í’ˆì§ˆì„ ì¤‘ì‹œí•´ìš”. ê°€ì¡±ê³¼ ì¸ì—°ì„ ì†Œì¤‘íˆ ì—¬ê¸°ëŠ” ë”°ëœ»í•œ ë§ˆìŒì˜ ì†Œìœ ì. ê°€ë” ì Šì€ ê°ì„±ì„ ë°›ì•„ë“¤ì´ë©´ 'ë‰´íŠ¸ë¡œ' ë§¤ë ¥ì´ í­ë°œí•  ê±°ì˜ˆìš”! ğŸŒŸ",
      colorA: "#f59e0b", colorB:"#fde68a", emoji:"ğŸ¶"
    }
  ];

  // ---------- ìƒíƒœ ----------
  let step = 0;
  const answers = []; // ìˆ«ì ì ìˆ˜ë§Œ ì €ì¥ (0~3)
  const bar = document.getElementById('bar');
  const quizEl = document.getElementById('quiz');
  const resultEl = document.getElementById('result');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');

  // ---------- ìœ í‹¸ ----------
  const clamp = (v, a, b) => Math.min(Math.max(v, a), b);

  function updateProgress(){
    const pct = step === 0 ? 0 : (step/QUESTIONS.length)*100;
    bar.style.width = pct + '%';
    bar.setAttribute('aria-valuenow', Math.round(pct));
  }

  // ---------- AI ê¸°ë°˜ ë™ì  ì§ˆë¬¸ ì‹œìŠ¤í…œ ----------
  const DYNAMIC_QUESTIONS_POOL = [
    // íŠ¸ë Œë“œ ê´€ë ¨
    {
      q: "ìš”ì¦˜ ê°€ì¥ ê´€ì‹¬ ìˆëŠ” íŠ¸ë Œë“œëŠ”?",
      opts: [
        ["ë©”íƒ€ë²„ìŠ¤/VR ê²Œì„ ğŸ¥½", 3],
        ["NFT/í¬ë¦¬ì—ì´í„° ì´ì½”ë…¸ë¯¸ ğŸ’", 2],
        ["ESG/ì§€ì†ê°€ëŠ¥í•œ ì†Œë¹„ ğŸŒ±", 1],
        ["ì „í†µ ë¬¸í™” ì¬ë°œê²¬ ğŸº", 0]
      ]
    },
    // ì†Œí†µ ìŠ¤íƒ€ì¼
    {
      q: "ì¹œêµ¬ë“¤ê³¼ ì£¼ë¡œ ì–´ë–»ê²Œ ì†Œí†µí•˜ë‚˜ìš”?",
      opts: [
        ["ìŒì„±ë©”ì‹œì§€/ì˜ìƒí†µí™” ğŸ¤", 3],
        ["ì´ëª¨ì§€/ì§¤/ìŠ¤í‹°ì»¤ ìœ„ì£¼ ğŸ˜‚", 2],
        ["ê¸´ í…ìŠ¤íŠ¸ë¡œ ìì„¸íˆ ğŸ’­", 1],
        ["ì „í™” í†µí™”ê°€ í¸í•´ìš” â˜ï¸", 0]
      ]
    },
    // í•™ìŠµ/ì„±ì¥
    {
      q: "ìƒˆë¡œìš´ ê²ƒì„ ë°°ìš¸ ë•Œ ì„ í˜¸í•˜ëŠ” ë°©ì‹ì€?",
      opts: [
        ["ìœ íŠœë¸Œ/í‹±í†¡ ì§§ì€ ì˜ìƒ ğŸ“º", 3],
        ["ì˜¨ë¼ì¸ ê°•ì˜/ì¸í”Œë£¨ì–¸ì„œ ğŸ“±", 2],
        ["ì±…/ë¸”ë¡œê·¸ ê¹Šì´ ìˆê²Œ ğŸ“–", 1],
        ["ì˜¤í”„ë¼ì¸ ê°•ì˜/ì›Œí¬ìˆ ğŸ«", 0]
      ]
    }
  ];

  const AI_QUESTION_WEIGHTS = {
    // ì‚¬ìš©ì íŒ¨í„´ì— ë”°ë¥¸ ê°€ì¤‘ì¹˜
    teen: { trend: 0.4, social: 0.3, lifestyle: 0.2, classic: 0.1 },
    twenties: { trend: 0.3, social: 0.3, lifestyle: 0.3, classic: 0.1 },
    thirties: { trend: 0.2, social: 0.2, lifestyle: 0.4, classic: 0.2 },
    forties: { trend: 0.1, social: 0.2, lifestyle: 0.3, classic: 0.4 }
  };

  function getAISmartQuestions() {
    const stats = getStats();
    const userProfile = analyzeUserProfile(stats);
    let questions = [...QUESTIONS];
    
    // AI ê¸°ë°˜ ë™ì  ì§ˆë¬¸ ì¶”ê°€ ì—¬ë¶€ ê²°ì •
    if (stats.totalTests > 2 && Math.random() > 0.3) {
      const dynamicQuestion = selectDynamicQuestion(userProfile);
      if (dynamicQuestion) {
        // ê¸°ì¡´ ì§ˆë¬¸ ì¤‘ í•˜ë‚˜ë¥¼ ë™ì  ì§ˆë¬¸ìœ¼ë¡œ êµì²´
        const replaceIndex = Math.floor(Math.random() * questions.length);
        questions[replaceIndex] = dynamicQuestion;
      }
    }
    
    // ì‚¬ìš©ì í”„ë¡œí•„ ê¸°ë°˜ ì§ˆë¬¸ ìˆœì„œ ìµœì í™”
    questions = optimizeQuestionOrder(questions, userProfile);
    
    return questions;
  }

  function analyzeUserProfile(stats) {
    const profile = {
      dominant_type: stats.lastResult || 'teen',
      consistency: calculateConsistency(stats),
      exploration_level: stats.totalTests / 10, // íƒí—˜ ìˆ˜ì¤€
      trend_affinity: 0.5
    };
    
    // ê²°ê³¼ ì¼ê´€ì„± ë¶„ì„
    if (stats.resultCounts) {
      const total = Object.values(stats.resultCounts).reduce((a, b) => a + b, 0);
      const maxCount = Math.max(...Object.values(stats.resultCounts));
      profile.consistency = total > 0 ? maxCount / total : 0;
    }
    
    return profile;
  }

  function calculateConsistency(stats) {
    // ê²°ê³¼ì˜ ì¼ê´€ì„± ê³„ì‚° (0-1)
    const counts = Object.values(stats.resultCounts || {});
    if (counts.length === 0) return 0;
    
    const total = counts.reduce((a, b) => a + b, 0);
    const variance = counts.reduce((acc, count) => {
      const ratio = count / total;
      return acc + (ratio - 0.25) ** 2;
    }, 0) / counts.length;
    
    return 1 - Math.sqrt(variance);
  }

  function selectDynamicQuestion(profile) {
    const weights = AI_QUESTION_WEIGHTS[profile.dominant_type] || AI_QUESTION_WEIGHTS.teen;
    
    // ê°€ì¤‘ì¹˜ ê¸°ë°˜ ì§ˆë¬¸ ì„ íƒ
    const availableQuestions = DYNAMIC_QUESTIONS_POOL.filter(q => {
      if (profile.exploration_level > 0.7) return true; // ê³ íƒí—˜ìëŠ” ëª¨ë“  ì§ˆë¬¸
      return Math.random() < weights.trend; // ì¼ë°˜ ì‚¬ìš©ìëŠ” í™•ë¥ ì  ì„ íƒ
    });
    
    return availableQuestions.length > 0 
      ? availableQuestions[Math.floor(Math.random() * availableQuestions.length)]
      : null;
  }

  function optimizeQuestionOrder(questions, profile) {
    // ì‚¬ìš©ì ì„±í–¥ì— ë§ëŠ” ì§ˆë¬¸ì„ ì•ìª½ìœ¼ë¡œ ë°°ì¹˜
    const weights = AI_QUESTION_WEIGHTS[profile.dominant_type];
    
    return questions.sort((a, b) => {
      const scoreA = getQuestionRelevance(a, weights);
      const scoreB = getQuestionRelevance(b, weights);
      return scoreB - scoreA; // ë†’ì€ ê´€ë ¨ì„± ìˆœìœ¼ë¡œ ì •ë ¬
    });
  }

  function getQuestionRelevance(question, weights) {
    // ì§ˆë¬¸ì˜ í‚¤ì›Œë“œ ë¶„ì„ìœ¼ë¡œ ê´€ë ¨ì„± ì ìˆ˜ ê³„ì‚°
    const q = question.q.toLowerCase();
    let score = 0;
    
    if (q.includes('sns') || q.includes('í‹±í†¡') || q.includes('ìƒˆë¡œìš´')) score += weights.trend;
    if (q.includes('ì¹œêµ¬') || q.includes('ì†Œí†µ') || q.includes('ë‹µì¥')) score += weights.social;
    if (q.includes('ì£¼ë§') || q.includes('ìŒì•…') || q.includes('ì‡¼í•‘')) score += weights.lifestyle;
    if (q.includes('ì „í†µ') || q.includes('ì˜ˆì „') || q.includes('ì•ˆì •')) score += weights.classic;
    
    return score + Math.random() * 0.1; // ì•½ê°„ì˜ ë¬´ì‘ìœ„ì„± ì¶”ê°€
  }

  function renderQuestion(){
    if(step >= QUESTIONS.length){ return showResult(); }
    
    const smartQuestions = getAISmartQuestions();
    const q = smartQuestions[step] || QUESTIONS[step];
    
    // AIê°€ ìƒì„±í•œ ë™ì  ì§ˆë¬¸ì¸ì§€ í™•ì¸
    const isDynamic = DYNAMIC_QUESTIONS_POOL.some(dq => dq.q === q.q);
    
    // ì§ˆë¬¸ë³„ íŠ¹ë³„í•œ ì´ëª¨ì§€ë‚˜ íš¨ê³¼ ì¶”ê°€
    const questionEmojis = {
      0: 'ğŸ ', 1: 'ğŸ’¬', 2: 'ğŸ“±', 3: 'ğŸ‘•', 
      4: 'ğŸµ', 5: 'ğŸ›ï¸', 6: 'ğŸ”§', 7: 'ğŸŒ…'
    };
    
    const progress = Math.round(((step + 1) / QUESTIONS.length) * 100);
    
    quizEl.innerHTML = `
      <div class="qhead">
        <span style="font-size: 24px; margin-right: 8px;">${questionEmojis[step] || 'â“'}</span>
        Q${step+1}. ${q.q}
        ${isDynamic ? '<span class="ai-badge">ğŸ¤– AI</span>' : ''}
      </div>
      <div class="quiz-progress" style="font-size: 12px; color: var(--muted); margin-bottom: 15px;">
        ì§„í–‰ë¥ : ${progress}% â€¢ ${QUESTIONS.length - step - 1}ê°œ ë‚¨ìŒ
      </div>
      <div id="emotionIndicator" class="emotion-indicator"></div>
      <div class="options" role="radiogroup" aria-label="${q.q}">
        ${q.opts.map((o,i)=>`
        <label class="opt" data-score="${o[1]}" data-option="${i}">
          <input type="radio" name="q${step}" value="${o[1]}" aria-label="${o[0]}"/>
          <span>${o[0]}</span>
          <div class="opt-hint" style="font-size: 11px; color: var(--muted); margin-top: 4px; opacity: 0;">
            ${getOptionHint(o[1])}
          </div>
          <div class="emotion-feedback" style="opacity: 0; font-size: 10px; color: var(--brand);"></div>
        </label>`).join('')}
      </div>
      <div class="actions">
        <button class="secondary" id="prevBtn" ${step===0?'disabled':''}>ì´ì „</button>
        <button id="nextBtn">ë‹¤ìŒ</button>
      </div>
    `;
    
    // ì˜µì…˜ì— í˜¸ë²„ ì‹œ íŒíŠ¸ í‘œì‹œ
    document.querySelectorAll('.opt').forEach(opt => {
      opt.addEventListener('mouseenter', () => {
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0.7';
      });
      opt.addEventListener('mouseleave', () => {
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0';
      });
    });
    updateProgress();
    
    // ê°ì • ë¶„ì„ì„ ìœ„í•œ ì§ˆë¬¸ ì‹œì‘ ì‹œê°„ ê¸°ë¡
    const questionStartTime = Date.now();
    
    // ì˜µì…˜ í´ë¦­ ì‹œ í”¼ë“œë°± ì¶”ê°€
    document.querySelectorAll('.opt').forEach((opt, index) => {
      // í˜¸ë²„ íŠ¸ë˜í‚¹
      opt.addEventListener('mouseenter', () => {
        trackUserInteraction('optionHover', { option: index });
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0.7';
      });
      
      opt.addEventListener('mouseleave', () => {
        const hint = opt.querySelector('.opt-hint');
        if (hint) hint.style.opacity = '0';
      });
      
      opt.addEventListener('click', () => {
        const timeSpent = Date.now() - questionStartTime;
        trackUserInteraction('optionClick', { timeSpent, option: index });
        
        playSound('click');
        // ì„ì‹œ í”¼ë“œë°± ë©”ì‹œì§€ í‘œì‹œ
        const feedback = document.createElement('div');
        feedback.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
        feedback.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 1000;
          background: linear-gradient(90deg, var(--brand), var(--brand2));
          color: #0b0f14; padding: 8px 12px; border-radius: 20px;
          font-size: 14px; font-weight: 700; animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(feedback);
        setTimeout(() => feedback.remove(), 2000);
      });
    });
    
    document.getElementById('prevBtn').onclick = ()=>{ 
      if(step>0){ 
        playSound('click');
        step--; 
        answers.pop(); 
        renderQuestion(); 
      } 
    };
    
    document.getElementById('nextBtn').onclick = ()=>{
      const sel = quizEl.querySelector('input[type=radio]:checked');
      if(!sel){ 
        // ì¬ë¯¸ìˆëŠ” ê²½ê³  ë©”ì‹œì§€
        showQuickToast('ğŸ¤” ì„ íƒì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”!');
        playSound('click'); 
        return; 
      }
      
      playSound('whoosh');
      answers.push(parseInt(sel.value,10));
      step++;
      
      // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ì• ë‹ˆë©”ì´ì…˜
      quizEl.style.transform = 'translateX(-20px)';
      quizEl.style.opacity = '0.7';
      
      setTimeout(() => {
        renderQuestion();
        quizEl.style.transform = 'translateX(0)';
        quizEl.style.opacity = '1';
      }, 200);
    };
  }

  function pickResult(avg){ // avg: 0~1 (ì •ê·œí™”)
    if(avg >= 0.75) return RESULTS[0];      // 10ëŒ€
    if(avg >= 0.55) return RESULTS[1];      // 20ëŒ€
    if(avg >= 0.35) return RESULTS[2];      // 30ëŒ€
    return RESULTS[3];                      // 40ëŒ€+
  }

  // íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
  function typeWriter(element, text, speed = 50) {
    element.textContent = '';
    let i = 0;
    function type() {
      if (i < text.length) {
        element.textContent += text.charAt(i);
        i++;
        setTimeout(type, speed);
      }
    }
    type();
  }

  // ë¡œë”© ì‹œí€€ìŠ¤
  function showLoadingSequence(callback) {
    quizEl.classList.add('hidden');
    
    // ë¡œë”© í™”ë©´ ìƒì„±
    const loadingEl = document.createElement('section');
    loadingEl.className = 'card';
    loadingEl.style.textAlign = 'center';
    loadingEl.style.padding = '40px';
    loadingEl.id = 'loading';
    
    const loadingContent = `
      <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”®</div>
      <h2 id="loadingTitle" style="margin-bottom: 20px; min-height: 60px;">ë¶„ì„ ì¤‘...</h2>
      <div style="margin-bottom: 30px;">
        <div class="progress" style="width: 300px; margin: 0 auto;">
          <div id="loadingBar" style="width: 0%; transition: width 0.3s ease;"></div>
        </div>
      </div>
      <p id="loadingMessage" style="color: var(--muted); min-height: 30px;">ğŸ§  ë‡ŒíŒŒë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
    `;
    
    loadingEl.innerHTML = loadingContent;
    document.querySelector('main .wrap').appendChild(loadingEl);
    
    playSound('whoosh');
    
    let progress = 0;
    let messageIndex = 0;
    const loadingBar = document.getElementById('loadingBar');
    const loadingMessage = document.getElementById('loadingMessage');
    
    const progressInterval = setInterval(() => {
      progress += Math.random() * 25 + 10;
      if (progress > 100) progress = 100;
      
      loadingBar.style.width = progress + '%';
      
      // ë©”ì‹œì§€ ë³€ê²½
      if (Math.random() > 0.6 && messageIndex < loadingMessages.length - 1) {
        messageIndex++;
        loadingMessage.textContent = loadingMessages[messageIndex];
        playSound('click');
      }
      
      if (progress >= 100) {
        clearInterval(progressInterval);
        setTimeout(() => {
          playSound('success');
          loadingMessage.textContent = 'âœ¨ ë¶„ì„ ì™„ë£Œ!';
          setTimeout(() => {
            loadingEl.remove();
            callback();
          }, 800);
        }, 500);
      }
    }, 400);
  }

  function showResult(){
    showLoadingSequence(() => {
      const maxPerQ = 3;
      const total = answers.reduce((a,b)=>a+b,0);
      const normalized = total / (QUESTIONS.length * maxPerQ);
      const score100 = Math.round(normalized * 100);
      const res = pickResult(normalized);

      // í…ìŠ¤íŠ¸ ë Œë” with ì• ë‹ˆë©”ì´ì…˜
      const resTitle = document.getElementById('resTitle');
      const resSub   = document.getElementById('resSub');
      const scoreBox = document.getElementById('scoreBox');
      const resDesc  = document.getElementById('resDesc');

      // ìˆœì°¨ì ìœ¼ë¡œ íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜
      setTimeout(() => {
        playSound('magic');
        createParticleExplosion(res.key);
        createScreenShake();
        triggerVibration([100, 50, 100]);
        typeWriter(resTitle, res.title, 30);
        
        // ê²°ê³¼ ì¹´ë“œì— ì¶•í•˜ íš¨ê³¼
        resultEl.classList.add('result-celebration');
      }, 200);
      
      setTimeout(() => {
        typeWriter(resSub, res.sub, 20);
      }, 1500);
      
      setTimeout(() => {
        // ì ìˆ˜ ì¹´ìš´íŠ¸ì—… ì• ë‹ˆë©”ì´ì…˜
        let currentScore = 0;
        const scoreInterval = setInterval(() => {
          currentScore += Math.ceil((score100 - currentScore) / 10);
          if (currentScore >= score100) {
            currentScore = score100;
            clearInterval(scoreInterval);
            playSound('success', res.key);
            playSound('celebration');
            triggerVibration([200, 100, 200]);
          }
          scoreBox.textContent = `${currentScore} / 100`;
        }, 50);
      }, 2500);
      
      setTimeout(() => {
        typeWriter(resDesc, res.desc, 15);
      }, 3500);

      // ê³µìœ  ë§í¬ êµ¬ì„±
      const base = location.origin + location.pathname.replace(/index\.html?$/,'');
      const shareUrl = base + '?result=' + encodeURIComponent(res.key) + '&score=' + score100 + '&utm_source=share&utm_medium=button';
      setupShare(shareUrl, res.title);

      // í†µê³„ ì—…ë°ì´íŠ¸
      const updatedStats = updateStats(res.key, score100);
      
      // ê²°ê³¼ ì¹´ë“œ ê·¸ë¦¬ê¸°
      drawCard(res, score100);

      resultEl.classList.remove('hidden');
      resetBtn.classList.remove('hidden');
      document.getElementById('retry').onclick = restart;
      
      // ì¹œêµ¬ ë„ì „ ê¸°ëŠ¥ ì¶”ê°€
      setTimeout(() => addChallengeFeature(), 4000);
      
      // íŠ¹ë³„í•œ ì„±ì·¨ ì•Œë¦¼
      setTimeout(() => {
        if (updatedStats.totalTests === 1) {
          showQuickToast('ğŸ‰ ì²« í…ŒìŠ¤íŠ¸ ì™„ë£Œ! í†µê³„ ë²„íŠ¼ìœ¼ë¡œ ê¸°ë¡ì„ í™•ì¸í•´ë³´ì„¸ìš”');
        } else if (updatedStats.totalTests % 5 === 0) {
          showQuickToast(`ğŸ† ${updatedStats.totalTests}íšŒ ë‹¬ì„±! ëŒ€ë‹¨í•´ìš”!`);
        } else if (updatedStats.streak >= 3) {
          showQuickToast(`ğŸ”¥ ${updatedStats.streak}ì¼ ì—°ì† í…ŒìŠ¤íŠ¸! ëŒ€ë‹¨í•©ë‹ˆë‹¤!`);
        }
      }, 5000);
    });
  }

  function setupShare(url, title){
    const txt = encodeURIComponent(`[ê°ì„± ë‚˜ì´] ${title}`);
    const u   = encodeURIComponent(url);
    document.getElementById('shareLine').href = `https://line.me/R/msg/text/?${txt}%0A${u}`;
    document.getElementById('shareX').href    = `https://twitter.com/intent/tweet?text=${txt}&url=${u}`;
    document.getElementById('shareFb').href   = `https://www.facebook.com/sharer/sharer.php?u=${u}`;
    document.getElementById('copyLink').onclick = async ()=>{
      try{
        await navigator.clipboard.writeText(url);
        toast("ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”!");
      }catch(e){ alert(url); }
    };
    document.getElementById('saveImg').onclick = saveCard;
  }

  function restart(){
    step = 0; answers.length = 0;
    resultEl.classList.add('hidden');
    document.getElementById('bar').style.width='0%';
    start();
  }

  function start(){
    document.getElementById('resetBtn').classList.remove('hidden');
    document.getElementById('quiz').classList.remove('hidden');
    renderQuestion();
  }

  // ---------- í† ìŠ¤íŠ¸ ----------
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style,{
      position:'fixed', left:'50%', bottom:'24px', transform:'translateX(-50%)',
      background:'rgba(20,26,38,.9)', color:'white', padding:'10px 14px', borderRadius:'10px',
      border:'1px solid rgba(255,255,255,.18)', zIndex:9999, fontWeight:800
    });
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 1600);
  }

  function showQuickToast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style,{
      position:'fixed', top:'50%', left:'50%', transform:'translate(-50%, -50%)',
      background:'linear-gradient(90deg, var(--brand), var(--brand2))', color:'#0b0f14', 
      padding:'16px 24px', borderRadius:'20px', zIndex:9999, fontWeight:800,
      fontSize:'18px', boxShadow:'0 10px 30px rgba(0,0,0,.3)',
      animation:'popIn 0.3s ease'
    });
    document.body.appendChild(t);
    setTimeout(()=>{ 
      t.style.animation = 'popOut 0.2s ease';
      setTimeout(() => t.remove(), 200);
    }, 1500);
  }

  // ì¹œêµ¬ ë„ì „ ê¸°ëŠ¥
  function addChallengeFeature() {
    const resultActions = document.querySelector('#result .actions');
    if (resultActions) {
      const challengeBtn = document.createElement('button');
      challengeBtn.textContent = 'ğŸ† ì¹œêµ¬ ë„ì „í•˜ê¸°';
      challengeBtn.className = 'secondary';
      challengeBtn.onclick = () => {
        playSound('success');
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('challenge', 'true');
        
        if (navigator.share) {
          navigator.share({
            title: 'ê°ì„±ì—°ë ¹ í…ŒìŠ¤íŠ¸ ë„ì „!',
            text: 'ë‚˜ë³´ë‹¤ ë” ì Šì€ ê°ì„±ì¼ê¹Œ? ë„ì „í•´ë´! ğŸ”¥',
            url: currentUrl.toString()
          });
        } else {
          navigator.clipboard.writeText(currentUrl.toString()).then(() => {
            showQuickToast('ğŸ”— ì¹œêµ¬ ë„ì „ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆì–´ìš”!');
          });
        }
      };
      resultActions.appendChild(challengeBtn);
    }
  }

  // ---------- ê²°ê³¼ ì¹´ë“œ ìº”ë²„ìŠ¤ ----------
  function drawCard(res, score){
    const c = document.getElementById('cardCanvas');
    const ctx = c.getContext('2d');

    // ë°°ê²½ ê·¸ë¼ë°ì´ì…˜
    const g = ctx.createLinearGradient(0,0,1080,1350);
    g.addColorStop(0, res.colorA);
    g.addColorStop(0.5, res.colorB);
    g.addColorStop(1, res.colorA);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,1080,1350);

    // ë°°ê²½ íŒ¨í„´ íš¨ê³¼
    ctx.fillStyle = 'rgba(255,255,255,.03)';
    for(let i = 0; i < 20; i++){
      const x = Math.random() * 1080;
      const y = Math.random() * 1350;
      const size = Math.random() * 60 + 20;
      ctx.beginPath();
      ctx.arc(x, y, size, 0, Math.PI * 2);
      ctx.fill();
    }

    // ë©”ì¸ ì¹´ë“œ íŒ¨ë„
    const cardGrad = ctx.createLinearGradient(60, 140, 60, 1210);
    cardGrad.addColorStop(0, 'rgba(20,25,35,.85)');
    cardGrad.addColorStop(1, 'rgba(10,15,25,.9)');
    ctx.fillStyle = cardGrad;
    roundRect(ctx, 60, 140, 960, 1070, 42, true);

    // ì¹´ë“œ í…Œë‘ë¦¬ ê¸€ë¡œìš°
    ctx.strokeStyle = res.colorA + '40';
    ctx.lineWidth = 3;
    roundRect(ctx, 60, 140, 960, 1070, 42, false);
    ctx.stroke();

    // ìƒë‹¨ ì´ëª¨ì§€/ì•„ì´ì½˜ ì˜ì—­
    ctx.fillStyle = res.colorA;
    ctx.font = '120px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(res.emoji, 540, 300);

    // íƒ€ì´í‹€
    ctx.fillStyle = '#f0f6ff';
    ctx.font = 'bold 56px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    wrapText(ctx, res.title, 540, 380, 900, 68);

    // ì„œë¸Œ íƒ€ì´í‹€
    ctx.fillStyle = '#a5b4c7';
    ctx.font = '600 32px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    wrapText(ctx, res.sub, 540, 480, 900, 42);

    // ì ìˆ˜ ë°°ê²½
    const scoreGrad = ctx.createLinearGradient(240, 520, 840, 580);
    scoreGrad.addColorStop(0, res.colorA + '30');
    scoreGrad.addColorStop(1, res.colorB + '30');
    ctx.fillStyle = scoreGrad;
    roundRect(ctx, 240, 520, 600, 80, 20, true);

    // ì ìˆ˜ í…ìŠ¤íŠ¸
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 52px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`ê°ì„±ë‚˜ì´: ${score}ì„¸`, 540, 570);

    // ì„¤ëª… í…ìŠ¤íŠ¸
    ctx.fillStyle = '#d1dce9';
    ctx.font = '500 26px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'left';
    
    // í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¥¼ ì ì ˆíˆ ì¤„ë°”ê¿ˆ
    const lines = [];
    const words = res.desc.split(' ');
    let currentLine = '';
    
    for(const word of words) {
      const testLine = currentLine + (currentLine ? ' ' : '') + word;
      if(ctx.measureText(testLine).width > 880 && currentLine) {
        lines.push(currentLine);
        currentLine = word;
      } else {
        currentLine = testLine;
      }
    }
    if(currentLine) lines.push(currentLine);
    
    lines.forEach((line, i) => {
      ctx.fillText(line, 90, 660 + i * 36);
    });

    // ì¥ì‹ ë¼ì¸
    ctx.strokeStyle = res.colorA + '60';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(90, 1080);
    ctx.lineTo(990, 1080);
    ctx.stroke();

    // í‘¸í„°
    ctx.fillStyle = '#8a9ab0';
    ctx.font = '600 28px "Noto Sans KR", system-ui, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('ğŸŒŸ tests.mahalohana-bruce.com', 540, 1140);
    ctx.font = '500 24px "Noto Sans KR", system-ui, sans-serif';
    ctx.fillText('#ê°ì„±ì—°ë ¹ #í…ŒìŠ¤íŠ¸ #ë°”ì´ëŸ´ #ê³µìœ ', 540, 1180);
  }

  function saveCard(){
    const c = document.getElementById('cardCanvas');
    const link = document.createElement('a');
    link.download = 'age-vibe-result.png';
    link.href = c.toDataURL('image/png');
    link.click();
  }

  function roundRect(ctx, x, y, w, h, r, fill){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
    if(fill) ctx.fill();
  }

  function wrapText(ctx, text, x, y, maxWidth, lineHeight){
    const words = text.split(' ');
    let line = '', yy = y;
    const align = ctx.textAlign;
    
    for(let n=0; n<words.length; n++){
      const test = line + words[n] + ' ';
      if(ctx.measureText(test).width > maxWidth && n>0){
        ctx.fillText(line.trim(), x, yy);
        line = words[n] + ' ';
        yy += lineHeight;
      } else {
        line = test;
      }
    }
    ctx.fillText(line.trim(), x, yy);
  }

  // ---------- ì‹œì‘/ë¦¬ì…‹ ----------
  document.getElementById('startBtn').onclick = ()=>{
    playSound('success');
    document.querySelector('.hero').classList.add('hidden');
    
    // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ì¬ë¯¸ìˆëŠ” ì• ë‹ˆë©”ì´ì…˜
    const startBtn = document.getElementById('startBtn');
    startBtn.style.transform = 'scale(0.95)';
    setTimeout(() => {
      startBtn.style.transform = 'scale(1)';
      start();
    }, 100);
  };
  
  document.getElementById('resetBtn').onclick = ()=>{
    playSound('click');
    
    // í™•ì¸ ë©”ì‹œì§€ì™€ í•¨ê»˜ ë¦¬ì…‹
    if(confirm('ğŸ”„ ì •ë§ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ì–´ìš”?')) {
      showQuickToast('ğŸ¯ ìƒˆë¡œìš´ ë„ì „ ì‹œì‘!');
      setTimeout(() => location.reload(), 500);
    }
  };

  // ëª¨ë“  ë²„íŠ¼ì— ì‚¬ìš´ë“œ íš¨ê³¼ ì¶”ê°€
  document.addEventListener('DOMContentLoaded', () => {
    document.addEventListener('click', (e) => {
      if (e.target.matches('button:not(.no-sound)')) {
        if (!e.target.disabled) {
          playSound('click');
        }
      }
    });
    
    // ë„ì „ ê¸°ëŠ¥ì´ í™œì„±í™”ëœ ê²½ìš° íŠ¹ë³„í•œ ë©”ì‹œì§€
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('challenge') === 'true') {
      setTimeout(() => {
        showQuickToast('ğŸ† ì¹œêµ¬ì˜ ë„ì „ì¥ì´ ë„ì°©í–ˆì–´ìš”!');
        playSound('success');
      }, 1000);
    }

    // ì´ìŠ¤í„°ì—ê·¸: ë¡œê³ ë¥¼ 10ë²ˆ ì—°ì† í´ë¦­í•˜ë©´...
    let logoClickCount = 0;
    const logo = document.querySelector('.logo');
    if (logo) {
      logo.addEventListener('click', () => {
        logoClickCount++;
        playSound('click');
        
        if (logoClickCount === 5) {
          showQuickToast('ğŸ¤” ë­”ê°€ ìˆ¨ê²¨ì§„ ê²Œ ìˆì„ê¹Œìš”?');
        } else if (logoClickCount === 10) {
          showQuickToast('ğŸ‰ ì¶•í•˜í•´ìš”! ìˆ¨ê²¨ì§„ ë©”ì‹œì§€ë¥¼ ë°œê²¬í–ˆì–´ìš”!');
          playSound('success');
          
          // íŠ¹ë³„í•œ ë°°ê²½ íš¨ê³¼
          document.body.style.animation = 'rainbow 3s ease-in-out';
          setTimeout(() => {
            document.body.style.animation = '';
          }, 3000);
          
          logoClickCount = 0; // ë¦¬ì…‹
        } else if (logoClickCount > 15) {
          showQuickToast('ğŸ˜… ê·¸ë§Œ í´ë¦­í•´ì£¼ì„¸ìš”...');
          logoClickCount = 0;
        }
      });
    }

    // ëœë¤ ì¬ë¯¸ ìš”ì†Œ: ê°€ë” í™”ë©´ì— ì´ëª¨ì§€ê°€ ë‚ ì•„ë‹¤ë‹˜
    setInterval(() => {
      if (Math.random() > 0.98) { // 2% í™•ë¥ 
        createFloatingEmoji();
      }
    }, 1000);
  });

  // ë– ë‹¤ë‹ˆëŠ” ì´ëª¨ì§€ íš¨ê³¼
  function createFloatingEmoji() {
    const emojis = ['âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'â­', 'ğŸ­', 'ğŸª', 'ğŸ¦„', 'ğŸŒˆ'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    
    const floatingEmoji = document.createElement('div');
    floatingEmoji.textContent = emoji;
    floatingEmoji.style.cssText = `
      position: fixed; 
      font-size: 24px; 
      pointer-events: none; 
      z-index: 100;
      left: ${Math.random() * window.innerWidth}px;
      top: ${window.innerHeight + 20}px;
      animation: floatUp 4s ease-out forwards;
    `;
    
    document.body.appendChild(floatingEmoji);
    
    setTimeout(() => {
      floatingEmoji.remove();
    }, 4000);
  }

  // ---------- ê³ ê¸‰ 3D íŒŒí‹°í´ ì‹œìŠ¤í…œ ----------
  class Particle3D {
    constructor(x, y, z, emoji, color) {
      this.x = x; this.y = y; this.z = z;
      this.vx = (Math.random() - 0.5) * 10;
      this.vy = (Math.random() - 0.5) * 10;
      this.vz = (Math.random() - 0.5) * 5;
      this.emoji = emoji;
      this.color = color;
      this.life = 1.0;
      this.decay = 0.01 + Math.random() * 0.02;
      this.rotation = Math.random() * Math.PI * 2;
      this.rotationSpeed = (Math.random() - 0.5) * 0.2;
      this.scale = 0.5 + Math.random() * 0.5;
      this.element = null;
      this.createDOMElement();
    }
    
    createDOMElement() {
      this.element = document.createElement('div');
      this.element.textContent = this.emoji;
      this.element.style.cssText = `
        position: fixed;
        font-size: ${20 * this.scale}px;
        pointer-events: none;
        z-index: 1000;
        user-select: none;
        transform-style: preserve-3d;
        filter: drop-shadow(0 0 10px ${this.color});
      `;
      document.body.appendChild(this.element);
    }
    
    update() {
      this.x += this.vx;
      this.y += this.vy;
      this.z += this.vz;
      this.vy += 0.3; // ì¤‘ë ¥
      this.rotation += this.rotationSpeed;
      this.life -= this.decay;
      
      // 3D ë³€í™˜ ì ìš©
      const perspective = 1000;
      const scale3d = perspective / (perspective + this.z);
      const screenX = this.x * scale3d;
      const screenY = this.y * scale3d;
      
      this.element.style.transform = `
        translate(${screenX}px, ${screenY}px) 
        scale(${this.scale * scale3d}) 
        rotate(${this.rotation}rad)
        rotateX(${this.z * 0.01}deg)
      `;
      this.element.style.opacity = this.life;
      
      return this.life > 0;
    }
    
    destroy() {
      if (this.element) {
        this.element.remove();
      }
    }
  }

  let activeParticles = [];
  
  function create3DParticleExplosion(resultType) {
    const particles = {
      'teen': { emojis: ['âš¡', 'ğŸ”¥', 'ğŸ’¥', 'âœ¨', 'ğŸš€'], colors: ['#ff6b6b', '#4ecdc4', '#45b7d1'] },
      'twenties': { emojis: ['ğŸ”¥', 'ğŸ’–', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«'], colors: ['#ff9ff3', '#54a0ff', '#5f27cd'] },
      'thirties': { emojis: ['âš–ï¸', 'ğŸŒ±', 'ğŸ’¼', 'ğŸ“š', 'ğŸ†'], colors: ['#00d2d3', '#ff9f43', '#54a0ff'] },
      'forties': { emojis: ['ğŸ¶', 'ğŸŒ¸', 'ğŸ“œ', 'ğŸ’', 'ğŸƒ'], colors: ['#feca57', '#ff6b6b', '#48dbfb'] }
    };
    
    const config = particles[resultType] || particles['teen'];
    
    // ì¤‘ì•™ í­ë°œ
    for (let i = 0; i < 30; i++) {
      const angle = (i / 30) * Math.PI * 2;
      const radius = 50 + Math.random() * 100;
      const x = window.innerWidth / 2 + Math.cos(angle) * radius;
      const y = window.innerHeight / 2 + Math.sin(angle) * radius;
      const z = (Math.random() - 0.5) * 200;
      
      const emoji = config.emojis[Math.floor(Math.random() * config.emojis.length)];
      const color = config.colors[Math.floor(Math.random() * config.colors.length)];
      
      activeParticles.push(new Particle3D(x, y, z, emoji, color));
    }
    
    // ì›í˜• íŒŒë™ íš¨ê³¼
    for (let ring = 0; ring < 3; ring++) {
      setTimeout(() => {
        for (let i = 0; i < 12; i++) {
          const angle = (i / 12) * Math.PI * 2;
          const radius = (ring + 1) * 150;
          const x = window.innerWidth / 2 + Math.cos(angle) * radius;
          const y = window.innerHeight / 2 + Math.sin(angle) * radius;
          const z = ring * 50;
          
          const emoji = config.emojis[Math.floor(Math.random() * config.emojis.length)];
          const color = config.colors[Math.floor(Math.random() * config.colors.length)];
          
          activeParticles.push(new Particle3D(x, y, z, emoji, color));
        }
      }, ring * 200);
    }
  }

  // íŒŒí‹°í´ ì—…ë°ì´íŠ¸ ë£¨í”„
  function updateParticles() {
    activeParticles = activeParticles.filter(particle => {
      const alive = particle.update();
      if (!alive) {
        particle.destroy();
      }
      return alive;
    });
    
    if (activeParticles.length > 0) {
      requestAnimationFrame(updateParticles);
    }
  }

  // ê¸°ì¡´ 2D íŒŒí‹°í´ë„ ìœ ì§€ (í˜¸í™˜ì„±)
  function createParticleExplosion(resultType) {
    // 3D íŒŒí‹°í´ íš¨ê³¼ ì‹¤í–‰
    create3DParticleExplosion(resultType);
    requestAnimationFrame(updateParticles);
    
    // ê¸°ì¡´ 2D íŒŒí‹°í´ë„ í•¨ê»˜ ì‹¤í–‰ (ë” í’ì„±í•œ íš¨ê³¼)
    const particles = {
      'teen': ['âš¡', 'ğŸ”¥', 'ğŸ’¥', 'âœ¨', 'ğŸš€'],
      'twenties': ['ğŸ”¥', 'ğŸ’–', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«'],
      'thirties': ['âš–ï¸', 'ğŸŒ±', 'ğŸ’¼', 'ğŸ“š', 'ğŸ†'],
      'forties': ['ğŸ¶', 'ğŸŒ¸', 'ğŸ“œ', 'ğŸ’', 'ğŸƒ']
    };
    
    const particleSet = particles[resultType] || particles['teen'];
    
    // ê°„ë‹¨í•œ 2D íŒŒí‹°í´ë¡œ ë°°ê²½ ì±„ìš°ê¸°
    for (let i = 0; i < 20; i++) {
      setTimeout(() => {
        createParticle(
          Math.random() * window.innerWidth,
          Math.random() * window.innerHeight,
          particleSet[Math.floor(Math.random() * particleSet.length)]
        );
      }, i * 50);
    }
  }

  function createParticle(x, y, emoji) {
    const particle = document.createElement('div');
    particle.textContent = emoji;
    particle.style.cssText = `
      position: fixed;
      left: ${x}px;
      top: ${y}px;
      font-size: ${20 + Math.random() * 20}px;
      pointer-events: none;
      z-index: 1000;
      animation: particleBurst ${2 + Math.random() * 2}s ease-out forwards;
    `;
    
    document.body.appendChild(particle);
    
    setTimeout(() => {
      particle.remove();
    }, 4000);
  }

  // í™”ë©´ ì§„ë™ íš¨ê³¼
  function createScreenShake() {
    document.body.style.animation = 'screenShake 0.5s ease-in-out';
    setTimeout(() => {
      document.body.style.animation = '';
    }, 500);
  }

  // ëª¨ë°”ì¼ ì§„ë™
  function triggerVibration(pattern = [200]) {
    if ('vibrate' in navigator) {
      navigator.vibrate(pattern);
    }
  }

  // ---------- í†µê³„ ì‹œìŠ¤í…œ ----------
  const STATS_KEY = 'ageVibe_stats';
  
  function getStats() {
    const stored = localStorage.getItem(STATS_KEY);
    return stored ? JSON.parse(stored) : {
      totalTests: 0,
      resultCounts: { teen: 0, twenties: 0, thirties: 0, forties: 0 },
      averageScore: 0,
      lastResult: null,
      firstTestDate: null,
      streak: 0,
      lastTestDate: null
    };
  }
  
  function updateStats(resultKey, score) {
    const stats = getStats();
    const now = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    stats.totalTests++;
    stats.resultCounts[resultKey]++;
    stats.averageScore = Math.round((stats.averageScore * (stats.totalTests - 1) + score) / stats.totalTests);
    stats.lastResult = resultKey;
    
    if (!stats.firstTestDate) {
      stats.firstTestDate = now;
    }
    
    // ì—°ì† í…ŒìŠ¤íŠ¸ ê³„ì‚° (í•˜ë£¨ì— í•œ ë²ˆ ì´ìƒ)
    if (stats.lastTestDate === now) {
      // ê°™ì€ ë‚ ì´ë©´ ìŠ¤íŠ¸ë¦­ ìœ ì§€
    } else if (stats.lastTestDate && isConsecutiveDay(stats.lastTestDate, now)) {
      stats.streak++;
    } else {
      stats.streak = 1;
    }
    
    stats.lastTestDate = now;
    localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    
    return stats;
  }
  
  function isConsecutiveDay(lastDate, currentDate) {
    const last = new Date(lastDate);
    const current = new Date(currentDate);
    const diffTime = current - last;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays === 1;
  }
  
  function getPopularResult() {
    const stats = getStats();
    let maxCount = 0;
    let popularResult = 'teen';
    
    for (const [key, count] of Object.entries(stats.resultCounts)) {
      if (count > maxCount) {
        maxCount = count;
        popularResult = key;
      }
    }
    
    return { key: popularResult, count: maxCount };
  }
  
  function showStatsPopup() {
    const stats = getStats();
    const popular = getPopularResult();
    const resultNames = {
      teen: 'ì´ˆê³ ì† Zì„¸ëŒ€ ê°ì„±',
      twenties: 'MZ íŠ¸ë Œë”” ê°ì„±', 
      thirties: 'ë°¸ëŸ°ìŠ¤ ë§ˆìŠ¤í„° ê°ì„±',
      forties: 'í´ë˜ì‹ ì–´ë¥¸ ê°ì„±'
    };
    
    const popup = document.createElement('div');
    popup.style.cssText = `
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.2); border-radius: 20px;
      padding: 24px; max-width: 400px; z-index: 2000;
      backdrop-filter: blur(10px); color: var(--text);
      animation: popIn 0.3s ease;
    `;
    
    popup.innerHTML = `
      <h3 style="margin-top:0; text-align:center; color:var(--brand);">ğŸ“Š ë‚´ í†µê³„</h3>
      <div style="display:grid; gap:12px;">
        <div>ğŸ¯ ì´ í…ŒìŠ¤íŠ¸ íšŸìˆ˜: <strong>${stats.totalTests}íšŒ</strong></div>
        <div>ğŸ“ˆ í‰ê·  ê°ì„±ë‚˜ì´: <strong>${stats.averageScore}ì„¸</strong></div>
        <div>ğŸ† ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ê²°ê³¼: <strong>${resultNames[popular.key]}</strong> (${popular.count}íšŒ)</div>
        <div>ğŸ”¥ ì—°ì† í…ŒìŠ¤íŠ¸: <strong>${stats.streak}ì¼</strong></div>
        ${stats.firstTestDate ? `<div>ğŸ“… ì²« í…ŒìŠ¤íŠ¸: ${stats.firstTestDate}</div>` : ''}
      </div>
      <button onclick="this.parentElement.remove()" 
        style="width:100%; margin-top:16px; padding:10px; border:none; 
               background:linear-gradient(90deg, var(--brand), var(--brand2)); 
               color:#0b0f14; border-radius:10px; font-weight:700; cursor:pointer;">
        ë‹«ê¸°
      </button>
    `;
    
    document.body.appendChild(popup);
    playSound('whoosh');
  }

  // ì˜µì…˜ë³„ íŒíŠ¸ ì‹œìŠ¤í…œ
  function getOptionHint(score) {
    const hints = {
      0: 'í´ë˜ì‹ ì„ íƒ âœ¨',
      1: 'ì•ˆì •ì  ì„ íƒ ğŸ“š', 
      2: 'íŠ¸ë Œë”” ì„ íƒ ğŸ”¥',
      3: 'ìµœì‹  íŠ¸ë Œë“œ âš¡'
    };
    return hints[score] || '';
  }

  // ---------- ì‹¤ì‹œê°„ ê°ì • ë¶„ì„ ì‹œìŠ¤í…œ ----------
  let emotionAnalyzer = {
    clickTiming: [],
    hoverPatterns: [],
    scrollBehavior: [],
    currentMood: 'neutral'
  };

  function analyzeUserEmotion() {
    const timing = emotionAnalyzer.clickTiming;
    const hover = emotionAnalyzer.hoverPatterns;
    
    let emotionScore = {
      excitement: 0,
      hesitation: 0,
      confidence: 0,
      curiosity: 0
    };
    
    // í´ë¦­ íƒ€ì´ë° ë¶„ì„
    if (timing.length > 1) {
      const avgTime = timing.reduce((a, b) => a + b) / timing.length;
      if (avgTime < 2000) emotionScore.excitement += 0.3;
      if (avgTime > 8000) emotionScore.hesitation += 0.4;
      if (avgTime >= 3000 && avgTime <= 6000) emotionScore.confidence += 0.3;
    }
    
    // í˜¸ë²„ íŒ¨í„´ ë¶„ì„
    const hoverCount = hover.reduce((sum, h) => sum + h.count, 0);
    const avgHover = hoverCount / Math.max(hover.length, 1);
    
    if (avgHover > 3) emotionScore.curiosity += 0.4;
    if (avgHover < 1.5) emotionScore.confidence += 0.2;
    
    // ê°€ì¥ ë†’ì€ ì ìˆ˜ì˜ ê°ì • ë°˜í™˜
    const dominantEmotion = Object.keys(emotionScore)
      .reduce((a, b) => emotionScore[a] > emotionScore[b] ? a : b);
    
    return {
      emotion: dominantEmotion,
      intensity: Math.max(...Object.values(emotionScore)),
      profile: emotionScore
    };
  }

  function updateEmotionUI(analysis) {
    const indicator = document.getElementById('emotionIndicator');
    if (!indicator) return;
    
    const emotionData = {
      excitement: { emoji: 'ğŸš€', color: '#ff6b6b', message: 'ì™€ìš°! ì—„ì²­ ë¹¨ë¼ìš”!' },
      hesitation: { emoji: 'ğŸ¤”', color: '#95a5a6', message: 'ì‹ ì¤‘í•˜ê²Œ ê³ ë¯¼ ì¤‘ì´ì‹œêµ°ìš”' },
      confidence: { emoji: 'ğŸ˜', color: '#2ecc71', message: 'í™•ì‹ ì— ì°¬ ì„ íƒì´ë„¤ìš”!' },
      curiosity: { emoji: 'ğŸ§', color: '#f39c12', message: 'ê¶ê¸ˆì¦ì´ ë§ìœ¼ì‹œë„¤ìš”!' }
    };
    
    const data = emotionData[analysis.emotion] || emotionData.confidence;
    
    indicator.innerHTML = `
      <div style="
        display: flex; align-items: center; gap: 8px; padding: 8px 12px;
        background: linear-gradient(90deg, ${data.color}20, ${data.color}10);
        border: 1px solid ${data.color}40; border-radius: 20px;
        font-size: 12px; margin-bottom: 10px;
        animation: emotionPulse 1s ease-in-out;
      ">
        <span style="font-size: 16px;">${data.emoji}</span>
        <span style="color: ${data.color};">${data.message}</span>
        <div style="
          width: ${Math.min(analysis.intensity * 100, 100)}%; height: 3px;
          background: ${data.color}; border-radius: 2px;
          transition: width 0.5s ease;
        "></div>
      </div>
    `;
  }

  function trackUserInteraction(action, data = {}) {
    const now = Date.now();
    
    switch (action) {
      case 'optionClick':
        emotionAnalyzer.clickTiming.push(data.timeSpent || 0);
        break;
      case 'optionHover':
        const lastHover = emotionAnalyzer.hoverPatterns[emotionAnalyzer.hoverPatterns.length - 1];
        if (lastHover && now - lastHover.timestamp < 1000) {
          lastHover.count++;
        } else {
          emotionAnalyzer.hoverPatterns.push({
            timestamp: now,
            count: 1,
            option: data.option
          });
        }
        break;
    }
    
    // ì‹¤ì‹œê°„ ê°ì • ë¶„ì„ ë° UI ì—…ë°ì´íŠ¸
    if (emotionAnalyzer.clickTiming.length > 0 || emotionAnalyzer.hoverPatterns.length > 2) {
      const analysis = analyzeUserEmotion();
      updateEmotionUI(analysis);
      
      // ê°ì • ê¸°ë°˜ ë§ì¶¤ í”¼ë“œë°±
      provideMoodBasedFeedback(analysis);
    }
  }

  function provideMoodBasedFeedback(analysis) {
    const feedbacks = {
      excitement: ['ë¹ ë¥¸ ì„ íƒ! ğŸš€', 'ì—ë„ˆì§€ ë„˜ì¹˜ë„¤ìš”! âš¡', 'ì—­ë™ì ì´ì—ìš”! ğŸ’¨'],
      hesitation: ['ì²œì²œíˆ í•´ë„ ê´œì°®ì•„ìš” ğŸ˜Š', 'ì‹ ì¤‘í•œ ì„ íƒ ì¢‹ì•„ìš”! ğŸ¤—', 'ì¶©ë¶„íˆ ê³ ë¯¼í•˜ì„¸ìš” ğŸ’­'],
      confidence: ['í™•ì‹¤í•œ ì„ íƒ! ğŸ‘', 'ìì‹ ê° ìˆì–´ ë³´ì—¬ìš”! ğŸ˜', 'ë©‹ì§„ íŒë‹¨ì´ì—ìš”! âœ¨'],
      curiosity: ['íƒêµ¬ì‹¬ì´ ë§ìœ¼ì‹œë„¤ìš”! ğŸ”', 'í¥ë¯¸ë¡œìš´ ê´€ì ! ğŸ§', 'ê¹Šì´ ìƒê°í•˜ì‹œëŠ”êµ°ìš”! ğŸ’¡']
    };
    
    const messages = feedbacks[analysis.emotion] || feedbacks.confidence;
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    
    // ê°ì • í”¼ë“œë°±ì„ ì˜µì…˜ì— í‘œì‹œ
    setTimeout(() => {
      const activeFeedback = document.querySelector('.emotion-feedback');
      if (activeFeedback && Math.random() > 0.7) { // 30% í™•ë¥ 
        activeFeedback.textContent = randomMessage;
        activeFeedback.style.opacity = '1';
        setTimeout(() => {
          activeFeedback.style.opacity = '0';
        }, 2000);
      }
    }, 500);
  }

  // ========== ì†Œì…œ ë­í‚¹ê³¼ ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ ì‹œìŠ¤í…œ ==========
  
  class SocialRanking {
    constructor() {
      this.storageKey = 'ageVibeGlobalRanking';
      this.userStorageKey = 'ageVibeUserProfile';
      this.maxEntries = 1000;
      this.init();
    }

    init() {
      this.createLeaderboardUI();
      this.bindEvents();
      this.syncWithServer();
    }

    createLeaderboardUI() {
      // ë²„íŠ¼ì€ ì´ë¯¸ HTMLì— í†µí•©ë˜ì–´ ìˆìŒ

      // ë¦¬ë”ë³´ë“œ ëª¨ë‹¬ ì°½ ìƒì„±
      if (!document.getElementById('leaderboardModal')) {
        const modal = document.createElement('div');
        modal.id = 'leaderboardModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>ğŸ† ê¸€ë¡œë²Œ ë¦¬ë”ë³´ë“œ</h2>
              <span class="close">&times;</span>
            </div>
            <div class="ranking-tabs">
              <button class="tab-btn active" data-tab="global">ğŸŒ ì „ì²´</button>
              <button class="tab-btn" data-tab="today">ğŸ“… ì˜¤ëŠ˜</button>
              <button class="tab-btn" data-tab="week">ğŸ“Š ì´ë²ˆ ì£¼</button>
              <button class="tab-btn" data-tab="friends">ğŸ‘¥ ì¹œêµ¬</button>
            </div>
            <div class="ranking-content">
              <div id="globalRanking" class="ranking-list active"></div>
              <div id="todayRanking" class="ranking-list"></div>
              <div id="weekRanking" class="ranking-list"></div>
              <div id="friendsRanking" class="ranking-list"></div>
            </div>
            <div class="user-rank-info">
              <div id="userRankDisplay"></div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€
      if (!document.getElementById('leaderboard-styles')) {
        const style = document.createElement('style');
        style.id = 'leaderboard-styles';
        style.textContent = `
          .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
          }

          .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
          }

          .modal-header {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
          }

          .modal-header h2 {
            color: white;
            margin: 0;
            font-size: 24px;
            font-weight: 700;
          }

          .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
          }

          .close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
          }

          .ranking-tabs {
            display: flex;
            padding: 0 20px;
            background: rgba(255,255,255,0.05);
          }

          .tab-btn {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
          }

          .tab-btn.active,
          .tab-btn:hover {
            color: white;
            border-bottom-color: #fff;
            background: rgba(255,255,255,0.1);
          }

          .ranking-content {
            padding: 20px;
            min-height: 300px;
          }

          .ranking-list {
            display: none;
          }

          .ranking-list.active {
            display: block;
          }

          .rank-item {
            background: rgba(255,255,255,0.1);
            margin: 10px 0;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
          }

          .rank-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
          }

          .rank-number {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            margin-right: 15px;
            min-width: 35px;
          }

          .rank-info {
            flex-grow: 1;
            color: white;
          }

          .rank-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
          }

          .rank-details {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
          }

          .rank-score {
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
            margin-left: 15px;
          }

          .user-rank-info {
            background: rgba(255,255,255,0.1);
            margin: 20px;
            padding: 15px;
            border-radius: 12px;
            color: white;
            text-align: center;
            backdrop-filter: blur(5px);
          }

          .rank-item.top3 {
            background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,165,0,0.3) 100%);
            border: 2px solid rgba(255,215,0,0.5);
          }

          .rank-item.current-user {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.3) 0%, rgba(52, 152, 219, 0.3) 100%);
            border: 2px solid rgba(46, 204, 113, 0.6);
          }

          .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
          }

          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }

          @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }

          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        `;
        document.head.appendChild(style);
      }
    }

    bindEvents() {
      // ë­í‚¹ ë²„íŠ¼ ì´ë²¤íŠ¸
      const rankingBtn = document.getElementById('rankingBtn');
      if (rankingBtn && !rankingBtn.hasAttribute('data-bound')) {
        rankingBtn.setAttribute('data-bound', 'true');
        rankingBtn.addEventListener('click', () => {
          this.showLeaderboard();
          if (typeof playSound === 'function') playSound('success');
        });
      }

      // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
      const modal = document.getElementById('leaderboardModal');
      if (modal) {
        const closeBtn = modal.querySelector('.close');
        if (closeBtn && !closeBtn.hasAttribute('data-bound')) {
          closeBtn.setAttribute('data-bound', 'true');
          closeBtn.addEventListener('click', () => {
            this.hideLeaderboard();
          });
        }

        if (!modal.hasAttribute('data-bound')) {
          modal.setAttribute('data-bound', 'true');
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              this.hideLeaderboard();
            }
          });
        }

        // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
        const tabBtns = modal.querySelectorAll('.tab-btn');
        tabBtns.forEach(btn => {
          if (!btn.hasAttribute('data-bound')) {
            btn.setAttribute('data-bound', 'true');
            btn.addEventListener('click', () => {
              const tab = btn.getAttribute('data-tab');
              this.switchTab(tab);
              if (typeof playSound === 'function') playSound('click');
            });
          }
        });
      }
    }

    async showLeaderboard() {
      const modal = document.getElementById('leaderboardModal');
      modal.style.display = 'block';
      
      // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
      this.displayUserRank();
      
      // ê° íƒ­ì˜ ë°ì´í„° ë¡œë“œ
      await this.loadRankingData('global');
      await this.loadRankingData('today');
      await this.loadRankingData('week');
      await this.loadRankingData('friends');
    }

    hideLeaderboard() {
      const modal = document.getElementById('leaderboardModal');
      modal.style.display = 'none';
    }

    switchTab(tabName) {
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      const tabBtns = document.querySelectorAll('.tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });

      // ë­í‚¹ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
      const rankingLists = document.querySelectorAll('.ranking-list');
      rankingLists.forEach(list => {
        list.classList.toggle('active', list.id === tabName + 'Ranking');
      });
    }

    async loadRankingData(type) {
      const container = document.getElementById(type + 'Ranking');
      container.innerHTML = '<div class="loading-spinner"></div> ë°ì´í„° ë¡œë”© ì¤‘...';

      try {
        let data;
        switch(type) {
          case 'global':
            data = await this.getGlobalRanking();
            break;
          case 'today':
            data = await this.getTodayRanking();
            break;
          case 'week':
            data = await this.getWeekRanking();
            break;
          case 'friends':
            data = await this.getFriendsRanking();
            break;
        }

        this.renderRankingList(container, data, type);
      } catch (error) {
        container.innerHTML = 'âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        console.error('Ranking data load error:', error);
      }
    }

    async getGlobalRanking() {
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê¸€ë¡œë²Œ ë­í‚¹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const stored = localStorage.getItem(this.storageKey);
      let rankings = stored ? JSON.parse(stored) : [];
      
      // ì ìˆ˜ìˆœìœ¼ë¡œ ì •ë ¬
      rankings.sort((a, b) => b.score - a.score);
      
      return rankings.slice(0, 50); // ìƒìœ„ 50ëª…ë§Œ
    }

    async getTodayRanking() {
      const today = new Date().toDateString();
      const rankings = await this.getGlobalRanking();
      return rankings.filter(item => 
        new Date(item.timestamp).toDateString() === today
      ).slice(0, 20);
    }

    async getWeekRanking() {
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      const rankings = await this.getGlobalRanking();
      return rankings.filter(item => 
        new Date(item.timestamp) >= weekAgo
      ).slice(0, 30);
    }

    async getFriendsRanking() {
      // ì¹œêµ¬ ì‹œìŠ¤í…œì€ ì¶”í›„ êµ¬í˜„ (í˜„ì¬ëŠ” ì‚¬ìš©ì ë°ì´í„°ë§Œ)
      const userProfile = this.getUserProfile();
      if (!userProfile.bestScore) return [];

      return [
        {
          name: 'ë‚˜',
          score: userProfile.bestScore,
          result: userProfile.lastResult || 'ê°ì„± ì—°ë ¹',
          timestamp: userProfile.lastPlayed || Date.now(),
          isFriend: true,
          isCurrentUser: true
        }
      ];
    }

    renderRankingList(container, data, type) {
      if (!data || data.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: rgba(255,255,255,0.7); padding: 40px;">
            ğŸ† ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
            ì²« ë²ˆì§¸ë¡œ ê¸°ë¡ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
          </div>
        `;
        return;
      }

      const html = data.map((item, index) => {
        const rank = index + 1;
        const medal = this.getMedalIcon(rank);
        const isTopThree = rank <= 3;
        const isCurrentUser = item.isCurrentUser;
        
        return `
          <div class="rank-item ${isTopThree ? 'top3' : ''} ${isCurrentUser ? 'current-user' : ''}">
            <div class="rank-number">
              ${medal || rank}
            </div>
            <div class="rank-info">
              <div class="rank-name">
                ${item.name || 'ìµëª…ì˜ ì‚¬ìš©ì'}
                ${isCurrentUser ? ' (ë‚˜)' : ''}
              </div>
              <div class="rank-details">
                ${item.result || 'ê°ì„± ì—°ë ¹'} â€¢ ${this.formatDate(item.timestamp)}
              </div>
            </div>
            <div class="rank-score">
              ${item.score}ì 
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    getMedalIcon(rank) {
      const medals = {
        1: 'ğŸ¥‡',
        2: 'ğŸ¥ˆ', 
        3: 'ğŸ¥‰'
      };
      return medals[rank];
    }

    formatDate(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMinutes = Math.floor((now - date) / (1000 * 60));
      
      if (diffMinutes < 1) return 'ë°©ê¸ˆ ì „';
      if (diffMinutes < 60) return `${diffMinutes}ë¶„ ì „`;
      if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}ì‹œê°„ ì „`;
      
      return date.toLocaleDateString('ko-KR');
    }

    recordResult(name, score, result) {
      const stored = localStorage.getItem(this.storageKey);
      let rankings = stored ? JSON.parse(stored) : [];
      
      const newEntry = {
        id: Date.now() + Math.random(),
        name: name || 'ìµëª…ì˜ ì‚¬ìš©ì',
        score: score,
        result: result,
        timestamp: Date.now(),
        userAgent: navigator.userAgent.slice(0, 50)
      };
      
      rankings.push(newEntry);
      
      // ìµœëŒ€ ê°œìˆ˜ ì œí•œ
      if (rankings.length > this.maxEntries) {
        rankings = rankings.slice(-this.maxEntries);
      }
      
      localStorage.setItem(this.storageKey, JSON.stringify(rankings));
      
      // ì‚¬ìš©ì í”„ë¡œí•„ ì—…ë°ì´íŠ¸
      this.updateUserProfile(newEntry);
      
      // ì„œë²„ì™€ ë™ê¸°í™” (ì¶”í›„ êµ¬í˜„)
      this.syncWithServer();
      
      // ìƒˆë¡œìš´ ê¸°ë¡ ì•Œë¦¼
      this.showRankingAchievement(score, result);
    }

    updateUserProfile(entry) {
      const currentProfile = this.getUserProfile();
      const profile = {
        bestScore: Math.max(entry.score, currentProfile.bestScore || 0),
        lastResult: entry.result,
        lastPlayed: entry.timestamp,
        totalPlays: (currentProfile.totalPlays || 0) + 1
      };
      
      localStorage.setItem(this.userStorageKey, JSON.stringify(profile));
    }

    getUserProfile() {
      const stored = localStorage.getItem(this.userStorageKey);
      return stored ? JSON.parse(stored) : {};
    }

    displayUserRank() {
      const profile = this.getUserProfile();
      const container = document.getElementById('userRankDisplay');
      
      if (!profile.bestScore) {
        container.innerHTML = 'ğŸ¯ ì²« í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ê³  ë­í‚¹ì— ë„ì „í•˜ì„¸ìš”!';
        return;
      }

      this.getGlobalRanking().then(rankings => {
        const userRank = rankings.findIndex(item => 
          item.score <= profile.bestScore
        ) + 1;

        container.innerHTML = `
          <div>
            ğŸ† ë‚´ ìµœê³  ê¸°ë¡: <strong>${profile.bestScore}ì </strong><br>
            ğŸ“Š ì „ì²´ ë­í‚¹: <strong>${userRank > 0 ? userRank + 'ìœ„' : 'ìˆœìœ„ ì§‘ê³„ ì¤‘'}</strong><br>
            ğŸ® ì´ í”Œë ˆì´: <strong>${profile.totalPlays || 1}íšŒ</strong>
          </div>
        `;
      });
    }

    getCurrentUserScore() {
      return this.getUserProfile().bestScore || 0;
    }

    getCurrentUserResult() {
      return this.getUserProfile().lastResult || 'ê°ì„± ì—°ë ¹';
    }

    showRankingAchievement(score, result) {
      // ìˆœìœ„ ë‹¬ì„± ì•Œë¦¼ í‘œì‹œ
      setTimeout(() => {
        this.getGlobalRanking().then(rankings => {
          const rank = rankings.findIndex(item => item.score <= score) + 1;
          
          if (rank <= 10) {
            if (typeof showQuickToast === 'function') {
              showQuickToast(`ğŸ† ì¶•í•˜í•©ë‹ˆë‹¤! ì „ì²´ ${rank}ìœ„ì— ë­í¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
            this.createCelebrationEffect();
          } else if (rank <= 50) {
            if (typeof showQuickToast === 'function') {
              showQuickToast(`ğŸ‰ ì¢‹ì€ ê²°ê³¼! ìƒìœ„ 50ìœ„ ì•ˆì— ë“¤ì—ˆì–´ìš”!`);
            }
          }
        });
      }, 2000);
    }

    createCelebrationEffect() {
      // ì¶•í•˜ íŒŒí‹°í´ íš¨ê³¼
      const colors = ['#FFD700', '#FFA500', '#FF69B4', '#00CED1', '#32CD32'];
      
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const particle = document.createElement('div');
          particle.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            border-radius: 50%;
            pointer-events: none;
            z-index: 10001;
            animation: celebrate 2s ease-out forwards;
          `;
          
          const angle = (i * 18) * Math.PI / 180;
          const distance = 200 + Math.random() * 100;
          const endX = Math.cos(angle) * distance;
          const endY = Math.sin(angle) * distance;
          
          particle.style.setProperty('--endX', endX + 'px');
          particle.style.setProperty('--endY', endY + 'px');
          
          document.body.appendChild(particle);
          
          setTimeout(() => particle.remove(), 2000);
        }, i * 50);
      }
      
      // ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
      if (!document.querySelector('#celebration-style')) {
        const style = document.createElement('style');
        style.id = 'celebration-style';
        style.textContent = `
          @keyframes celebrate {
            0% {
              transform: translate(-50%, -50%) scale(1);
              opacity: 1;
            }
            100% {
              transform: translate(calc(-50% + var(--endX)), calc(-50% + var(--endY))) scale(0);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    async syncWithServer() {
      // ì‹¤ì œ ì„œë²„ ë™ê¸°í™”ëŠ” ì¶”í›„ êµ¬í˜„
      // í˜„ì¬ëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë§Œ ì‚¬ìš©
      return Promise.resolve();
    }
  }

  // ì†Œì…œ ë­í‚¹ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
  window.socialRanking = new SocialRanking();

  // ========== ê°œì¸í™”ëœ ì¶”ì²œ ì‹œìŠ¤í…œ ==========
  
  class PersonalizedRecommendation {
    constructor() {
      this.storageKey = 'ageVibePersonalization';
      this.analysisKey = 'ageVibeUserAnalysis';
      this.recommendations = [];
      this.userProfile = null;
      this.init();
    }

    init() {
      this.loadUserProfile();
      this.createRecommendationUI();
      this.bindEvents();
    }

    loadUserProfile() {
      const stored = localStorage.getItem(this.analysisKey);
      this.userProfile = stored ? JSON.parse(stored) : {
        testHistory: [],
        preferences: {
          categories: {},
          timePatterns: [],
          emotionalTrends: []
        },
        personality: {
          decisionSpeed: 'moderate',
          riskTaking: 'balanced',
          socialness: 'moderate',
          creativity: 'balanced'
        },
        interactions: {
          mostClickedOptions: [],
          favoriteTimes: [],
          deviceUsage: {},
          sessionLengths: []
        }
      };
    }

    createRecommendationUI() {
      // ë²„íŠ¼ì€ ì´ë¯¸ HTMLì— í†µí•©ë˜ì–´ ìˆìŒ

      // ì¶”ì²œ ëª¨ë‹¬ ì°½ ìƒì„±
      if (!document.getElementById('recommendationModal')) {
        const modal = document.createElement('div');
        modal.id = 'recommendationModal';
        modal.className = 'recommendation-modal';
        modal.innerHTML = `
          <div class="recommendation-content">
            <div class="recommendation-header">
              <h2>ğŸ¯ ë‹¹ì‹ ì„ ìœ„í•œ ë§ì¶¤ ì¶”ì²œ</h2>
              <span class="rec-close">&times;</span>
            </div>
            
            <div class="recommendation-tabs">
              <button class="rec-tab-btn active" data-tab="insights">ğŸ§  ì¸ì‚¬ì´íŠ¸</button>
              <button class="rec-tab-btn" data-tab="actions">ğŸ¯ ì¶”ì²œ í–‰ë™</button>
              <button class="rec-tab-btn" data-tab="similar">ğŸ‘¥ ìœ ì‚¬í•œ ì‚¬ìš©ì</button>
              <button class="rec-tab-btn" data-tab="growth">ğŸ“ˆ ì„±ì¥ ê²½ë¡œ</button>
            </div>
            
            <div class="recommendation-body">
              <div id="insightsTab" class="rec-tab-content active">
                <div id="personalInsights"></div>
              </div>
              
              <div id="actionsTab" class="rec-tab-content">
                <div id="recommendedActions"></div>
              </div>
              
              <div id="similarTab" class="rec-tab-content">
                <div id="similarUsers"></div>
              </div>
              
              <div id="growthTab" class="rec-tab-content">
                <div id="growthPath"></div>
              </div>
            </div>
            
            <div class="recommendation-footer">
              <button id="updateProfileBtn" class="update-profile-btn">í”„ë¡œí•„ ì—…ë°ì´íŠ¸</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // ì¶”ì²œ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ ì¶”ê°€
      if (!document.getElementById('recommendation-styles')) {
        const style = document.createElement('style');
        style.id = 'recommendation-styles';
        style.textContent = `
          .recommendation-modal {
            display: none;
            position: fixed;
            z-index: 10001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
          }

          .recommendation-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 3% auto;
            padding: 0;
            border-radius: 25px;
            width: 92%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: slideUp 0.4s ease;
          }

          .recommendation-header {
            background: rgba(255,255,255,0.15);
            padding: 25px;
            border-radius: 25px 25px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(15px);
          }

          .recommendation-header h2 {
            color: white;
            margin: 0;
            font-size: 26px;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
          }

          .rec-close {
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
          }

          .rec-close:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
          }

          .recommendation-tabs {
            display: flex;
            padding: 0 25px;
            background: rgba(255,255,255,0.08);
            flex-wrap: wrap;
          }

          .rec-tab-btn {
            flex: 1;
            min-width: 140px;
            padding: 15px 10px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin: 0 2px;
          }

          .rec-tab-btn.active,
          .rec-tab-btn:hover {
            color: white;
            border-bottom-color: #ffd700;
            background: rgba(255,255,255,0.1);
          }

          .recommendation-body {
            padding: 25px;
            min-height: 400px;
          }

          .rec-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
          }

          .rec-tab-content.active {
            display: block;
          }

          .insight-card {
            background: rgba(255,255,255,0.1);
            margin: 15px 0;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
          }

          .insight-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          }

          .insight-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
          }

          .insight-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.6;
            font-size: 14px;
          }

          .insight-score {
            display: inline-block;
            background: linear-gradient(90deg, #ffd700, #ffed4a);
            color: #2c2c2c;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 10px;
          }

          .action-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            margin: 12px 0;
            padding: 18px;
            border-radius: 12px;
            border-left: 4px solid #4ecdc4;
            transition: all 0.3s ease;
          }

          .action-item:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.1) 100%);
            transform: translateX(5px);
          }

          .action-title {
            font-size: 16px;
            font-weight: 600;
            color: #4ecdc4;
            margin-bottom: 8px;
          }

          .action-description {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            line-height: 1.5;
          }

          .similarity-user {
            background: rgba(255,255,255,0.08);
            margin: 10px 0;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
          }

          .similarity-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
          }

          .similarity-info {
            flex-grow: 1;
            color: white;
          }

          .similarity-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
          }

          .similarity-stats {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
          }

          .similarity-score {
            background: #4ecdc4;
            color: #2c2c2c;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
          }

          .growth-step {
            background: rgba(255,255,255,0.1);
            margin: 15px 0;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
          }

          .growth-step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 15px;
            padding: 2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: exclude;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
          }

          .growth-step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 10px;
          }

          .growth-step-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffd700;
            margin-bottom: 8px;
          }

          .growth-step-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.5;
            font-size: 14px;
          }

          .recommendation-footer {
            background: rgba(255,255,255,0.05);
            padding: 20px 25px;
            border-radius: 0 0 25px 25px;
            text-align: center;
          }

          .update-profile-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #2c2c2c;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
          }

          .update-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
          }

          .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
          }

          .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            border-radius: 4px;
            transition: width 1s ease;
          }

          @media (max-width: 768px) {
            .recommendation-content {
              margin: 1% auto;
              width: 95%;
              max-height: 95vh;
            }
            
            .rec-tab-btn {
              min-width: 100px;
              font-size: 12px;
              padding: 12px 8px;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    bindEvents() {
      // ì¶”ì²œ ë²„íŠ¼ ì´ë²¤íŠ¸
      const recBtn = document.getElementById('recommendationBtn');
      if (recBtn && !recBtn.hasAttribute('data-bound')) {
        recBtn.setAttribute('data-bound', 'true');
        recBtn.addEventListener('click', () => {
          this.showRecommendations();
          if (typeof playSound === 'function') playSound('success');
        });
      }

      // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
      const modal = document.getElementById('recommendationModal');
      if (modal) {
        const closeBtn = modal.querySelector('.rec-close');
        if (closeBtn && !closeBtn.hasAttribute('data-bound')) {
          closeBtn.setAttribute('data-bound', 'true');
          closeBtn.addEventListener('click', () => {
            this.hideRecommendations();
          });
        }

        if (!modal.hasAttribute('data-bound')) {
          modal.setAttribute('data-bound', 'true');
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              this.hideRecommendations();
            }
          });
        }

        // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
        const tabBtns = modal.querySelectorAll('.rec-tab-btn');
        tabBtns.forEach(btn => {
          if (!btn.hasAttribute('data-bound')) {
            btn.setAttribute('data-bound', 'true');
            btn.addEventListener('click', () => {
              const tab = btn.getAttribute('data-tab');
              this.switchRecommendationTab(tab);
              if (typeof playSound === 'function') playSound('click');
            });
          }
        });

        // í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ë²„íŠ¼
        const updateBtn = modal.querySelector('#updateProfileBtn');
        if (updateBtn && !updateBtn.hasAttribute('data-bound')) {
          updateBtn.setAttribute('data-bound', 'true');
          updateBtn.addEventListener('click', () => {
            this.updateUserProfile();
            if (typeof playSound === 'function') playSound('success');
          });
        }
      }
    }

    showRecommendations() {
      const modal = document.getElementById('recommendationModal');
      modal.style.display = 'block';
      
      // ë°ì´í„° ë¶„ì„ ë° ì¶”ì²œ ìƒì„±
      this.analyzeUserBehavior();
      this.generatePersonalizedRecommendations();
      
      // ê° íƒ­ ë‚´ìš© ë¡œë“œ
      this.loadInsights();
      this.loadRecommendedActions();
      this.loadSimilarUsers();
      this.loadGrowthPath();
    }

    hideRecommendations() {
      const modal = document.getElementById('recommendationModal');
      modal.style.display = 'none';
    }

    switchRecommendationTab(tabName) {
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      const tabBtns = document.querySelectorAll('.rec-tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });

      // íƒ­ ë‚´ìš© í‘œì‹œ
      const tabContents = document.querySelectorAll('.rec-tab-content');
      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === tabName + 'Tab');
      });
    }

    analyzeUserBehavior() {
      // ì‚¬ìš©ì í–‰ë™ íŒ¨í„´ ë¶„ì„
      const stats = typeof getStats === 'function' ? getStats() : {};
      const emotionData = emotionAnalyzer || {};
      const testHistory = this.userProfile.testHistory || [];

      // í…ŒìŠ¤íŠ¸ íŒ¨í„´ ë¶„ì„
      if (stats.totalTests > 0) {
        this.userProfile.preferences.categories = stats.resultCounts || {};
        
        // ê²°ì • ì†ë„ ë¶„ì„
        if (emotionData.clickTiming && emotionData.clickTiming.length > 0) {
          const avgTime = emotionData.clickTiming.reduce((a, b) => a + b) / emotionData.clickTiming.length;
          this.userProfile.personality.decisionSpeed = 
            avgTime < 3000 ? 'fast' : avgTime > 8000 ? 'slow' : 'moderate';
        }

        // í˜¸ë²„ íŒ¨í„´ìœ¼ë¡œ ì‹ ì¤‘í•¨ ì¸¡ì •
        if (emotionData.hoverPatterns && emotionData.hoverPatterns.length > 0) {
          const avgHover = emotionData.hoverPatterns.reduce((sum, h) => sum + h.count, 0) / emotionData.hoverPatterns.length;
          this.userProfile.personality.riskTaking = 
            avgHover > 3 ? 'conservative' : avgHover < 1.5 ? 'bold' : 'balanced';
        }
      }

      // ì‹œê°„ëŒ€ë³„ í™œë™ íŒ¨í„´
      const currentHour = new Date().getHours();
      this.userProfile.interactions.favoriteTimes.push(currentHour);

      // ê¸°ê¸° ì‚¬ìš© íŒ¨í„´
      const deviceType = /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'mobile' : 'desktop';
      this.userProfile.interactions.deviceUsage[deviceType] = 
        (this.userProfile.interactions.deviceUsage[deviceType] || 0) + 1;

      // í”„ë¡œí•„ ì €ì¥
      localStorage.setItem(this.analysisKey, JSON.stringify(this.userProfile));
    }

    generatePersonalizedRecommendations() {
      const personality = this.userProfile.personality;
      const preferences = this.userProfile.preferences;
      const stats = typeof getStats === 'function' ? getStats() : {};

      this.recommendations = {
        insights: this.generateInsights(personality, preferences, stats),
        actions: this.generateActions(personality, preferences),
        similar: this.generateSimilarUsers(personality, preferences),
        growth: this.generateGrowthPath(personality, stats)
      };
    }

    generateInsights(personality, preferences, stats) {
      const insights = [];

      // ê²°ì • ìŠ¤íƒ€ì¼ ì¸ì‚¬ì´íŠ¸
      if (personality.decisionSpeed === 'fast') {
        insights.push({
          title: 'âš¡ ì§ê´€ì  ê²°ì •ì',
          description: 'ë¹ ë¥¸ ê²°ì •ì„ ë‚´ë¦¬ëŠ” í¸ì´êµ°ìš”! ì§ê°ì„ ë¯¿ê³  í–‰ë™í•˜ëŠ” íƒ€ì…ìœ¼ë¡œ, ê¸°íšŒë¥¼ ì˜ ì¡ëŠ” ì„±í–¥ì„ ë³´ì…ë‹ˆë‹¤.',
          score: 'ì§ê´€ë ¥ 85%',
          color: '#ff6b6b'
        });
      } else if (personality.decisionSpeed === 'slow') {
        insights.push({
          title: 'ğŸ¤” ì‹ ì¤‘í•œ ë¶„ì„ì',
          description: 'ì‹ ì¤‘í•˜ê²Œ ê³ ë¯¼í•˜ê³  ê²°ì •í•˜ì‹œëŠ”êµ°ìš”. ì„¸ì‹¬í•œ ë¶„ì„ì„ í†µí•´ ìµœì ì˜ ì„ íƒì„ í•˜ë ¤ëŠ” ë…¸ë ¥ì´ ë‹ë³´ì…ë‹ˆë‹¤.',
          score: 'ë¶„ì„ë ¥ 92%',
          color: '#4ecdc4'
        });
      }

      // ìœ„í—˜ ì„ í˜¸ë„ ì¸ì‚¬ì´íŠ¸  
      if (personality.riskTaking === 'bold') {
        insights.push({
          title: 'ğŸš€ ëª¨í—˜ê°€ ê¸°ì§ˆ',
          description: 'ìƒˆë¡œìš´ ë„ì „ì„ ì¦ê¸°ê³  ìœ„í—˜ì„ ë‘ë ¤ì›Œí•˜ì§€ ì•ŠëŠ” ì„±í–¥ì…ë‹ˆë‹¤. í˜ì‹ ì ì¸ ì•„ì´ë””ì–´ë¥¼ ì¶”êµ¬í•˜ëŠ” íƒ€ì…ì´ì—ìš”.',
          score: 'ë„ì „ì„± 88%',
          color: '#667eea'
        });
      } else if (personality.riskTaking === 'conservative') {
        insights.push({
          title: 'ğŸ›¡ï¸ ì•ˆì • ì¶”êµ¬ì',
          description: 'ì‹ ì¤‘í•˜ê³  ì•ˆì •ì ì¸ ì„ íƒì„ ì„ í˜¸í•˜ì‹œë„¤ìš”. ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•˜ë©° í™•ì‹¤í•œ ì„±ê³¼ë¥¼ ì¶”êµ¬í•˜ëŠ” ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤.',
          score: 'ì•ˆì •ì„± 90%',
          color: '#95a5a6'
        });
      }

      // ê°ì„± ì—°ë ¹ íŒ¨í„´ ë¶„ì„
      if (stats.totalTests > 2) {
        const mostCommon = Object.keys(preferences.categories).reduce((a, b) => 
          preferences.categories[a] > preferences.categories[b] ? a : b
        );
        
        const ageInsights = {
          teen: { title: 'ğŸŒŸ ì˜ ìŠ¤í”¼ë¦¿', description: 'ì Šê³  ì—­ë™ì ì¸ ì—ë„ˆì§€ê°€ ê°€ë“! ìƒˆë¡œìš´ íŠ¸ë Œë“œì™€ ë³€í™”ë¥¼ ë¹ ë¥´ê²Œ ë°›ì•„ë“¤ì´ëŠ” íƒ€ì…ì…ë‹ˆë‹¤.' },
          twenties: { title: 'ğŸ’« íŠ¸ë Œë”” ì„¼ìŠ¤', description: 'ìµœì‹  íŠ¸ë Œë“œì— ë¯¼ê°í•˜ë©° ì°½ì˜ì  ì‚¬ê³ ê°€ ë›°ì–´ë‚˜ë„¤ìš”. ê· í˜•ê°ê°ë„ í›Œë¥­í•©ë‹ˆë‹¤!' },
          thirties: { title: 'âš–ï¸ ë°¸ëŸ°ìŠ¤ ë§ˆìŠ¤í„°', description: 'ì„±ìˆ™í•¨ê³¼ í™œë ¥ì„ ë™ì‹œì— ê°–ì¶˜ ê· í˜•ì¡íŒ ì„±í–¥ì„ ë³´ì…ë‹ˆë‹¤. ë¦¬ë”ì‹­ì´ ë›°ì–´ë‚˜ìš”!' },
          forties: { title: 'ğŸƒ í´ë˜ì‹ ìš°ì•„í•¨', description: 'ê¹Šì´ ìˆëŠ” ì‚¬ê³ ì™€ ìš°ì•„í•œ í’ˆê²©ì„ ê°–ì¶”ì—ˆë„¤ìš”. ì „í†µê³¼ í˜ì‹ ì„ ì¡°í™”ì‹œí‚¤ëŠ” ëŠ¥ë ¥ì´ ìˆìŠµë‹ˆë‹¤.' }
        };
        
        if (ageInsights[mostCommon]) {
          insights.push({
            title: ageInsights[mostCommon].title,
            description: ageInsights[mostCommon].description,
            score: `ì¼ê´€ì„± ${Math.round((preferences.categories[mostCommon] / stats.totalTests) * 100)}%`,
            color: '#ffd700'
          });
        }
      }

      return insights;
    }

    generateActions(personality, preferences) {
      const actions = [];

      if (personality.decisionSpeed === 'fast') {
        actions.push({
          title: 'â¸ï¸ ì ì‹œ ë©ˆì¶¤ ì—°ìŠµ',
          description: 'ê°€ë”ì€ ì†ë„ë¥¼ ëŠ¦ì¶”ê³  ë” ê¹Šì´ ìƒê°í•´ë³´ì„¸ìš”. ëª…ìƒì´ë‚˜ ì¼ê¸° ì“°ê¸° ê°™ì€ í™œë™ì´ ë„ì›€ë  ê±°ì˜ˆìš”.'
        });
        actions.push({
          title: 'ğŸ¯ ëª©í‘œ ì„¤ì • ì‹œê°„',
          description: 'ë¹ ë¥¸ ê²°ì •ë ¥ì„ ì¥ê¸° ëª©í‘œ ë‹¬ì„±ì— í™œìš©í•´ë³´ì„¸ìš”. ë‹¨ê³„ë³„ ê³„íšì„ ì„¸ìš°ë©´ ë” í° ì„±ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì–´ìš”.'
        });
      } else if (personality.decisionSpeed === 'slow') {
        actions.push({
          title: 'âš¡ ì§ê° í›ˆë ¨',
          description: 'ê°€ë”ì€ ì²« ë²ˆì§¸ ìƒê°ì„ ë¯¿ì–´ë³´ì„¸ìš”. ì‘ì€ ê²°ì •ë¶€í„° ì§ê°ìœ¼ë¡œ í•´ë³´ëŠ” ì—°ìŠµì„ í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?'
        });
        actions.push({
          title: 'â° ì‹œê°„ ì œí•œ ë„ì „',
          description: 'ì˜ì‚¬ê²°ì •ì— ì‹œê°„ ì œí•œì„ ë‘ê³  ì—°ìŠµí•´ë³´ì„¸ìš”. ìŠ¤í”¼ë“œ ê²°ì • ê²Œì„ì´ë‚˜ í€´ì¦ˆì— ë„ì „í•´ë³´ëŠ” ê²ƒë„ ì¢‹ì•„ìš”.'
        });
      }

      if (personality.riskTaking === 'conservative') {
        actions.push({
          title: 'ğŸŒ± ì‘ì€ ëª¨í—˜ ì‹œì‘',
          description: 'ì•ˆì „í•œ ë²”ìœ„ì—ì„œ ì‘ì€ ë„ì „ì„ ì‹œë„í•´ë³´ì„¸ìš”. ìƒˆë¡œìš´ ì·¨ë¯¸ë‚˜ ë§›ì§‘ íƒë°©ë¶€í„° ì‹œì‘í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?'
        });
      } else if (personality.riskTaking === 'bold') {
        actions.push({
          title: 'ğŸ“Š ë¦¬ìŠ¤í¬ ê´€ë¦¬ í•™ìŠµ',
          description: 'ëª¨í—˜ì‹¬ì„ ë” íš¨ê³¼ì ìœ¼ë¡œ í™œìš©í•˜ê¸° ìœ„í•´ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë°©ë²•ì„ ë°°ì›Œë³´ì„¸ìš”. ê³„íšì ì¸ ë„ì „ì´ ë” í° ì„±ê³¼ë¥¼ ê°€ì ¸ë‹¤ ì¤„ ê±°ì˜ˆìš”.'
        });
      }

      // ì¼ë°˜ì ì¸ ì¶”ì²œ
      actions.push({
        title: 'ğŸ“š ìê¸°ê³„ë°œ ë…ì„œ',
        description: 'ë‹¹ì‹ ì˜ ì„±í–¥ì— ë§ëŠ” ìê¸°ê³„ë°œì„œë¥¼ ì½ì–´ë³´ì„¸ìš”. ì„±ì¥ê³¼ ë³€í™”ì˜ ê¸°íšŒê°€ ë  ê²ƒì…ë‹ˆë‹¤.'
      });

      actions.push({
        title: 'ğŸ¤ ë„¤íŠ¸ì›Œí‚¹ í™œë™',
        description: 'ë¹„ìŠ·í•œ ê´€ì‹¬ì‚¬ë¥¼ ê°€ì§„ ì‚¬ëŒë“¤ê³¼ êµë¥˜í•´ë³´ì„¸ìš”. ìƒˆë¡œìš´ ê´€ì ê³¼ ê¸°íšŒë¥¼ ë°œê²¬í•  ìˆ˜ ìˆì–´ìš”.'
      });

      return actions;
    }

    generateSimilarUsers(personality, preferences) {
      // ìœ ì‚¬í•œ ì‚¬ìš©ì í”„ë¡œí•„ ìƒì„± (ì‹œë®¬ë ˆì´ì…˜)
      const similar = [];
      
      const profiles = [
        { name: 'ëª¨í—˜ê°€ ê¹€OO', avatar: 'ğŸš€', similarity: 87, description: 'ë¹ ë¥¸ ê²°ì •, ë„ì „ì  ì„±í–¥' },
        { name: 'ë¶„ì„ê°€ ì´OO', avatar: 'ğŸ¤”', similarity: 82, description: 'ì‹ ì¤‘í•¨, ì²´ê³„ì  ì‚¬ê³ ' },
        { name: 'ê· í˜•ëŸ¬ ë°•OO', avatar: 'âš–ï¸', similarity: 79, description: 'ì•ˆì •ì„±ê³¼ ì°½ì˜ì„±ì˜ ì¡°í™”' },
        { name: 'íŠ¸ë Œë”” ìµœOO', avatar: 'âœ¨', similarity: 85, description: 'ê°ê°ì  ì„ íƒ, ìœ í–‰ ì„ ë„' },
        { name: 'í´ë˜ì‹ ì •OO', avatar: 'ğŸ­', similarity: 76, description: 'ì „í†µì  ê°€ì¹˜, ê¹Šì´ ìˆëŠ” ì‚¬ê³ ' }
      ];

      // ì„±í–¥ì— ë”°ë¼ ìœ ì‚¬ë„ ì¡°ì •
      return profiles.map(profile => ({
        ...profile,
        similarity: Math.max(60, Math.min(95, profile.similarity + Math.random() * 10 - 5))
      })).sort((a, b) => b.similarity - a.similarity).slice(0, 3);
    }

    generateGrowthPath(personality, stats) {
      const steps = [];
      
      steps.push({
        number: 1,
        title: 'í˜„ì¬ ìƒíƒœ íŒŒì•…',
        description: `ì´ ${stats.totalTests || 0}íšŒ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ìì‹ ì˜ ì„±í–¥ì„ íŒŒì•…í–ˆìŠµë‹ˆë‹¤. ì´ì œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë‚˜ì•„ê°ˆ ì‹œê°„ì´ì—ìš”!`
      });

      if (personality.decisionSpeed === 'fast') {
        steps.push({
          number: 2,
          title: 'ì‹ ì¤‘í•¨ ê¸°ë¥´ê¸°',
          description: 'ë¹ ë¥¸ íŒë‹¨ë ¥ì— ì‹ ì¤‘í•¨ì„ ë”í•˜ë©´ ë”ìš± ì™„ì„±ë„ ë†’ì€ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì„ íƒ ì „ 10ì´ˆë§Œ ë” ìƒê°í•´ë³´ì„¸ìš”.'
        });
      } else {
        steps.push({
          number: 2,
          title: 'ê²°ì •ë ¥ í‚¤ìš°ê¸°',
          description: 'ì‹ ì¤‘í•¨ì— ê²°ë‹¨ë ¥ì„ ë”í•´ë³´ì„¸ìš”. ì‘ì€ ì„ íƒë¶€í„° ë¹ ë¥´ê²Œ ê²°ì •í•˜ëŠ” ì—°ìŠµì„ í†µí•´ ìì‹ ê°ì„ í‚¤ìš¸ ìˆ˜ ìˆì–´ìš”.'
        });
      }

      steps.push({
        number: 3,
        title: 'ìƒˆë¡œìš´ ì˜ì—­ íƒìƒ‰',
        description: 'ì§€ê¸ˆê¹Œì§€ ì‹œë„í•˜ì§€ ì•Šì•˜ë˜ ìƒˆë¡œìš´ ë¶„ì•¼ì— ë„ì „í•´ë³´ì„¸ìš”. ë‹¤ì–‘í•œ ê²½í—˜ì´ ë” í’ë¶€í•œ ë‚´ë©´ì„ ë§Œë“¤ì–´ ì¤„ ê²ƒì…ë‹ˆë‹¤.'
      });

      steps.push({
        number: 4,
        title: 'ê· í˜•ì  ì°¾ê¸°',
        description: 'ìì‹ ë§Œì˜ ë…íŠ¹í•œ ë°¸ëŸ°ìŠ¤ë¥¼ ì°¾ì•„ë³´ì„¸ìš”. ê°•ì ì„ ë”ìš± ë°œì „ì‹œí‚¤ë©´ì„œë„ ì•½ì ì„ ë³´ì™„í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•´ìš”.'
      });

      steps.push({
        number: 5,
        title: 'ì˜í–¥ë ¥ í™•ì¥',
        description: 'ì„±ì¥í•œ ìì‹ ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œë„ ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì³ë³´ì„¸ìš”. ë¦¬ë”ì‹­ê³¼ ë©˜í† ë§ ëŠ¥ë ¥ì„ ë°œíœ˜í•  ë•Œì…ë‹ˆë‹¤.'
      });

      return steps;
    }

    loadInsights() {
      const container = document.getElementById('personalInsights');
      const insights = this.recommendations.insights || [];

      const html = insights.map(insight => `
        <div class="insight-card" style="border-left: 4px solid ${insight.color}">
          <div class="insight-title">
            ${insight.title}
          </div>
          <div class="insight-description">
            ${insight.description}
          </div>
          <div class="insight-score">${insight.score}</div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="insight-card"><div class="insight-description">ë” ë§ì€ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ê°œì¸í™”ëœ ì¸ì‚¬ì´íŠ¸ë¥¼ ë°›ì•„ë³´ì„¸ìš”!</div></div>';
    }

    loadRecommendedActions() {
      const container = document.getElementById('recommendedActions');
      const actions = this.recommendations.actions || [];

      const html = actions.map(action => `
        <div class="action-item">
          <div class="action-title">${action.title}</div>
          <div class="action-description">${action.description}</div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="action-item"><div class="action-description">ê°œì¸ ë§ì¶¤ ì¶”ì²œì„ ìœ„í•´ ë” ë§ì€ ë°ì´í„°ê°€ í•„ìš”í•´ìš”!</div></div>';
    }

    loadSimilarUsers() {
      const container = document.getElementById('similarUsers');
      const similar = this.recommendations.similar || [];

      const html = similar.map(user => `
        <div class="similarity-user">
          <div class="similarity-avatar">${user.avatar}</div>
          <div class="similarity-info">
            <div class="similarity-name">${user.name}</div>
            <div class="similarity-stats">${user.description}</div>
          </div>
          <div class="similarity-score">${Math.round(user.similarity)}% ìœ ì‚¬</div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="similarity-user"><div class="similarity-info"><div class="similarity-stats">ìœ ì‚¬í•œ ì‚¬ìš©ìë¥¼ ì°¾ëŠ” ì¤‘...</div></div></div>';
    }

    loadGrowthPath() {
      const container = document.getElementById('growthPath');
      const steps = this.recommendations.growth || [];

      const html = steps.map(step => `
        <div class="growth-step">
          <div class="growth-step-number">${step.number}</div>
          <div class="growth-step-title">${step.title}</div>
          <div class="growth-step-description">${step.description}</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${step.number === 1 ? '100%' : '0%'}"></div>
          </div>
        </div>
      `).join('');

      container.innerHTML = html || '<div class="growth-step"><div class="growth-step-description">ì„±ì¥ ê²½ë¡œë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...</div></div>';

      // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜
      setTimeout(() => {
        const progressBars = container.querySelectorAll('.progress-fill');
        progressBars.forEach((bar, index) => {
          if (index < 2) { // ì²˜ìŒ 2ë‹¨ê³„ëŠ” ì§„í–‰ëœ ê²ƒìœ¼ë¡œ í‘œì‹œ
            setTimeout(() => {
              bar.style.width = '100%';
            }, index * 200);
          }
        });
      }, 500);
    }

    updateUserProfile() {
      // í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹œë®¬ë ˆì´ì…˜
      if (typeof showQuickToast === 'function') {
        showQuickToast('ğŸ”„ í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
      }
      
      // ìƒˆë¡œìš´ ë¶„ì„ ì‹¤í–‰
      this.analyzeUserBehavior();
      this.generatePersonalizedRecommendations();
      
      // í˜„ì¬ í™œì„± íƒ­ ìƒˆë¡œê³ ì¹¨
      const activeTab = document.querySelector('.rec-tab-btn.active');
      if (activeTab) {
        const tabName = activeTab.getAttribute('data-tab');
        switch(tabName) {
          case 'insights': this.loadInsights(); break;
          case 'actions': this.loadRecommendedActions(); break;
          case 'similar': this.loadSimilarUsers(); break;
          case 'growth': this.loadGrowthPath(); break;
        }
      }
    }

    // ê²°ê³¼ ê¸°ë¡ ì‹œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ
    recordTestResult(resultKey, score, answers) {
      this.userProfile.testHistory.push({
        result: resultKey,
        score: score,
        answers: answers,
        timestamp: Date.now()
      });

      // ìµœëŒ€ 20ê°œ ê¸°ë¡ë§Œ ìœ ì§€
      if (this.userProfile.testHistory.length > 20) {
        this.userProfile.testHistory = this.userProfile.testHistory.slice(-20);
      }

      localStorage.setItem(this.analysisKey, JSON.stringify(this.userProfile));
    }
  }

  // ê°œì¸í™” ì¶”ì²œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
  window.personalizedRecommendation = new PersonalizedRecommendation();

  // ========== ê³ ê¸‰ ë°ì´í„° ì‹œê°í™”ì™€ ì¸ì‚¬ì´íŠ¸ ì‹œìŠ¤í…œ ==========
  
  class DataVisualization {
    constructor() {
      this.storageKey = 'ageVibeAnalytics';
      this.chartData = {};
      this.insights = [];
      this.init();
    }

    init() {
      this.createVisualizationUI();
      this.bindEvents();
      this.initializeCharts();
    }

    createVisualizationUI() {
      // ë²„íŠ¼ì€ ì´ë¯¸ HTMLì— í†µí•©ë˜ì–´ ìˆìŒ

      // ë°ì´í„° ë¶„ì„ ëª¨ë‹¬ ì°½ ìƒì„±
      if (!document.getElementById('analyticsModal')) {
        const modal = document.createElement('div');
        modal.id = 'analyticsModal';
        modal.className = 'analytics-modal';
        modal.innerHTML = `
          <div class="analytics-content">
            <div class="analytics-header">
              <h2>ğŸ“Š ë°ì´í„° ì¸ì‚¬ì´íŠ¸ ëŒ€ì‹œë³´ë“œ</h2>
              <span class="analytics-close">&times;</span>
            </div>
            
            <div class="analytics-tabs">
              <button class="analytics-tab-btn active" data-tab="overview">ğŸ“ˆ ê°œìš”</button>
              <button class="analytics-tab-btn" data-tab="trends">ğŸ“Š íŠ¸ë Œë“œ</button>
              <button class="analytics-tab-btn" data-tab="patterns">ğŸ” íŒ¨í„´</button>
              <button class="analytics-tab-btn" data-tab="insights">ğŸ’¡ ì¸ì‚¬ì´íŠ¸</button>
              <button class="analytics-tab-btn" data-tab="predictions">ğŸ”® ì˜ˆì¸¡</button>
            </div>
            
            <div class="analytics-body">
              <div id="overviewTab" class="analytics-tab-content active">
                <div class="metrics-grid">
                  <div class="metric-card" id="totalTestsMetric">
                    <div class="metric-icon">ğŸ¯</div>
                    <div class="metric-value">0</div>
                    <div class="metric-label">ì´ í…ŒìŠ¤íŠ¸ ìˆ˜</div>
                    <div class="metric-change">+0%</div>
                  </div>
                  <div class="metric-card" id="avgScoreMetric">
                    <div class="metric-icon">â­</div>
                    <div class="metric-value">0</div>
                    <div class="metric-label">í‰ê·  ì ìˆ˜</div>
                    <div class="metric-change">+0%</div>
                  </div>
                  <div class="metric-card" id="streakMetric">
                    <div class="metric-icon">ğŸ”¥</div>
                    <div class="metric-value">0</div>
                    <div class="metric-label">ì—°ì† ì¼ìˆ˜</div>
                    <div class="metric-change">+0ì¼</div>
                  </div>
                  <div class="metric-card" id="consistencyMetric">
                    <div class="metric-icon">ğŸª</div>
                    <div class="metric-value">0%</div>
                    <div class="metric-label">ì¼ê´€ì„±</div>
                    <div class="metric-change">+0%</div>
                  </div>
                </div>
                <div class="chart-container">
                  <canvas id="overviewChart" width="800" height="400"></canvas>
                </div>
              </div>
              
              <div id="trendsTab" class="analytics-tab-content">
                <div class="trend-analysis">
                  <div class="trend-chart-container">
                    <h3>ğŸ“ˆ ì‹œê°„ë³„ íŒ¨í„´ ë¶„ì„</h3>
                    <canvas id="timePatternChart" width="800" height="300"></canvas>
                  </div>
                  <div class="trend-chart-container">
                    <h3>ğŸ“Š ê²°ê³¼ ë¶„í¬ ë³€í™”</h3>
                    <canvas id="resultTrendChart" width="800" height="300"></canvas>
                  </div>
                </div>
              </div>
              
              <div id="patternsTab" class="analytics-tab-content">
                <div class="pattern-analysis">
                  <div class="pattern-section">
                    <h3>ğŸ§  í–‰ë™ íŒ¨í„´ ë¶„ì„</h3>
                    <canvas id="behaviorChart" width="400" height="400"></canvas>
                  </div>
                  <div class="pattern-section">
                    <h3>âš¡ ë°˜ì‘ ì†ë„ ë¶„ì„</h3>
                    <canvas id="speedChart" width="400" height="400"></canvas>
                  </div>
                </div>
              </div>
              
              <div id="insightsTab" class="analytics-tab-content">
                <div id="dynamicInsights"></div>
              </div>
              
              <div id="predictionsTab" class="analytics-tab-content">
                <div id="predictionResults"></div>
              </div>
            </div>
            
            <div class="analytics-footer">
              <button id="exportDataBtn" class="export-btn">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
              <button id="shareInsightsBtn" class="share-insights-btn">ğŸ”— ì¸ì‚¬ì´íŠ¸ ê³µìœ </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      // ë°ì´í„° ì‹œê°í™” ìŠ¤íƒ€ì¼ ì¶”ê°€
      if (!document.getElementById('analytics-styles')) {
        const style = document.createElement('style');
        style.id = 'analytics-styles';
        style.textContent = `
          .analytics-modal {
            display: none;
            position: fixed;
            z-index: 10002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
          }

          .analytics-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 1% auto;
            padding: 0;
            border-radius: 30px;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 30px 100px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease;
            border: 1px solid rgba(255,255,255,0.1);
          }

          .analytics-header {
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 30px 30px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
          }

          .analytics-header h2 {
            color: #4fc3f7;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 15px rgba(79, 195, 247, 0.3);
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
          }

          .analytics-close {
            color: #4fc3f7;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
            background: rgba(79, 195, 247, 0.1);
          }

          .analytics-close:hover {
            background: rgba(79, 195, 247, 0.2);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.3);
          }

          .analytics-tabs {
            display: flex;
            padding: 0 25px;
            background: rgba(255,255,255,0.05);
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(255,255,255,0.1);
          }

          .analytics-tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 18px 12px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin: 0 2px;
            position: relative;
          }

          .analytics-tab-btn.active,
          .analytics-tab-btn:hover {
            color: #4fc3f7;
            border-bottom-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.1);
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.2);
          }

          .analytics-body {
            padding: 30px;
            min-height: 500px;
            background: rgba(255,255,255,0.02);
          }

          .analytics-tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
          }

          .analytics-tab-content.active {
            display: block;
          }

          .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
          }

          .metric-card {
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1) 0%, rgba(41, 182, 246, 0.05) 100%);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(79, 195, 247, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
          }

          .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 195, 247, 0.1), transparent);
            transition: left 0.5s ease;
          }

          .metric-card:hover::before {
            left: 100%;
          }

          .metric-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(79, 195, 247, 0.2);
            border-color: rgba(79, 195, 247, 0.4);
          }

          .metric-icon {
            font-size: 36px;
            margin-bottom: 15px;
            filter: drop-shadow(0 0 10px rgba(79, 195, 247, 0.3));
          }

          .metric-value {
            font-size: 32px;
            font-weight: 800;
            color: #4fc3f7;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
          }

          .metric-label {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 8px;
            font-weight: 600;
          }

          .metric-change {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            color: white;
            display: inline-block;
          }

          .metric-change.negative {
            background: linear-gradient(90deg, #f44336, #ef5350);
          }

          .chart-container {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
          }

          .trend-analysis {
            display: flex;
            flex-direction: column;
            gap: 30px;
          }

          .trend-chart-container {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
          }

          .trend-chart-container h3 {
            color: #4fc3f7;
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
          }

          .pattern-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
          }

          .pattern-section {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            text-align: center;
          }

          .pattern-section h3 {
            color: #4fc3f7;
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 700;
          }

          .insight-item {
            background: linear-gradient(135deg, rgba(79, 195, 247, 0.1) 0%, rgba(41, 182, 246, 0.05) 100%);
            margin: 15px 0;
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
          }

          .insight-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(79, 195, 247, 0.2);
            border-color: rgba(79, 195, 247, 0.4);
          }

          .insight-title {
            font-size: 20px;
            font-weight: 700;
            color: #4fc3f7;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
          }

          .insight-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.7;
            font-size: 15px;
            margin-bottom: 15px;
          }

          .insight-confidence {
            display: inline-block;
            background: linear-gradient(90deg, #4fc3f7, #29b6f6);
            color: #0d1421;
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
          }

          .prediction-card {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(123, 31, 162, 0.05) 100%);
            margin: 15px 0;
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(156, 39, 176, 0.3);
            backdrop-filter: blur(10px);
          }

          .prediction-title {
            font-size: 20px;
            font-weight: 700;
            color: #ba68c8;
            margin-bottom: 12px;
          }

          .prediction-description {
            color: rgba(255,255,255,0.9);
            line-height: 1.7;
            margin-bottom: 15px;
          }

          .prediction-probability {
            display: inline-block;
            background: linear-gradient(90deg, #9c27b0, #7b1fa2);
            color: white;
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
          }

          .analytics-footer {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 0 0 30px 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            border-top: 1px solid rgba(255,255,255,0.1);
          }

          .export-btn,
          .share-insights-btn {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            color: #0d1421;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(79, 195, 247, 0.3);
          }

          .share-insights-btn {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2);
            color: white;
            box-shadow: 0 4px 20px rgba(156, 39, 176, 0.3);
          }

          .export-btn:hover,
          .share-insights-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 30px rgba(79, 195, 247, 0.4);
          }

          .share-insights-btn:hover {
            box-shadow: 0 8px 30px rgba(156, 39, 176, 0.4);
          }

          @media (max-width: 768px) {
            .analytics-content {
              margin: 0;
              width: 100%;
              max-height: 100vh;
              border-radius: 0;
            }
            
            .metrics-grid {
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .pattern-analysis {
              grid-template-columns: 1fr;
            }
            
            .analytics-tab-btn {
              min-width: 90px;
              font-size: 12px;
            }
            
            .analytics-footer {
              flex-direction: column;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }

    bindEvents() {
      // ë¶„ì„ ë²„íŠ¼ ì´ë²¤íŠ¸
      const analyticsBtn = document.getElementById('analyticsBtn');
      if (analyticsBtn && !analyticsBtn.hasAttribute('data-bound')) {
        analyticsBtn.setAttribute('data-bound', 'true');
        analyticsBtn.addEventListener('click', () => {
          this.showAnalytics();
          if (typeof playSound === 'function') playSound('success');
        });
      }

      // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
      const modal = document.getElementById('analyticsModal');
      if (modal) {
        const closeBtn = modal.querySelector('.analytics-close');
        if (closeBtn && !closeBtn.hasAttribute('data-bound')) {
          closeBtn.setAttribute('data-bound', 'true');
          closeBtn.addEventListener('click', () => {
            this.hideAnalytics();
          });
        }

        if (!modal.hasAttribute('data-bound')) {
          modal.setAttribute('data-bound', 'true');
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              this.hideAnalytics();
            }
          });
        }

        // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
        const tabBtns = modal.querySelectorAll('.analytics-tab-btn');
        tabBtns.forEach(btn => {
          if (!btn.hasAttribute('data-bound')) {
            btn.setAttribute('data-bound', 'true');
            btn.addEventListener('click', () => {
              const tab = btn.getAttribute('data-tab');
              this.switchAnalyticsTab(tab);
              if (typeof playSound === 'function') playSound('click');
            });
          }
        });

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
        const exportBtn = modal.querySelector('#exportDataBtn');
        if (exportBtn && !exportBtn.hasAttribute('data-bound')) {
          exportBtn.setAttribute('data-bound', 'true');
          exportBtn.addEventListener('click', () => {
            this.exportData();
            if (typeof playSound === 'function') playSound('success');
          });
        }

        // ì¸ì‚¬ì´íŠ¸ ê³µìœ  ë²„íŠ¼
        const shareBtn = modal.querySelector('#shareInsightsBtn');
        if (shareBtn && !shareBtn.hasAttribute('data-bound')) {
          shareBtn.setAttribute('data-bound', 'true');
          shareBtn.addEventListener('click', () => {
            this.shareInsights();
            if (typeof playSound === 'function') playSound('success');
          });
        }
      }
    }

    showAnalytics() {
      const modal = document.getElementById('analyticsModal');
      modal.style.display = 'block';
      
      // ë°ì´í„° ìˆ˜ì§‘ ë° ë¶„ì„
      this.collectData();
      this.generateInsights();
      
      // ê° íƒ­ ë‚´ìš© ë¡œë“œ
      this.loadOverview();
      this.loadTrends();
      this.loadPatterns();
      this.loadInsights();
      this.loadPredictions();
    }

    hideAnalytics() {
      const modal = document.getElementById('analyticsModal');
      modal.style.display = 'none';
    }

    switchAnalyticsTab(tabName) {
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      const tabBtns = document.querySelectorAll('.analytics-tab-btn');
      tabBtns.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });

      // íƒ­ ë‚´ìš© í‘œì‹œ
      const tabContents = document.querySelectorAll('.analytics-tab-content');
      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === tabName + 'Tab');
      });

      // íƒ­ë³„ ì°¨íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      setTimeout(() => {
        switch(tabName) {
          case 'overview': this.drawOverviewChart(); break;
          case 'trends': this.drawTrendCharts(); break;
          case 'patterns': this.drawPatternCharts(); break;
        }
      }, 100);
    }

    collectData() {
      const stats = typeof getStats === 'function' ? getStats() : {};
      const userProfile = window.personalizedRecommendation ? 
        window.personalizedRecommendation.userProfile : {};
      const emotionData = emotionAnalyzer || {};

      this.chartData = {
        basic: {
          totalTests: stats.totalTests || 0,
          avgScore: stats.averageScore || 0,
          streak: stats.streak || 0,
          resultCounts: stats.resultCounts || {}
        },
        behavior: {
          clickTiming: emotionData.clickTiming || [],
          hoverPatterns: emotionData.hoverPatterns || [],
          decisionSpeed: userProfile.personality?.decisionSpeed || 'moderate'
        },
        time: {
          favoriteTimes: userProfile.interactions?.favoriteTimes || [],
          deviceUsage: userProfile.interactions?.deviceUsage || {}
        },
        history: userProfile.testHistory || []
      };
    }

    generateInsights() {
      const data = this.chartData;
      this.insights = [];

      // í…ŒìŠ¤íŠ¸ ë¹ˆë„ ì¸ì‚¬ì´íŠ¸
      if (data.basic.totalTests > 5) {
        this.insights.push({
          title: 'ğŸ† í™œë°œí•œ í…ŒìŠ¤í„°',
          description: `ì´ ${data.basic.totalTests}íšŒì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì§€ì†ì ì¸ ìê¸° íƒêµ¬ ë…¸ë ¥ì´ ì¸ìƒì ì´ì—ìš”!`,
          confidence: 'ë†’ìŒ'
        });
      }

      // ì ìˆ˜ íŠ¸ë Œë“œ ì¸ì‚¬ì´íŠ¸
      if (data.basic.avgScore > 75) {
        this.insights.push({
          title: 'â­ ë†’ì€ ê°ì„± ì§€ìˆ˜',
          description: `í‰ê·  ${data.basic.avgScore}ì ìœ¼ë¡œ ë§¤ìš° ë†’ì€ ê°ì„± ì§€ìˆ˜ë¥¼ ë³´ì…ë‹ˆë‹¤. ê°ì • ì¸ì‹ê³¼ í‘œí˜„ ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ë„¤ìš”.`,
          confidence: 'ë§¤ìš° ë†’ìŒ'
        });
      }

      // ì¼ê´€ì„± ì¸ì‚¬ì´íŠ¸
      const consistency = this.calculateConsistency(data.basic.resultCounts);
      if (consistency > 60) {
        this.insights.push({
          title: 'ğŸ¯ ì¼ê´€ëœ ì„±í–¥',
          description: `${consistency}%ì˜ ì¼ê´€ì„±ì„ ë³´ì…ë‹ˆë‹¤. ìì‹ ì˜ ì •ì²´ì„±ì´ ëª…í™•í•˜ê³  ì•ˆì •ì ì¸ ì„±ê²©ì´ì—ìš”.`,
          confidence: 'ë†’ìŒ'
        });
      }

      // í–‰ë™ íŒ¨í„´ ì¸ì‚¬ì´íŠ¸
      if (data.behavior.clickTiming.length > 0) {
        const avgTime = data.behavior.clickTiming.reduce((a, b) => a + b) / data.behavior.clickTiming.length;
        if (avgTime < 2000) {
          this.insights.push({
            title: 'âš¡ ë¹ ë¥¸ ì˜ì‚¬ê²°ì •ì',
            description: `í‰ê·  ${(avgTime / 1000).toFixed(1)}ì´ˆì˜ ë¹ ë¥¸ ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤. ì§ê°ì ì´ê³  í–‰ë™ ì§€í–¥ì ì¸ ì„±í–¥ì„ ë³´ì—¬ìš”.`,
            confidence: 'ë†’ìŒ'
          });
        } else if (avgTime > 8000) {
          this.insights.push({
            title: 'ğŸ¤” ì‹ ì¤‘í•œ ë¶„ì„ê°€',
            description: `í‰ê·  ${(avgTime / 1000).toFixed(1)}ì´ˆì˜ ì¶©ë¶„í•œ ê³ ë¯¼ ì‹œê°„ì„ ê°€ì§‘ë‹ˆë‹¤. ì‹ ì¤‘í•˜ê³  ë¶„ì„ì ì¸ ì‚¬ê³ ë°©ì‹ì„ ê°€ì§€ê³  ìˆì–´ìš”.`,
            confidence: 'ë†’ìŒ'
          });
        }
      }

      // ì‹œê°„ëŒ€ íŒ¨í„´ ì¸ì‚¬ì´íŠ¸
      if (data.time.favoriteTimes.length > 3) {
        const hourCounts = {};
        data.time.favoriteTimes.forEach(hour => {
          hourCounts[hour] = (hourCounts[hour] || 0) + 1;
        });
        const favoriteHour = Object.keys(hourCounts).reduce((a, b) => 
          hourCounts[a] > hourCounts[b] ? a : b
        );
        
        let timeDescription;
        if (favoriteHour >= 6 && favoriteHour < 12) {
          timeDescription = 'ì•„ì¹¨í˜• ì¸ê°„ìœ¼ë¡œ í™œê¸°ì°¬ ì‹œì‘ì„ ì„ í˜¸í•©ë‹ˆë‹¤.';
        } else if (favoriteHour >= 12 && favoriteHour < 18) {
          timeDescription = 'ì˜¤í›„ì— ê°€ì¥ í™œë°œí•œ í™œë™ì„ ë³´ì…ë‹ˆë‹¤.';
        } else if (favoriteHour >= 18 && favoriteHour < 22) {
          timeDescription = 'ì €ë… ì‹œê°„ì„ í™œìš©í•œ ìê¸°ê³„ë°œì„ ì„ í˜¸í•©ë‹ˆë‹¤.';
        } else {
          timeDescription = 'ì•¼ê°„ í™œë™ì„ ì¦ê¸°ëŠ” ì˜¬ë¹¼ë¯¸ íƒ€ì…ì…ë‹ˆë‹¤.';
        }
        
        this.insights.push({
          title: 'â° ì‹œê°„ëŒ€ ì„ í˜¸ íŒ¨í„´',
          description: `ì£¼ë¡œ ${favoriteHour}ì‹œê²½ì— í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤. ${timeDescription}`,
          confidence: 'ë³´í†µ'
        });
      }
    }

    calculateConsistency(resultCounts) {
      if (!resultCounts || Object.keys(resultCounts).length === 0) return 0;
      
      const total = Object.values(resultCounts).reduce((a, b) => a + b, 0);
      if (total === 0) return 0;
      
      const maxCount = Math.max(...Object.values(resultCounts));
      return Math.round((maxCount / total) * 100);
    }

    loadOverview() {
      // ë©”íŠ¸ë¦­ ì¹´ë“œ ì—…ë°ì´íŠ¸
      const data = this.chartData;
      const consistency = this.calculateConsistency(data.basic.resultCounts);
      
      document.querySelector('#totalTestsMetric .metric-value').textContent = data.basic.totalTests;
      document.querySelector('#avgScoreMetric .metric-value').textContent = data.basic.avgScore;
      document.querySelector('#streakMetric .metric-value').textContent = data.basic.streak;
      document.querySelector('#consistencyMetric .metric-value').textContent = consistency + '%';
      
      // ë³€í™”ìœ¨ ê³„ì‚° (ì‹œë®¬ë ˆì´ì…˜)
      const changes = ['+12%', '+8%', '+3ì¼', '+5%'];
      document.querySelectorAll('.metric-change').forEach((el, index) => {
        el.textContent = changes[index] || '+0%';
      });
      
      // ê°œìš” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
      setTimeout(() => this.drawOverviewChart(), 100);
    }

    loadTrends() {
      setTimeout(() => this.drawTrendCharts(), 100);
    }

    loadPatterns() {
      setTimeout(() => this.drawPatternCharts(), 100);
    }

    loadInsights() {
      const container = document.getElementById('dynamicInsights');
      const html = this.insights.map(insight => `
        <div class="insight-item">
          <div class="insight-title">${insight.title}</div>
          <div class="insight-description">${insight.description}</div>
          <div class="insight-confidence">ì‹ ë¢°ë„: ${insight.confidence}</div>
        </div>
      `).join('');
      
      container.innerHTML = html || '<div class="insight-item"><div class="insight-description">ë” ë§ì€ ë°ì´í„°ë¡œ ìƒì„¸í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•  ì˜ˆì •ì…ë‹ˆë‹¤!</div></div>';
    }

    loadPredictions() {
      const container = document.getElementById('predictionResults');
      const predictions = this.generatePredictions();
      
      const html = predictions.map(pred => `
        <div class="prediction-card">
          <div class="prediction-title">${pred.title}</div>
          <div class="prediction-description">${pred.description}</div>
          <div class="prediction-probability">ì˜ˆì¸¡ í™•ë¥ : ${pred.probability}%</div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    generatePredictions() {
      const data = this.chartData;
      const predictions = [];
      
      // ë‹¤ìŒ ê²°ê³¼ ì˜ˆì¸¡
      if (data.basic.totalTests > 2) {
        const mostCommon = Object.keys(data.basic.resultCounts).reduce((a, b) => 
          data.basic.resultCounts[a] > data.basic.resultCounts[b] ? a : b
        );
        
        predictions.push({
          title: 'ğŸ”® ë‹¤ìŒ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì˜ˆì¸¡',
          description: `ê³¼ê±° íŒ¨í„´ì„ ë¶„ì„í•œ ê²°ê³¼, ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì—ì„œë„ "${mostCommon}" ê²°ê³¼ê°€ ë‚˜ì˜¬ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.`,
          probability: 68
        });
      }
      
      // ì„±ì¥ ê°€ëŠ¥ì„± ì˜ˆì¸¡
      if (data.basic.avgScore > 60) {
        predictions.push({
          title: 'ğŸ“ˆ ê°ì„± ì§€ìˆ˜ ì„±ì¥ ì˜ˆì¸¡',
          description: 'í˜„ì¬ì˜ í•™ìŠµ íŒ¨í„´ì„ ìœ ì§€í•œë‹¤ë©´, 3ê°œì›” ë‚´ì— ê°ì„± ì§€ìˆ˜ê°€ 10-15ì  í–¥ìƒë  ê²ƒìœ¼ë¡œ ì˜ˆì¸¡ë©ë‹ˆë‹¤.',
          probability: 75
        });
      }
      
      // ì¼ê´€ì„± ë³€í™” ì˜ˆì¸¡
      const consistency = this.calculateConsistency(data.basic.resultCounts);
      if (consistency > 50) {
        predictions.push({
          title: 'ğŸ¯ ì„±í–¥ ì•ˆì •í™” ì˜ˆì¸¡',
          description: 'ë†’ì€ ì¼ê´€ì„±ì„ ë³´ì´ê³  ìˆì–´, ì•ìœ¼ë¡œë„ ì•ˆì •ì ì¸ ì„±í–¥ì„ ìœ ì§€í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.',
          probability: 82
        });
      }
      
      return predictions;
    }

    drawOverviewChart() {
      const canvas = document.getElementById('overviewChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const data = this.chartData.basic.resultCounts;
      
      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (Object.keys(data).length === 0) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // ë„ë„› ì°¨íŠ¸ ê·¸ë¦¬ê¸°
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 50;
      const innerRadius = radius * 0.6;
      
      const colors = ['#4fc3f7', '#29b6f6', '#0288d1', '#0277bd'];
      const labels = {
        teen: '10ëŒ€ ê°ì„±',
        twenties: '20ëŒ€ ê°ì„±', 
        thirties: '30ëŒ€ ê°ì„±',
        forties: '40ëŒ€ ê°ì„±'
      };
      
      let total = Object.values(data).reduce((a, b) => a + b, 0);
      let currentAngle = -Math.PI / 2;
      
      Object.entries(data).forEach(([key, value], index) => {
        const sliceAngle = (value / total) * 2 * Math.PI;
        
        // ì™¸ë¶€ ì›í˜¸
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
        ctx.closePath();
        
        const gradient = ctx.createRadialGradient(centerX, centerY, innerRadius, centerX, centerY, radius);
        gradient.addColorStop(0, colors[index % colors.length] + '80');
        gradient.addColorStop(1, colors[index % colors.length]);
        
        ctx.fillStyle = gradient;
        ctx.fill();
        
        // ë¼ë²¨
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius + 30);
        const labelY = centerY + Math.sin(labelAngle) * (radius + 30);
        
        ctx.fillStyle = '#4fc3f7';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(labels[key] || key, labelX, labelY);
        ctx.fillText(`${value}íšŒ`, labelX, labelY + 15);
        
        currentAngle += sliceAngle;
      });
      
      // ì¤‘ì•™ í…ìŠ¤íŠ¸
      ctx.fillStyle = '#4fc3f7';
      ctx.font = 'bold 24px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('ì´ í…ŒìŠ¤íŠ¸', centerX, centerY - 10);
      ctx.fillText(`${total}íšŒ`, centerX, centerY + 20);
    }

    drawTrendCharts() {
      this.drawTimePatternChart();
      this.drawResultTrendChart();
    }

    drawTimePatternChart() {
      const canvas = document.getElementById('timePatternChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const times = this.chartData.time.favoriteTimes;
      if (times.length === 0) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ì‹œê°„ëŒ€ë³„ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // ì‹œê°„ëŒ€ë³„ ë¹ˆë„ ê³„ì‚°
      const hourCounts = Array(24).fill(0);
      times.forEach(hour => {
        hourCounts[hour]++;
      });
      
      const maxCount = Math.max(...hourCounts);
      const barWidth = canvas.width / 24;
      const maxHeight = canvas.height - 60;
      
      // ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
      hourCounts.forEach((count, hour) => {
        const barHeight = (count / maxCount) * maxHeight;
        const x = hour * barWidth;
        const y = canvas.height - barHeight - 30;
        
        const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
        gradient.addColorStop(0, '#4fc3f7');
        gradient.addColorStop(1, '#29b6f6');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth - 2, barHeight);
        
        // ì‹œê°„ ë¼ë²¨
        if (hour % 4 === 0) {
          ctx.fillStyle = '#4fc3f7';
          ctx.font = '12px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(`${hour}ì‹œ`, x + barWidth/2, canvas.height - 5);
        }
      });
    }

    drawResultTrendChart() {
      const canvas = document.getElementById('resultTrendChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const history = this.chartData.history;
      if (history.length < 2) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('íŠ¸ë Œë“œ ë¶„ì„ì„ ìœ„í•´ ë” ë§ì€ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // ì ìˆ˜ ë³€í™” ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
      const maxScore = 100;
      const stepX = canvas.width / (history.length - 1);
      const stepY = (canvas.height - 60) / maxScore;
      
      ctx.strokeStyle = '#4fc3f7';
      ctx.lineWidth = 3;
      ctx.beginPath();
      
      history.forEach((test, index) => {
        const x = index * stepX;
        const y = canvas.height - 30 - (test.score * stepY);
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        // ì  ê·¸ë¦¬ê¸°
        ctx.save();
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, 2 * Math.PI);
        ctx.fillStyle = '#29b6f6';
        ctx.fill();
        ctx.restore();
      });
      
      ctx.stroke();
    }

    drawPatternCharts() {
      this.drawBehaviorChart();
      this.drawSpeedChart();
    }

    drawBehaviorChart() {
      const canvas = document.getElementById('behaviorChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // í–‰ë™ íŒ¨í„´ ë ˆì´ë” ì°¨íŠ¸
      const behaviors = {
        'ì§ê´€ì ': Math.random() * 100,
        'ë¶„ì„ì ': Math.random() * 100,
        'ì‹ ì¤‘í•¨': Math.random() * 100,
        'ëª¨í—˜ì ': Math.random() * 100,
        'ì•ˆì •ì ': Math.random() * 100
      };
      
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 50;
      const angleStep = (2 * Math.PI) / Object.keys(behaviors).length;
      
      // ê²©ì ê·¸ë¦¬ê¸°
      for (let i = 1; i <= 5; i++) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, (radius * i) / 5, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(79, 195, 247, 0.2)';
        ctx.stroke();
      }
      
      // ì¶• ê·¸ë¦¬ê¸°
      Object.keys(behaviors).forEach((label, index) => {
        const angle = index * angleStep - Math.PI / 2;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = 'rgba(79, 195, 247, 0.3)';
        ctx.stroke();
        
        // ë¼ë²¨
        const labelX = centerX + Math.cos(angle) * (radius + 20);
        const labelY = centerY + Math.sin(angle) * (radius + 20);
        ctx.fillStyle = '#4fc3f7';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label, labelX, labelY);
      });
      
      // ë°ì´í„° ì˜ì—­ ê·¸ë¦¬ê¸°
      ctx.beginPath();
      Object.values(behaviors).forEach((value, index) => {
        const angle = index * angleStep - Math.PI / 2;
        const distance = (value / 100) * radius;
        const x = centerX + Math.cos(angle) * distance;
        const y = centerY + Math.sin(angle) * distance;
        
        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.closePath();
      
      ctx.fillStyle = 'rgba(79, 195, 247, 0.2)';
      ctx.fill();
      ctx.strokeStyle = '#4fc3f7';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    drawSpeedChart() {
      const canvas = document.getElementById('speedChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const timings = this.chartData.behavior.clickTiming;
      if (timings.length === 0) {
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ë°˜ì‘ ì†ë„ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤...', canvas.width/2, canvas.height/2);
        return;
      }
      
      // íˆìŠ¤í† ê·¸ë¨ ê·¸ë¦¬ê¸°
      const buckets = [0, 2000, 5000, 8000, 15000]; // ms ë‹¨ìœ„
      const bucketCounts = Array(buckets.length - 1).fill(0);
      
      timings.forEach(timing => {
        for (let i = 0; i < buckets.length - 1; i++) {
          if (timing >= buckets[i] && timing < buckets[i + 1]) {
            bucketCounts[i]++;
            break;
          }
        }
      });
      
      const maxCount = Math.max(...bucketCounts);
      const barWidth = canvas.width / bucketCounts.length;
      const maxHeight = canvas.height - 60;
      
      bucketCounts.forEach((count, index) => {
        const barHeight = (count / maxCount) * maxHeight;
        const x = index * barWidth;
        const y = canvas.height - barHeight - 30;
        
        const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
        gradient.addColorStop(0, '#9c27b0');
        gradient.addColorStop(1, '#7b1fa2');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x + 10, y, barWidth - 20, barHeight);
        
        // ë¼ë²¨
        ctx.fillStyle = '#ba68c8';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        const label = `${buckets[index]/1000}s`;
        ctx.fillText(label, x + barWidth/2, canvas.height - 5);
      });
    }

    exportData() {
      const data = {
        timestamp: new Date().toISOString(),
        basic: this.chartData.basic,
        insights: this.insights,
        predictions: this.generatePredictions()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'age-vibe-analytics.json';
      a.click();
      URL.revokeObjectURL(url);
      
      if (typeof showQuickToast === 'function') {
        showQuickToast('ğŸ“Š ë¶„ì„ ë°ì´í„°ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
      }
    }

    shareInsights() {
      const bestInsight = this.insights[0];
      if (!bestInsight) {
        if (typeof showQuickToast === 'function') {
          showQuickToast('ğŸ“Š ê³µìœ í•  ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...');
        }
        return;
      }
      
      const shareText = `ğŸ§  ë‚˜ì˜ ê°ì„± ì—°ë ¹ ì¸ì‚¬ì´íŠ¸: ${bestInsight.title}\n${bestInsight.description}\n\n#ê°ì„±ì—°ë ¹ #ë°ì´í„°ë¶„ì„ #ìê¸°ê³„ë°œ`;
      
      if (navigator.share) {
        navigator.share({
          title: 'ê°ì„± ì—°ë ¹ ì¸ì‚¬ì´íŠ¸',
          text: shareText
        });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(shareText).then(() => {
          if (typeof showQuickToast === 'function') {
            showQuickToast('ğŸ“‹ ì¸ì‚¬ì´íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
          }
        });
      }
    }

    initializeCharts() {
      // ì´ˆê¸° ì°¨íŠ¸ ì„¤ì • (í•„ìš”ì‹œ)
    }
  }

  // ë°ì´í„° ì‹œê°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
  window.dataVisualization = new DataVisualization();

  // ========== í†µí•© UI ë ˆì´ì•„ì›ƒ ê´€ë¦¬ ì‹œìŠ¤í…œ ==========
  
  class UILayoutManager {
    constructor() {
      this.init();
    }

    init() {
      this.setupFeatureToggle();
      this.handleResponsiveLayout();
    }

    setupFeatureToggle() {
      // ê³ ê¸‰ ê¸°ëŠ¥ ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
      const showFeaturesBtn = document.querySelector('#showFeatures .toggle-btn');
      const hideFeaturesBtn = document.querySelector('#toggleFeatures .toggle-btn');
      const advancedFeatures = document.getElementById('advancedFeatures');
      const showFeatures = document.getElementById('showFeatures');

      if (showFeaturesBtn && hideFeaturesBtn) {
        showFeaturesBtn.addEventListener('click', () => {
          advancedFeatures.style.display = 'block';
          showFeatures.style.display = 'none';
          if (typeof playSound === 'function') playSound('whoosh');
        });

        hideFeaturesBtn.addEventListener('click', () => {
          advancedFeatures.style.display = 'none';
          showFeatures.style.display = 'block';
          if (typeof playSound === 'function') playSound('click');
        });
      }

      // í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ê³ ê¸‰ ê¸°ëŠ¥ ìë™ í‘œì‹œ
      const originalShowResult = window.showResult;
      if (originalShowResult) {
        window.showResult = function() {
          const result = originalShowResult.apply(this, arguments);
          
          // 1ì´ˆ í›„ ê³ ê¸‰ ê¸°ëŠ¥ í‘œì‹œ
          setTimeout(() => {
            if (showFeatures.style.display !== 'none') {
              showFeaturesBtn.click();
              showQuickToast('âœ¨ ìƒˆë¡œìš´ ê³ ê¸‰ ê¸°ëŠ¥ì„ í™•ì¸í•´ë³´ì„¸ìš”!');
            }
          }, 1000);
          
          return result;
        };
      }
    }

    handleResponsiveLayout() {
      // ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ ì²˜ë¦¬
      const handleResize = () => {
        const width = window.innerWidth;
        const featureGrid = document.querySelector('.feature-grid');
        
        if (width < 768 && featureGrid) {
          featureGrid.style.gridTemplateColumns = '1fr';
        } else if (width < 1024 && featureGrid) {
          featureGrid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        }
      };

      window.addEventListener('resize', handleResize);
      handleResize(); // ì´ˆê¸° ì‹¤í–‰
    }

    // ê¸°ëŠ¥ë³„ ì‚¬ìš© í†µê³„ ì¶”ì 
    trackFeatureUsage(feature) {
      const stats = JSON.parse(localStorage.getItem('featureUsageStats') || '{}');
      stats[feature] = (stats[feature] || 0) + 1;
      localStorage.setItem('featureUsageStats', JSON.stringify(stats));
      
      // ì‚¬ìš© ë¹ˆë„ì— ë”°ë¥¸ ë ˆì´ì•„ì›ƒ ìµœì í™”
      this.optimizeLayout(stats);
    }

    optimizeLayout(stats) {
      // ìì£¼ ì‚¬ìš©ë˜ëŠ” ê¸°ëŠ¥ì„ ì•ì— ë°°ì¹˜ (ì¶”í›„ êµ¬í˜„)
      const mostUsed = Object.entries(stats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3);
      
      // í–¥í›„ ë™ì  ë ˆì´ì•„ì›ƒ ì¬ë°°ì¹˜ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
    }

    // ì ‘ê·¼ì„± ê°œì„ 
    enhanceAccessibility() {
      // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ ì§€ì›
      const featureBtns = document.querySelectorAll('.feature-btn');
      featureBtns.forEach((btn, index) => {
        btn.setAttribute('tabindex', '0');
        btn.setAttribute('role', 'button');
        
        btn.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            btn.click();
          }
        });
      });
    }
  }

  // UI ë ˆì´ì•„ì›ƒ ê´€ë¦¬ì ì´ˆê¸°í™”
  window.uiLayoutManager = new UILayoutManager();

  // ê¸°ì¡´ showResult í•¨ìˆ˜ë¥¼ ë˜í•‘í•˜ì—¬ ë­í‚¹ ê¸°ë¡ ì¶”ê°€
  if (typeof showResult !== 'undefined') {
    const originalShowResult = showResult;
    showResult = function() {
      const result = originalShowResult.apply(this, arguments);
      
      // ê²°ê³¼ê°€ í‘œì‹œëœ í›„ ë­í‚¹ì— ê¸°ë¡
      setTimeout(() => {
        if (typeof resultKey !== 'undefined' && typeof score !== 'undefined') {
          const currentResult = RESULTS.find(r => r.key === resultKey);
          if (currentResult) {
            // ì‚¬ìš©ì ì´ë¦„ ì…ë ¥ (ì„ íƒì‚¬í•­)
            const userName = localStorage.getItem('ageVibeUserName') || null;
            window.socialRanking.recordResult(userName, score, currentResult.title);
          }
        }
      }, 1000);
      
      return result;
    };
  }

  // ê³µìœ ìš© URL íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì„ íƒ)
  (function preloadFromQuery(){
    const p = new URLSearchParams(location.search);
    const key = p.get('result');
    const sc  = parseInt(p.get('score'), 10);
    if(!key || isNaN(sc)) return;
    const res = RESULTS.find(r=>r.key===key);
    if(!res) return;
    document.querySelector('.hero').classList.add('hidden');
    quizEl.classList.add('hidden');
    // í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
    document.getElementById('resTitle').textContent = res.title;
    document.getElementById('resSub').textContent = res.sub;
    document.getElementById('scoreBox').textContent = `${clamp(sc,0,100)} / 100`;
    document.getElementById('resDesc').textContent = res.desc;
    setupShare(location.href, res.title);
    drawCard(res, clamp(sc,0,100));
    resultEl.classList.remove('hidden');
    resetBtn.classList.remove('hidden');
  })();
</script>
</body>
</html>
